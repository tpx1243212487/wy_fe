### vue、spring boot前后端分离项目实战----小区物业管理系统



#### 第1讲 vue-admin-template下载

效果展示

![](D:\项目实战\物业管理系统\资料\images\1-1.png)



###### 1、vue-admin-template下载

```js
在线演示地址
https://panjiachen.github.io/vue-admin-template/#/login?redirect=%2Fdashboard

下载地址
https://gitee.com/panjiachen/vue-admin-template/blob/master/README-zh.md
```

###### 2、运行项目

```js
1.安装依赖   npm install 
2.运行项目   npm run dev
```

3、运行项目报错解决

```js
1. error  Multiple spaces found before '//需要添加该项，否则上级不...'  no-multi-spaces错误
 找到项目的.eslintrc.js配置文件把rules:中的   'no-multi-spaces': 'off'   //关闭空格的检查

2. error    Trailing spaces not allowed                          no-trailing-spaces错误
找到项目的.eslintrc.js配置文件在rules:中添加   'no-trailing-spaces': 'error', // 行末不要空格
```





#### 第2讲  修改应用的配置信息

效果展示

![](D:\项目实战\物业管理系统\资料\images\2-1.png)

###### 1、修改应用的名称

找到src目录下的settings.js配置文件，修改为如下所示

```js
module.exports = {

  title: '小区物业管理系统',

  /**
   * @type {boolean} true | false
   * @description Whether fix the header
   */
  fixedHeader: true,   //固定头部

  /**
   * @type {boolean} true | false
   * @description Whether show the logo in sidebar
   */
  sidebarLogo: true  //显示图标
}

```

###### 2、修改右侧的下拉菜单

找到src/layout/components下的Navbar.vue文件，把el-dropdown-menu修改为如下所示代码

```js
<el-dropdown-menu  slot="dropdown" class="user-dropdown">
          <el-dropdown-item divided>
            <span style="display:block;">重置密码</span>
          </el-dropdown-item>
          <el-dropdown-item divided @click.native="logout">
            <span style="display:block;">退出登录</span>
          </el-dropdown-item>
</el-dropdown-menu>
```

###### 3、配置项目路由

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'

/**
 * Note: sub-menu only appear when route children.length >= 1
 * Detail see: https://panjiachen.github.io/vue-element-admin-site/guide/essentials/router-and-nav.html
 *
 * hidden: true                   if set true, item will not show in the sidebar(default is false)
 * alwaysShow: true               if set true, will always show the root menu
 *                                if not set alwaysShow, when item has more than one children route,
 *                                it will becomes nested mode, otherwise not show the root menu
 * redirect: noRedirect           if set noRedirect will no redirect in the breadcrumb
 * name:'router-name'             the name is used by <keep-alive> (must set!!!)
 * meta : {
    roles: ['admin','editor']    control the page roles (you can set multiple roles)
    title: 'title'               the name show in sidebar and breadcrumb (recommend set)
    icon: 'svg-name'/'el-icon-x' the icon show in the sidebar
    breadcrumb: false            if set false, the item will hidden in breadcrumb(default is true)
    activeMenu: '/example/list'  if set path, the sidebar will highlight the path you set
  }
 */

/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  },
  {
    path: '/system',
    component: Layout,
    alwaysShow: true,
    name: 'system',
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '员工管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '权限管理', icon: 'tree' }
      }
    ]
  },
  {
    path: '/sysHouse',
    component: Layout,
    name: 'sysHouse',
    meta: { title: '房屋管理', icon: 'el-icon-s-help' },
    alwaysShow: true,  //需要添加该项，否则上级不会展示
    children: [
      {
        path: '/sysHouseList',
        name: 'sysHouseList',
        component: () => import('@/views/house/sysHouseList'),
        meta: { title: '房屋列表', icon: 'table' }
      }
    ]
  },
  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router

```

###### 4、新建上面路由中对应的组件页面

- **在src/views下新建system目录**

1.新建sysMenuList.vue组件

```js
<template>
    <div>
菜单管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

2.新建sysRoleList.vue组件

```js
<template>
    <div>
角色管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

3.新建sysUserList.vue组件

```js
<template>
    <div>
        用户管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

- **在src/views下新建house目录**

新建sysHouseList.vue组件

```js
<template>
    <div>
        房屋列表
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

###### 5、菜单改为打开一个

找到src/layout下的components目录，修改SideBar目录下的index.vue中的   :unique-opened="true"





#### 第3讲  权限相关数据库设计



![](D:\项目实战\物业管理系统\资料\images\3-1.png)

###### 1、用户表



###### 2、角色表



###### 3、权限表

```js
/*==============================================================*/
/* DBMS name:      MySQL 5.0                                    */
/* Created on:     2021-05-20 16:09:04                          */
/*==============================================================*/


drop table if exists sys_menu;

drop table if exists sys_role;

drop table if exists sys_role_menu;

drop table if exists sys_user;

drop table if exists sys_user_role;

/*==============================================================*/
/* Table: sys_menu                                              */
/*==============================================================*/
create table sys_menu
(
   menu_id              int not null comment '菜单id',
   parent_id            int comment '父级菜单id',
   menu_label           varchar(56) comment '菜单名称',
   menu_code            varchar(56) comment '权限字段',
   name                 varchar(56) comment '路由名称',
   path                 varchar(64) comment '路由地址',
   url                  varchar(128) comment '组件路由',
   type                 varchar(2) comment '类型 0：目录 1：菜单 2：按钮',
   icon                 varchar(64) comment '图标',
   order_num            int comment '序号',
   remark               varchar(128) comment '备注',
   parent_name          varchar(56) comment '上级菜单名称',
   primary key (menu_id)
);

/*==============================================================*/
/* Table: sys_role                                              */
/*==============================================================*/
create table sys_role
(
   role_id              int not null comment '角色id',
   role_name            varchar(56) comment '角色名称',
   remark               varchar(56) comment '备注',
   primary key (role_id)
);

/*==============================================================*/
/* Table: sys_role_menu                                         */
/*==============================================================*/
create table sys_role_menu
(
   role_menu_id         int not null comment '主键',
   role_id              int comment '角色id',
   menu_id              int comment '菜单id',
   primary key (role_menu_id)
);

/*==============================================================*/
/* Table: sys_user                                              */
/*==============================================================*/
create table sys_user
(
   user_id              int not null comment '用户id',
   login_name           varchar(36) comment '登录账户',
   password             varchar(64) comment '登录密码',
   user_name            varchar(36) comment '姓名',
   phone                varchar(16) comment '电话',
   sex                  varchar(2) comment '性别 0：女 1：男',
   id_card              varchar(36) comment '身份证号码',
   is_admin             varchar(2) comment '是否是管理员 0：不是 1：是',
   status               varchar(2) comment '0：在职  1：离职',
   is_used              varchar(2) comment '0：启用 1：禁用',
   primary key (user_id)
);

/*==============================================================*/
/* Table: sys_user_role                                         */
/*==============================================================*/
create table sys_user_role
(
   user_role_id         int not null comment '主键',
   role_id              int comment '角色id',
   user_id              int comment '用户id',
   primary key (user_role_id)
);

```



#### 第4讲  后台多模块系统搭建

###### 1、项目依赖版本号**

JDk1.8及以上、Maven3.5以上、MySq5.7以上



###### 2、项目结构

| itmk-base-parent | 父模块，pom类型、统一管理子模块 |
| ---------------- | ------------------------------- |
| itmk-base-common | 公共模块、如通用工具的封装等    |
| itmk-base-web    | 前端接口模块，提供api接口       |

###### 3、创建itmk-base-parent父模块

1、打开IDEA，file -> new - > project

![](D:\项目实战\物业管理系统\资料\images\4-1.png)

2、选择左侧**Maven**，Project SDK选择**1.8及以上**，点击Next

![](D:\项目实战\物业管理系统\资料\images\4-2.png)

3、Name里面输入**模块名称**，Location选择**项目存储路径**，GroupId:**输入包名，同一个项目，各个模块的包名一致**    ArtifactId: **模块名称**；点击Finish

![](D:\项目实战\物业管理系统\资料\images\4-3.png)

4、由于itmk-base-parent作为父模块，把生成的模块中的src删除；

![](D:\项目实战\物业管理系统\资料\images\4-4.png)



###### 4、创建itmk-base-common模块

1.在父模块itmk-base-parent上右键->New->Module，如下所示

![](D:\项目实战\物业管理系统\资料\images\4-5.png)

2.选择Maven,SDK选择1.8及以上，点击Next

![](D:\项目实战\物业管理系统\资料\images\4-6.png)

3.Name:输入模块名称 itmk-base-common，点击Finish

![](D:\项目实战\物业管理系统\资料\images\4-7.png)

###### 5、创建itmk-base-web模块

1.itmk-base-parent模块右键，点击New->Module

![](D:\项目实战\物业管理系统\资料\images\4-8.png)

2.选择Maven，SDK选择1.8及以上，点击 Next

![](D:\项目实战\物业管理系统\资料\images\4-9.png)

3.Name填入模块名称，点击Finish

![](D:\项目实战\物业管理系统\资料\images\4-10.png)

4.项目最终模块

![](D:\项目实战\物业管理系统\资料\images\4-11.png)

#### 第5讲 引入各个模块依赖

###### 1、修改package类型

修改父模块 itmk-base-parent的pom.xml打包类型为 pom; 

itmk-base-common的pom.xml打包类型为 jar；

itmk-base-wem的pom.xml打包类型为jar

![](D:\项目实战\物业管理系统\资料\images\5-1.png)



###### 2、itmk-base-parent pom.xml文件

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.itmk</groupId>
    <artifactId>itmk-base-parent</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>itmk-base-common</module>
        <module>itmk-base-web</module>
    </modules>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.4.4</version>
    </parent>
    <properties>
        <java.version>1.8</java.version>
        <swagger2.version>3.0.0</swagger2.version>
        <lombok-version>1.18.12</lombok-version>
        <mybatis-plus.version>3.4.2</mybatis-plus.version>
        <druid.version>1.2.1</druid.version>
        <kaptcha.version>2.3.2</kaptcha.version>
        <fastjson.version>1.2.68</fastjson.version>
        <commons-lang.version>2.6</commons-lang.version>
        <commons-collections.version>3.2.2</commons-collections.version>
        <commons-io.version>2.6</commons-io.version>
        <mysql-connection.version>8.0.21</mysql-connection.version>
    </properties>
    <dependencyManagement>
        <dependencies>
            <!-- lombok依赖 -->
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok-version}</version>
                <scope>provided</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql-connection.version}</version>
                <scope>runtime</scope>
            </dependency>
            <!--druid连接池-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid.version}</version>
            </dependency>
            <!--mybatis-plus依赖-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!-- kaptcha 图形验证码 -->
            <dependency>
                <groupId>com.github.penggle</groupId>
                <artifactId>kaptcha</artifactId>
                <version>${kaptcha.version}</version>
            </dependency>

            <!-- JSON转换工具类依赖 -->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>

            <dependency>
                <groupId>commons-lang</groupId>
                <artifactId>commons-lang</artifactId>
                <version>${commons-lang.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-collections</groupId>
                <artifactId>commons-collections</artifactId>
                <version>${commons-collections.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-io</groupId>
                <artifactId>commons-io</artifactId>
                <version>${commons-io.version}</version>
            </dependency>
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-boot-starter</artifactId>
                <version>${swagger2.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

</project>
```



###### 3、itmk-base-common  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-common</artifactId>
    <dependencies>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <!-- jwt-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>0.9.0</version>
        </dependency>
        <!-- 工具类依赖 -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```



###### 4、itmk-base-web  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-web</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.itmk</groupId>
            <artifactId>itmk-base-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--web启动器,对springmvc,serlvet等支持-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>

        <!--数据库依赖-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--mybatis-plus启动器-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <!--druid连接池-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-compress</artifactId>
            <version>1.18</version>
        </dependency>
		<dependency>
            <groupId>commons-lang</groupId>
            <artifactId>commons-lang</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>2.1.4.RELEASE</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.19.1</version>
                <configuration>
                    <skipTests>true</skipTests>    <!--打包过程默认关掉单元测试 -->
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```



#### 第6讲 整合MyBatis Plus

**mybatis plus官方教程**

```js
https://mp.baomidou.com/guide/
```



###### **1、新建application.yml文件**

​	1.1、在itmk-base-web模块resources文件下新建 application-test.yml文件

```js
#端口号配置
server:
  port: 8089
#数据库连接配置
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/sys_wygl?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
    username: root
    password: 123456

#mybatis plus配置
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      #配置mybatis plus 在更新时只更新非空和非NULL的字段
      update-strategy: not_empty

logging:
  pattern:
    console: '%d{yyyy-MM-dd} [%thread] %-5level %logger- %msg%n'
```

1.2、在itmk-base-web模块resources文件下新建 application.yml文件

```js
spring:
  profiles:
    active: test
```

###### 2、配置MyBatis Plus配置文件

```js
package com.itmk.config.mybatis;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.itmk.*.*.mapper")
public class MyBatisPlusConfig {
    // 最新版
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```



###### 3、封装返回值

在itmk-base-common下新建 com.itmk.utils包

```js
package com.itmk.utils;
import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class ResultVo<T> {
    private String msg;
    private int code;
    private T data;
}
```



###### 4、返回状态码定义

在itmk-base-common模块新建com.itmk.status包，然后新建 StatusCode类，如下所示

```js
package com.itmk.status;

/**
 * 返回状态码
 */
public class StatusCode {
    //返回成功
    public static final int SUCCESS_CODE = 200;
    //错误状态码
    public static final int ERROR_CODE = 500;
    //无权限
    public static final int NO_LOGIN = 600;
    public static final int NO_AUTH = 700;
}
```



###### 5、返回工具类的封装

在itmk-base-common模块下的com.itmk.utils包中新建ResultUtils类

```js
package com.itmk.utils;

import com.itmk.status.StatusCode;

/**
 * 数据返回工具类
 */
public class ResultUtils {
    /**
     * 无参数返回
     * @return
     */
    public static ResultVo succcess() {
        return Vo(null, StatusCode.SUCCESS_CODE, null);
    }
    public static ResultVo success(String msg){
        return Vo(msg,StatusCode.SUCCESS_CODE,null);
    }
    /**
     * 返回带参数
     * @param msg
     * @param data
     * @return
     */
    public static ResultVo success(String msg,Object data){
        return Vo(msg,StatusCode.SUCCESS_CODE,data);
    }
    public static ResultVo success(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo Vo(String msg, int code, Object data) {
        return new ResultVo(msg, code, data);
    }

    /**
     * 错误返回
     * @return
     */
    public static ResultVo error(){
        return Vo(null,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg){
        return Vo(msg,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo error(String msg,int code){
        return Vo(msg,code,null);
    }
    public static ResultVo error(String msg,Object data){
        return Vo(msg, StatusCode.ERROR_CODE,data);
    }
}
```



#### 第7讲  员工管理接口开发



###### 1、新建员工实体

```js
package com.itmk.web.user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;

import java.io.Serializable;

/**
 * 员工表
 */
@Data
@TableName("sys_user")
public class User implements Serializable {
    //设置主键自增
    @TableId(type= IdType.AUTO)
    private Long userId;
    //登录名
    private String loginName;
    //登录密码
    private String password;
    //姓名
    private String userName;
    //电话
    private String phone;
    //性别 0：女 1：男
    private String sex;
    //身份证
    private String idCard;
    //是否是管理员 0：不是 1：是
    private String isAdmin;
    //0：在职  1：离职
    private String status;
    //0：启用 1：禁用
    private String isUsed;
}
```

###### 2、新建员工mapper层

在web模块下新建com.itmk.web.user.mapper包，然后新建 UserMapper接口

```js
UserMapper接口需要继承 BaseMapper,继承BaseMapper的好处是我们可以直接使用Mybatis -Plus提供的通用CRUD方法
```

```js
package com.itmk.web.user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.user.entity.User;

/**
 * 员工数据访问层
 */
public interface UserMapper extends BaseMapper<User> {
}
```

###### 3、新建员工mapper层映射文件 

 在web模块的resources资源文件夹下新建mapper文件目录，然后新建UserMapper.xml，如下所示

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.user.mapper.UserMapper">

</mapper>
```

###### 4、新建员工service层

4.1.在itmk-base-web模块新建com.itmk.web.user.service包，然后新建UserService接口，并继承IService接口

```js
package com.itmk.web.user.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.user.entity.User;

public interface UserService extends IService<User> {
    //查询用户列表
    IPage<User> list(UserParm parm);
}

```

4.2在itmk-base-web模块新建com.itmk.web.user.service.impl包，然后新建UserServiceImpl类

```js
package com.itmk.web.user.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.mapper.UserMapper;
import com.itmk.web.user.service.UserService;
import org.springframework.stereotype.Service;

/**
 * 继承 ServiceImpl 的好处是 可以使用 Mybatis-Plus的通用CRUD方法，
 * implements UserService的原因，是如果 Mybatis-Plus的通用CRUD方法不够用，或者不符合开发需求的
 * 时候，需要扩展我们自己定义的方法
 * @Service 表示把该类交给spring 进行管理，我们就可以在其他类里面直接注入使用
 */
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
    @Override
    public IPage<User> list(UserParm parm) {
        //构建分页对象
        IPage<User> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //构造前端查询条件
        QueryWrapper<User> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getPhone())){
            query.lambda().like(User::getPhone,parm.getPhone());
        }
        if(StringUtils.isNotEmpty(parm.getUserName())){
            query.lambda().like(User::getUserName,parm.getUserName());
        }
        return this.page(page,query);
    }
}
```

###### 5、新建员工controller控制器

在itmk-base-web模块新建com.itmk.web.user.controller包，然后新建 UserController控制器

```js
package com.itmk.web.user.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.entity.UserParm;
import com.itmk.web.user.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 员工管理控制器
 */
@RestController
@RequestMapping("/api/user")
public class UserController {
    @Autowired
    private UserService userService;

    /**
     * 新增用户
     * @param user
     * @return
     */
    @PostMapping
    public ResultVo addUser(@RequestBody User user){
        boolean save = userService.save(user);
        if(save){
            return ResultUtils.success("新增用户成功");
        }
        return ResultUtils.error("新增用户失败");
    }

    /**
     * 编辑用户
     * @param user
     * @return
     */
    @PutMapping
    public ResultVo editUser(@RequestBody User user){
        boolean b = userService.updateById(user);
        if(b){
            return ResultUtils.success("编辑用户成功");
        }
        return ResultUtils.error("编辑用户失败");
    }

    /**
     * 删除用户
     * @param userId
     * @return
     */
    @DeleteMapping
    public ResultVo deleteUser(@RequestParam("userId") Long userId){
        boolean b = userService.removeById(userId);
        if(b){
            return ResultUtils.success("删除用户成功");
        }
        return ResultUtils.error("删除用户失败");
    }

    /**
     * 获取用户列表
     * @param parm
     * @return
     */
    @GetMapping("/list")
    public ResultVo list(UserParm parm){
        IPage<User> list = userService.list(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```

```js
package com.itmk.web.user.entity;

import lombok.Data;

@Data
public class UserParm {
    //页容量
    private Long pageSize;
    //当前页
    private Long curentPage;
    //姓名
    private String userName;
    //电话
    private String phone;
}

```



###### 6、新建启动类

在itmk-base-web模块的com.itmk包下新建 WyglApplication启动类

```js
package com.itmk;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class WyglApplication {
    public static void main(String[] args) {
        SpringApplication.run(WyglApplication.class,args);
    }
}
```



#### 第8讲 员工管理列表制作

element ui官网

```js
https://element.eleme.cn/#/zh-CN/component/installation
```



###### 1、页面完整代码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchform"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 员工表格 -->
    <el-table :height="tableHeight" :data="tableList" empty-text="暂无数据" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="idCard" label="身份证"></el-table-column>
      <el-table-column prop="sex" label="性别"></el-table-column>
      <el-table-column prop="status" label="是否在职"></el-table-column>
      <el-table-column prop="isUsed" label="账户状态"></el-table-column>
    </el-table>
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.curentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getUserListApi } from "@/api/user";
export default {
  //所有需要在页面上展示的数据，都需要显示的在data里面进行定义
  data() {
    return {
      //表格的高度
      tableHeight: 0,
      //搜索框数据绑定
      parms: {
        phone: "",
        userName: "",
        pageSize: 10,
        curentPage: 1,
        total: 0,
      },
      //表格数据
      tableList: [],
    };
  },
  created() {
    this.getUserList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    async getUserList() {
      let res = await getUserListApi(this.parms);
      if (res.code == 200) {
        this.tableList = res.data.records;
      }
      console.log(res);
    },
    //页容量改变的时候触发
    sizeChange(val) {
      console.log(val);
    },
    //页数改变的时候触发
    currentChange(val) {
      console.log(val);
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```

###### 2、新建http.js

```js
import axios from 'axios'
import { MessageBox, Message } from 'element-ui'
import store from '@/store'
import { getToken } from '@/utils/auth'
import qs from 'qs'
// create an axios instance
//创建一个axios实例
const service = axios.create({
  baseURL: process.env.VUE_APP_BASE_API_PRO, // url = base url + request url
  // withCredentials: true, // send cookies when cross-domain requests
  timeout: 5000 // request timeout
})

// request interceptor
//请求发送之前的拦截器
service.interceptors.request.use(
  config => {
    // do something before request is sent
    //如果token存在，把token添加到请求的头部
    if (store.getters.token) {
      // let each request carry token
      // ['X-Token'] is a custom headers key
      // please modify it according to the actual situation
      config.headers['X-Token'] = getToken()
    }
    return config
  },
  error => {
    // do something with request error
    console.log(error) // for debug
    return Promise.reject(error)
  }
)

// response interceptor
//请求返回之后的处理
service.interceptors.response.use(
  /**
   * If you want to get http information such as headers or status
   * Please return  response => response
  */

  /**
   * Determine the request status by custom code
   * Here is just an example
   * You can also judge the status by HTTP Status Code
   */
  response => {
    const res = response.data

    // if the custom code is not 20000, it is judged as an error.
    if (res.code !== 200) {
      Message({
        message: res.msg || '服务器出错',
        type: 'error',
        duration: 5 * 1000
      })

      // 50008: Illegal token; 50012: Other clients logged in; 50014: Token expired;
      if (res.code === 50008 || res.code === 50012 || res.code === 50014) {
        // to re-login
        MessageBox.confirm('You have been logged out, you can cancel to stay on this page, or log in again', 'Confirm logout', {
          confirmButtonText: 'Re-Login',
          cancelButtonText: 'Cancel',
          type: 'warning'
        }).then(() => {
          store.dispatch('user/resetToken').then(() => {
            location.reload()
          })
        })
      }
      return Promise.reject(new Error(res.msg || '服务器出错'))
    } else {
      return res
    }
  },
  error => {
    console.log('err' + error) // for debug
    Message({
      message: error.msg || '服务器出错!',
      type: 'error',
      duration: 5 * 1000
    })
    return Promise.reject(error)
  }
)

//请求方法
const http = {
    post(url, params) {
      return service.post(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    put(url, params) {
      return service.put(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user?id=10
    get(url, params) {
      return service.get(url, {
        params: params,
        paramsSerializer: (params) => {
          return qs.stringify(params)
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    getRestApi(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          console.log(key)
          console.log(params[key])
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      console.log(_params)
      if (_params) {
        return service.get(`${url}${_params}`)
      } else {
        return service.get(url)
      }
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    delete(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      if (_params) {
        return service.delete(`${url}${_params}`).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      } else {
        return service.delete(url).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      }
    },
    upload(url, params) {
      return service.post(url, params, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
    }
  }
  export default http


```



###### 3、修改src/api下的user.js

添加获取用户列表的方法

```js
import request from '@/utils/request'
import http from '@/utils/http'
//获取用户列表
export async function getUserListApi(parm){
  return await http.get("/api/user/list",parm)
}
export function login(data) {
  return request({
    url: '/vue-admin-template/user/login',
    method: 'post',
    data
  })
}

export function getInfo(token) {
  return request({
    url: '/vue-admin-template/user/info',
    method: 'get',
    params: { token }
  })
}

export function logout() {
  return request({
    url: '/vue-admin-template/user/logout',
    method: 'post'
  })
}

```

###### 4、添加获取接口的地址

.env.development

```js
# just a flag
ENV = 'development'

# base api
VUE_APP_BASE_API = '/dev-api'
VUE_APP_BASE_API_PRO = 'http://localhost:8089/'

```

.env.production

```js
# just a flag
ENV = 'production'

# base api
VUE_APP_BASE_API = '/prod-api'
VUE_APP_BASE_API_PRO = 'http://localhost:8089/'

```



###### 5、后端跨域配置

```js
Access to XMLHttpRequest at 'http://localhost:8089/api/user/list?phone=&userName=&pageSize=10&curentPage=1' from origin 'http://localhost:9528' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

跨域配置

在itmk-base-web模块新建com.itmk.config.web包，然后新建WebMvcConfig配置类

```js
package com.itmk.config.web;


import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    /**
     * 跨域配置
     * @param registry
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .maxAge(3600)
                .allowCredentials(true);
    }
}
```

###### 6、分页组件英文改中文

找到main.js文件

```js
//英文
import locale from 'element-ui/lib/locale/lang/en' // lang i18n
```

改为

```js
//中文
import locale from 'element-ui/lib/locale/lang/zh-CN'
```





#### 第9讲 通用弹框组件封装

###### 1、效果展示



![](D:\项目实战\物业管理系统\资料\images\9-1.png)



###### 2、代码实现

由于element自身的弹框组件不是很美观，需要优化后可用于实际生产

在src/components目录下新建system目录，然后新建 SysDialog.vue组件

```js
<template>
  <el-dialog
    top='1vh'
    :title="title"
    :visible="visible"
    :width="width + 'px'"
    :before-close="onClose"
  >
    <div class="containner" :style="{ height: height + 'px' }">
      <slot name="content"></slot>
    </div>
    <span slot="footer" class="dialog-footer">
      <el-button type="danger" @click="onClose()">取 消</el-button>
      <el-button type="primary" @click="onConfirm()">确 定</el-button>
    </span>
  </el-dialog>
</template>

<script>
export default {
  props: {
    title: {
      type: String,
      default: "标题",
    },
    visible: {
      type: Boolean,
      default: false,
    },
    width: {
      type: Number,
      default: 600,
    },
    height: {
      type: Number,
      default: 250,
    },
  },
  methods: {
    //关闭事件
    onClose() {
      this.$emit("onClose");
    },
    //确认事件
    onConfirm() {
      this.$emit("onConfirm");
    },
  },
};
</script>

<style lang="scss" scoped>
.containner{
  overflow-x: initial;
  overflow-y: auto;
}
.el-dialog__wrapper {
  ::v-deep .el-dialog {
    border-top-left-radius: 7px;
    border-top-right-radius: 7px;
    .el-dialog__header {
      border-top-left-radius: 7px;
      border-top-right-radius: 7px;
      background-color: #1890ff;
      .el-dialog__title {
        color: #fff;
        font-size: 16px;
        font-weight: 600;
      }
      .el-dialog__close {
        color: #fff;
      }
    }
    .el-dialog__body {
      padding: 10px;
    }
    .el-dialog__footer {
      border-top: 1px solid #e8eaec !important;
      padding: 10px;
    }
  }
}
</style>
```



#### 第10讲 新增员工页面制作

效果展示

![](D:\项目实战\物业管理系统\资料\images\10-1.png)

###### 1、清空表单工具

在src的utils下新建resetForm.js

```js
//表单清空
// formName: 表单的ref属性  obj表单的数据域
export default function resetForm(formName,obj){
    //清空表单
    if(this.$refs[formName]){
        this.$refs[formName].resetFields();
    }
    //清空数据域
    Object.keys(obj).forEach(key =>{
        obj[key] = '';
    })
}
```

在main.js中挂载

```js
//清空表单
import resetForm from '@/utils/resetForm'
Vue.prototype.$resetForm = resetForm;
```

###### 2、信息确认提示框封装

在src的utils目录下新建 myconfirm.js

```js
import {MessageBox,Message} from 'element-ui'
//信息确认弹框封装
export default function myconfirm(text){
    return new Promise((resolve,reject)=>{
        MessageBox.confirm(text,'系统提示',{
            confirmButtonText:'确定',
            cancelButtonText:'取消',
            type:'warning'
        }).then(()=>{
            resolve(true);
        }).catch(()=>{
            Message.warning('已取消')
            reject(false)
        })
    }).catch(()=>{
        
    })
}
```

在main.js中挂载

```js
//信息提示框
import myconfirm from '@/utils/myconfirm'
Vue.prototype.$myconfirm = myconfirm;
```

###### 3、引入 SysDialog组件

在sysUserList.vue页面引入 SysDialog组件

```js
import SysDialog from "@/components/system/SysDialog";
```

###### 4、注册组件

```js
//组件在使用之前需要注册
  components: {
    SysDialog,
  },
```

###### 5、新增员工页面制作

```js
<!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      :width="dialog.width"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名:">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item style="width:280px;" prop="sex" label="性别:">
            <el-radio-group  v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话:">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="idCard"  label="身份证:">
            <el-input v-model="addModel.idCard"></el-input>
          </el-form-item>
          <el-form-item prop="loginName" label="登录名:">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="密码:">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item style="width:280px;" prop="status" label="离职:">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'1'">是</el-radio>
              <el-radio :label="'0'">否</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item style="width:280px;" prop="isUsed" label="启用:">
            <el-radio-group  v-model="addModel.isUsed">
              <el-radio :label="'1'">是</el-radio>
              <el-radio :label="'0'">否</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
```

###### 6、sysUserList.vue完整页面代码

```js
<template>
  <el-main>
    <!-- 搜索框
        el-form:就把他当做正常的div一样使用
        :model  表单绑定的数据域
        ref :相当于div的id,在当前页面是唯一的
        :inline为true时，排列在一行
         -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button @click="addUser" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 员工列表
        :data表格的数据
        colum的prop需要跟返回的数据属性名对应
         -->
    <el-table
      :data="tableList"
      :height="tableHeight"
      size="small"
      empty-text="暂无数据"
      border
      stripe
    >
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="idCard" label="身份证"></el-table-column>
      <el-table-column prop="sex" label="性别"></el-table-column>
      <el-table-column prop="status" label="是否离职"></el-table-column>
      <el-table-column prop="isUsed" label="账号状态"></el-table-column>
    </el-table>
    <!-- 分页 
    size-change 页容量改变时触发事件
    current-change  页数改变时触发
    :current-page.sync 当前页数
    :page-size 每页几条数据
     :total 总条数
    -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.curentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      :width="dialog.width"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名:">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item style="width:280px;" prop="sex" label="性别:">
            <el-radio-group  v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话:">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="idCard"  label="身份证:">
            <el-input v-model="addModel.idCard"></el-input>
          </el-form-item>
          <el-form-item prop="loginName" label="登录名:">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="密码:">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item style="width:280px;" prop="status" label="离职:">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'1'">是</el-radio>
              <el-radio :label="'0'">否</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item style="width:280px;" prop="isUsed" label="启用:">
            <el-radio-group  v-model="addModel.isUsed">
              <el-radio :label="'1'">是</el-radio>
              <el-radio :label="'0'">否</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getUserListApi } from "@/api/user";
import SysDialog from "@/components/system/SysDialog";
export default {
  //组件在使用之前需要注册
  components: {
    SysDialog,
  },
  //所有需要在页面展示的数据，都要在data里面显示的定义
  data() {
    return {
      rules: {},
      //新增或编辑表单数据域
      addModel: {
        userId:'',
        type:'', //0： 新增 1： 编辑
        userName:'',
        sex:'',
        phone:'',
        idCard:'',
        loginName:'',
        password:'',
        status:'',
        isUsed:''
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        height: 240,
        width: 610,
      },
      //表格的高度
      tableHeight: 0,
      //搜索框的数据绑定
      parms: {
        userName: "",
        phone: "",
        curentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的数据
      tableList: [],
    };
  },
  created() {
    this.getUserList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //对话框确认事件
    onConfirm() {
      console.log(this.addModel)
      // this.dialog.visible = false;
    },
    //对话框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮事件
    addUser() {
      this.dialog.title = "新增员工";
      this.dialog.visible = true;
    },
    //获取用户列表
    async getUserList() {
      let res = await getUserListApi(this.parms);
      if (res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //页容量改变触发
    sizeChange(val) {},
    //页数改变时触发
    currentChange(val) {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第11讲 新增员工数据对接

###### 1、在src/api/user.js中添加如下代码

```js
//新增员工
export async function addUserApi(parm){
  return await http.post("/api/user",parm)
}
```

###### 2、在sysUserList.vue页面引入addUserApi

```js
import { getUserListApi, addUserApi } from "@/api/user";
```

###### 3、表单验证

```js
rules: {
        userName: [
          {
            required: true,
            trigger: "change",
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            required: true,
            trigger: "change",
            message: "请填写电话号码",
          },
        ],
        idCard: [
          {
            required: true,
            trigger: "change",
            message: "请填写身份证号码",
          },
        ],
        status: [
          {
            required: true,
            trigger: "change",
            message: "请选择是否离职",
          },
        ],
        isUsed: [
          {
            required: true,
            trigger: "change",
            message: "请选择是否启用",
          },
        ],
            sex: [
          {
            required: true,
            trigger: "change",
            message: "请选择性别",
          },
        ]
      },
```

###### 4、新增对接完整源码

```js
<template>
  <el-main>
    <!-- 搜索框
        el-form:就把他当做正常的div一样使用
        :model  表单绑定的数据域
        ref :相当于div的id,在当前页面是唯一的
        :inline为true时，排列在一行
         -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button @click="addUser" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 员工列表
        :data表格的数据
        colum的prop需要跟返回的数据属性名对应
         -->
    <el-table
      :data="tableList"
      :height="tableHeight"
      size="small"
      empty-text="暂无数据"
      border
      stripe
    >
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="idCard" label="身份证"></el-table-column>
      <el-table-column align="center" prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '1'" size="normal">男</el-tag>
          <el-tag v-if="scope.row.sex == '0'" type="success" size="normal"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" prop="status" label="是否离职">
        <template slot-scope="scope">
          <el-switch
            :active-value="'0'"
            active-text="否"
            inactive-text="是"
            :inactive-value="'1'"
            v-model="scope.row.status"
            @change="changeStatus(scope.row)"
          ></el-switch>
          <!-- <el-tag v-if="scope.row.status =='1'" type="danger" size="normal"  effect="dark">是</el-tag> -->
          <!-- <el-tag v-if="scope.row.status =='0'" type="danger" size="normal"  effect="dark">否</el-tag> -->
        </template>
      </el-table-column>
      <el-table-column align="center" prop="isUsed" label="账号状态">
        <template slot-scope="scope">
          <el-switch
            v-model="scope.row.isUsed"
            :active-value="'0'"
            :inactive-value="'1'"
            active-text="启用"
            inactive-text="禁用"
            @change="changeUsed(scope.row)"
          >
          </el-switch>
        </template>
      </el-table-column>
      <el-table-column align="center" width="200" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editUser(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteUser(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 
    size-change 页容量改变时触发事件
    current-change  页数改变时触发
    :current-page.sync 当前页数
    :page-size 每页几条数据
     :total 总条数
    -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.curentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      :width="dialog.width"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名:">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item style="width: 280px" prop="sex" label="性别:">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话:">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="idCard" label="身份证:">
            <el-input v-model="addModel.idCard"></el-input>
          </el-form-item>
          <el-form-item prop="loginName" label="登录名:">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="密码:">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item style="width: 280px" prop="status" label="离职:">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'1'">是</el-radio>
              <el-radio :label="'0'">否</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item style="width: 280px" prop="isUsed" label="启用:">
            <el-radio-group v-model="addModel.isUsed">
              <el-radio :label="'1'">否</el-radio>
              <el-radio :label="'0'">是</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getUserListApi, addUserApi } from "@/api/user";
import SysDialog from "@/components/system/SysDialog";
export default {
  //组件在使用之前需要注册
  components: {
    SysDialog,
  },
  //所有需要在页面展示的数据，都要在data里面显示的定义
  data() {
    return {
      rules: {
        userName: [
          {
            required: true,
            trigger: "change",
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            required: true,
            trigger: "change",
            message: "请填写电话号码",
          },
        ],
        idCard: [
          {
            required: true,
            trigger: "change",
            message: "请填写身份证号码",
          },
        ],
        status: [
          {
            required: true,
            trigger: "change",
            message: "请选择是否离职",
          },
        ],
        isUsed: [
          {
            required: true,
            trigger: "change",
            message: "请选择是否启用",
          },
        ],
        sex: [
          {
            required: true,
            trigger: "change",
            message: "请选择性别",
          },
        ],
      },
      //新增或编辑表单数据域
      addModel: {
        userId: "",
        type: "", //0： 新增 1： 编辑
        userName: "",
        sex: "",
        phone: "",
        idCard: "",
        loginName: "",
        password: "",
        status: "",
        isUsed: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        height: 240,
        width: 610,
      },
      //表格的高度
      tableHeight: 0,
      //搜索框的数据绑定
      parms: {
        userName: "",
        phone: "",
        curentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的数据
      tableList: [],
    };
  },
  created() {
    this.getUserList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //删除按钮
    deleteUser(row) {
      console.log(row);
    },
    //编辑按钮
    editUser(row) {
      console.log(row);
    },
    //表格启用、禁用事件
    changeUsed(row) {
      console.log(row);
    },
    //表格在职、离职点击事件
    changeStatus(row) {
      console.log(row);
    },
    //对话框确认事件
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          }
          //成功，刷新数据列表
          if (res && res.code == 200) {
            this.getUserList();
            this.dialog.visible = false;
          }
          console.log(res);
        }
      });
      // this.dialog.visible = false;
    },
    //对话框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮事件
    addUser() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      this.addModel.type = "0";
      this.dialog.title = "新增员工";
      this.dialog.visible = true;
    },
    //获取用户列表
    async getUserList() {
      let res = await getUserListApi(this.parms);
      if (res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
      }
    },
    //页容量改变触发
    sizeChange(val) {},
    //页数改变时触发
    currentChange(val) {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第12讲 员工编辑和删除接口对接

###### 1、添加快速复制的工具

在src/utils下新建objCoppy.js

```js
//对象的快速复制  不存在的key不复制
export default async function objCoppy(obj1,obj2){
    Object.keys(obj2).forEach(key =>{
        obj2[key] = obj1[key]
    })
}
```

```js
//对象快速复制
import objCoppy from '@/utils/objCoppy'
Vue.prototype.$objCoppy = objCoppy;
```



###### 2、添加编辑、删除的请求方法

在src/api/user.js中添加如下代码

```js
//编辑员工
export async function editUserApi(parm){
  return await http.put("/api/user",parm)
}
//删除员工
export async function deleteUserApi(parm){
  return await http.delete(parm)
}
```

然后在sysUserList.vue中引入  

```js
import { getUserListApi, addUserApi,editUserApi,deleteUserApi } from "@/api/user";
```



###### 3、编辑按钮事件

```js
//编辑按钮
    editUser(row) {
      this.dialog.title = '编辑员工';
      //清空表单数据
      this.$resetForm('addForm',this.addModel)
      //设为编辑
      this.addModel.type = '1';
      //编辑回显
      this.$objCoppy(row,this.addModel);
      //显示新增或编辑弹框
      this.dialog.visible = true;
      console.log(row);
    },
```

###### 4、编辑确认事件

```js
//对话框确认事件
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          }else{
            res = await editUserApi(this.addModel)
          }
          //成功，刷新数据列表
          if (res && res.code == 200) {
            this.getUserList();
            this.dialog.visible = false;
          }
          console.log(res);
        }
      });
      // this.dialog.visible = false;
    },
```

由于删除是restful api格式的请求，员工后端控制器UserController的deleteUser()方法改为如下

```js
/**
     * 删除员工
     * @param userId
     * @return
     */
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId){
        boolean b = userService.removeById(userId);
        if(b){
            return ResultUtils.success("删除员工成功");
        }
        return ResultUtils.error("删除员工失败");
    }
```

###### 5、新增或编辑用户名唯一，密码MD5加密

修改员工后端控制器UserController代码如下

```js
package com.itmk.web.user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.entity.UserParm;
import com.itmk.web.user.service.UserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

/**
 * 员工管理的控制器
 */
@RestController
@RequestMapping("/api/user")
public class UserController {
    @Autowired
    private UserService userService;

    /**
     * 新增员工
     *
     * @param user
     * @return
     */
    @PostMapping
    public ResultVo addUser(@RequestBody User user) {
        //判断登录名 的唯一性
        if (StringUtils.isNotEmpty(user.getLoginName())) {
            QueryWrapper<User> query = new QueryWrapper<>();
            query.lambda().eq(User::getLoginName, user.getLoginName());
            User one = userService.getOne(query);
            if (one != null) {
                return ResultUtils.error("登录名已经被占用!", 500);
            }
        }
        //如果密码存在，MD5加密
        if (StringUtils.isNotEmpty(user.getPassword())) {
            user.setPassword(DigestUtils.md5DigestAsHex(user.getPassword().getBytes()));
        }
        boolean save = userService.save(user);
        if (save) {
            return ResultUtils.success("新增员工成功");
        }
        return ResultUtils.error("新增员工失败");
    }

    /**
     * 编辑员工
     *
     * @param user
     * @return
     */
    @PutMapping
    public ResultVo editUser(@RequestBody User user) {
        //判断登录名 的唯一性
        if (StringUtils.isNotEmpty(user.getLoginName())) {
            QueryWrapper<User> query = new QueryWrapper<>();
            query.lambda().eq(User::getLoginName, user.getLoginName());
            User one = userService.getOne(query);
            if (one != null && one.getUserId() != user.getUserId()) {
                return ResultUtils.error("登录名已经被占用!", 500);
            }
        }
        //如果密码存在，MD5加密
        if (StringUtils.isNotEmpty(user.getPassword())) {
            user.setPassword(DigestUtils.md5DigestAsHex(user.getPassword().getBytes()));
        }
        boolean b = userService.updateById(user);
        if (b) {
            return ResultUtils.success("编辑员工成功");
        }
        return ResultUtils.error("编辑员工失败");
    }

    /**
     * 删除员工
     *
     * @param userId
     * @return
     */
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId) {
        boolean b = userService.removeById(userId);
        if (b) {
            return ResultUtils.success("删除员工成功");
        }
        return ResultUtils.error("删除员工失败");
    }

    /**
     * 查询员工列表
     *
     * @param parm
     * @return
     */
    @GetMapping("/list")
    public ResultVo list(UserParm parm) {
        IPage<User> list = userService.list(parm);
        //前端不展示密码
        list.getRecords().stream().forEach(item -> item.setPassword(""));
        return ResultUtils.success("查询成功", list);
    }
}

```



#### 第13讲  表格离职、启用数据对接

###### 1、离职、启用方法

```js
//表格是否启用点击事件
    async changeUsed(row) {
      console.log(row);
      let parm = {
        userId: row.userId,
        isUsed: row.isUsed,
      };
      let res = await editUserApi(parm);
      if (res && res.code == 200) {
        //刷新列表
        this.getUserList();
        this.$message.success(res.msg);
      }
    },
    //表格是否离职点击事件
    async changeStatus(row) {
      console.log(row);
      let parm = {
        userId: row.userId,
        status: row.status,
      };
      let res = await editUserApi(parm);
      if (res && res.code == 200) {
        //刷新列表
        this.getUserList();
        this.$message.success(res.msg);
      }
    },
```



#### 第14讲 员工列表搜索

###### 1、修改添加和重置按钮如下所示

```js
<el-button @click="searchBtn" icon="el-icon-search">查询</el-button>
<el-button @click="resetBtn" style="color:#FF7670;" icon="el-icon-delete">重置</el-button>
```



###### 2、给搜索按钮添加点击事件

在methods方法里面添加如下代码

```js
	//重置按钮
    resetBtn(){
      this.parms.phone = '';
      this.parms.userName = '';
      this.getUserList();
    },
    //搜索按钮
    searchBtn(){
      this.getUserList();
    },
```

###### 3、表单页容量改变触发

把分页插件的点击事件修改为如下

```js
   //页容量改变触发
    sizeChange(val) {
      console.log(val)
      this.parms.pageSize = val;
      this.getUserList();
    },
    //页数改变时触发
    currentChange(val) {
      console.log(val)
      this.parms.curentPage = val;
      this.getUserList();
    },
```



###### 4、修改后台系统标题

找到src/layout/components/Sidebar/Logo.vue页面，修改为如下

```js
<template>
  <div class="sidebar-logo-container" :class="{'collapse':collapse}">
    <transition name="sidebarLogoFade">
      <router-link v-if="collapse" key="collapse" class="sidebar-logo-link" to="/">
        <img v-if="logo" :src="logo" class="sidebar-logo">
        <h1 v-else class="sidebar-title">{{ title }} </h1>
      </router-link>
      <router-link v-else key="expand" class="sidebar-logo-link" to="/">
        <img v-if="logo" :src="logo" class="sidebar-logo">
        <h1 style="font-weight:600;font-size:20px;" class="sidebar-title">{{ title }} </h1>
      </router-link>
    </transition>
  </div>
</template>

<script>
export default {
  name: 'SidebarLogo',
  props: {
    collapse: {
      type: Boolean,
      required: true
    }
  },
  data() {
    return {
      title: '物业管理系统',
      logo: 'https://wpimg.wallstcn.com/69a1c46c-eb1c-4b46-8bd4-e9e686ef5251.png'
    }
  }
}
</script>

<style lang="scss" scoped>
.sidebarLogoFade-enter-active {
  transition: opacity 1.5s;
}

.sidebarLogoFade-enter,
.sidebarLogoFade-leave-to {
  opacity: 0;
}

.sidebar-logo-container {
  position: relative;
  width: 100%;
  height: 50px;
  line-height: 50px;
  background: #2b2f3a;
  text-align: center;
  overflow: hidden;

  & .sidebar-logo-link {
    height: 100%;
    width: 100%;

    & .sidebar-logo {
      width: 32px;
      height: 32px;
      vertical-align: middle;
      margin-right: 12px;
    }

    & .sidebar-title {
      display: inline-block;
      margin: 0;
      color: #fff;
      font-weight: 600;
      line-height: 50px;
      font-size: 14px;
      font-family: Avenir, Helvetica Neue, Arial, Helvetica, sans-serif;
      vertical-align: middle;
    }
  }

  &.collapse {
    .sidebar-logo {
      margin-right: 0px;
    }
  }
}
</style>

```



#### 第15讲 角色管理接口开发

###### 1、新建角色实体

```js
package com.itmk.web.role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
@Data
@TableName("sys_role")
public class Role implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long roleId;
    //角色名称
    private String roleName;
    //备注
    private String remark;
}


```

###### 2、新建mapper层

```js
package com.itmk.web.role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.role.Role;

/**
 * 角色数据访问层
 */
public interface RoleMapper extends BaseMapper<Role> {
}

```

**新建mapper映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.role.mapper.RoleMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.role.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.role.Role;

/**
 * 角色service层
 */
public interface RoleService extends IService<Role> {
     IPage<Role> list(RoleParm parm);
}

```

**新建角色service实现类**

```js
package com.itmk.web.role.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.role.Role;
import com.itmk.web.role.mapper.RoleMapper;
import com.itmk.web.role.service.RoleService;
import org.springframework.stereotype.Service;

@Service
public class RoleServiceImpl extends ServiceImpl<RoleMapper, Role> implements RoleService {
    @Override
    public IPage<Role> list(RoleParm parm) {
        //构造分页条件
        QueryWrapper<Role> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getRoleName())){
            query.lambda().like(Role::getRoleName,parm.getRoleName());
        }
        //构造分页对象
        IPage<Role> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        return this.baseMapper.selectPage(page,query);
    }
}

```

###### 4、新建角色控制器

```js
package com.itmk.web.role.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.role.entity.Role;
import com.itmk.web.role.entity.RoleParm;
import com.itmk.web.role.service.RoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/role")
public class RoleController {
    @Autowired
    private RoleService roleService;

    //查询角色列表
    @GetMapping("/list")
    public ResultVo list(RoleParm parm){
        IPage<Role> list = roleService.list(parm);
        return ResultUtils.success("查询成功!",list);
    }

    //新增角色
    @PostMapping
    public ResultVo addRole(@RequestBody Role role){
        boolean save = roleService.save(role);
        if(save){
            return ResultUtils.success("新增角色成功!");
        }
        return ResultUtils.error("新增角色失败!");
    }

    //编辑角色
    @PutMapping
    public ResultVo editRole(@RequestBody Role role){
        boolean save = roleService.updateById(role);
        if(save){
            return ResultUtils.success("编辑角色成功!");
        }
        return ResultUtils.error("编辑角色失败!");
    }
    //删除角色
    @DeleteMapping("/{roleId}")
    public ResultVo deleteRole(@PathVariable("roleId") Long roleId){
        boolean save = roleService.removeById(roleId);
        if(save){
            return ResultUtils.success("删除角色成功!");
        }
        return ResultUtils.error("删除角色失败!");
    }
}
```



#### 第16讲 角色管理列表制作

###### 1、新建请求方法

在src/api下新建role.js

```js
import http from '@/utils/http'
//获取角色列表
export async function getRoleListApi(parm){
    return await http.get("/api/role/list",parm)
}
```

###### 2、在修改sysRoleList.vue页面如下

```js
<template>
  <el-main>
    <!-- 搜索表单 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="角色名称">
        <el-input v-model="parms.roleName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button
          icon="el-icon-delete"
          style="color: #ff7670"
          @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 角色列表 -->
    <el-table :height="tableHeight" size="small" :data="roleList" border stripe>
      <el-table-column label="角色名称" prop="roleName"></el-table-column>
      <el-table-column label="备注" prop="remark"></el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getRoleListApi } from "@/api/role";
export default {
  //所有需要在页面展示的数据，都要显示的在data里面进行定义
  data() {
    return {
      //表格数据
      roleList: [],
      //表格的高度
      tableHeight: 0,
      //查询参数
      parms: {
        pageSize: 10, //每页显示几条数据
        currentPage: 1, //当前第几页
        roleName: "",
        total: 0, //总条数
      },
    };
  },
  created() {
    this.getRoleList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 190;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        this.roleList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第17讲 新增角色制作

###### 1、添加新增角色的请求

在src/api下新建如下代码

```js
import http from '@/utils/http'
//获取角色列表
export async function getRoleListApi(parm){
    return await http.get("/api/role/list",parm)
}
//新增角色
export async function addRoleApi(parm){
    return await http.post("/api/role",parm)
}
//编辑角色
export async function editRoleApi(parm){
    return await http.put("/api/role",parm)
}
//删除角色
export async function deleteRoleApi(parm){
    return await http.delete("/api/role",parm)
}

```

###### 2、sysRoleList.vue新增完整代码

```js
<template>
  <el-main>
    <!-- 搜索表单 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="角色名称">
        <el-input v-model="parms.roleName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button
          icon="el-icon-delete"
          style="color: #ff7670"
          @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 角色列表 -->
    <el-table :height="tableHeight" size="small" :data="roleList" border stripe>
      <el-table-column label="角色名称" prop="roleName"></el-table-column>
      <el-table-column label="备注" prop="remark"></el-table-column>
      <el-table-column align="center" width="200" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" icon="el-icon-edit" size="small" @click="editRole(scope.row)">编辑</el-button>
          <el-button type="danger" icon="el-icon-delete" size="small" @click="deleteRole(scope.row)">删除</el-button>
          
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          :model="addModule"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="normal"
        >
          <el-form-item prop="roleName" label="角色名称">
            <el-input v-model="addModule.roleName"></el-input>
          </el-form-item>
          <el-form-item label="备注">
            <el-input v-model="addModule.remark"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getRoleListApi,addRoleApi,editRoleApi,deleteRoleApi } from "@/api/role";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  //所有需要在页面展示的数据，都要显示的在data里面进行定义
  data() {
    return {
      //表单验证规则
      rules:{
        roleName:[{
          required:true,
          trigger:'change',
          message:'请填写角色名称'
        }]
      },
      //新增或编辑数据绑定
      addModule:{
        roleId:'',
        roleName:'',
        remark:'',
        type:''
      },
      //弹框属性
      dialog: {
        title: "",
        height: 120,
        width: 610,
        visible: false,
      },
      //表格数据
      roleList: [],
      //表格的高度
      tableHeight: 0,
      //查询参数
      parms: {
        pageSize: 10, //每页显示几条数据
        currentPage: 1, //当前第几页
        roleName: "",
        total: 0, //总条数
      },
    };
  },
  created() {
    this.getRoleList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 190;
    });
  },
  methods: {
    //删除按钮
    deleteRole(row){

    },
    //编辑按钮
    editRole(row){

    },
    //新增或编辑取消事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async valid=>{
        if(valid){
          let res = null;
          if(this.addModule.type == '0'){
            res = await addRoleApi(this.addModule);
          }
          if(res && res.code == 200){
            //刷新列表
            this.getRoleList();
            this.dialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      })
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //新增按钮
    addBtn() {
      //清空表单数据
      this.$resetForm('addForm',this.addModule);
      this.addModule.type = '0';
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.roleName = '';
      this.getRoleList();
    },
    //搜索按钮
    searchBtn() {
      this.getRoleList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        this.roleList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第18讲 编辑、删除角色接口对接

###### 1、sysRoleList.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索表单 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="角色名称">
        <el-input v-model="parms.roleName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button
          icon="el-icon-delete"
          style="color: #ff7670"
          @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 角色列表 -->
    <el-table :height="tableHeight" size="small" :data="roleList" border stripe>
      <el-table-column label="角色名称" prop="roleName"></el-table-column>
      <el-table-column label="备注" prop="remark"></el-table-column>
      <el-table-column align="center" width="200" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editRole(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteRole(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          :model="addModule"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="normal"
        >
          <el-form-item prop="roleName" label="角色名称">
            <el-input v-model="addModule.roleName"></el-input>
          </el-form-item>
          <el-form-item label="备注">
            <el-input v-model="addModule.remark"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getRoleListApi,
  addRoleApi,
  editRoleApi,
  deleteRoleApi,
} from "@/api/role";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  //所有需要在页面展示的数据，都要显示的在data里面进行定义
  data() {
    return {
      //表单验证规则
      rules: {
        roleName: [
          {
            required: true,
            trigger: "change",
            message: "请填写角色名称",
          },
        ],
      },
      //新增或编辑数据绑定
      addModule: {
        roleId: "",
        roleName: "",
        remark: "",
        type: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 120,
        width: 610,
        visible: false,
      },
      //表格数据
      roleList: [],
      //表格的高度
      tableHeight: 0,
      //查询参数
      parms: {
        pageSize: 10, //每页显示几条数据
        currentPage: 1, //当前第几页
        roleName: "",
        total: 0, //总条数
      },
    };
  },
  created() {
    this.getRoleList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 190;
    });
  },
  methods: {
    //删除按钮
    async deleteRole(row) {
      let confrim = await this.$myconfirm("确定删除该数据吗？");
      if (confrim) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //刷新列表
          this.getRoleList();
          this.$message.success(res.msg);
        }
      }
    },
    //编辑按钮
    editRole(row) {
      //清空表单
      this.$resetForm("addForm", this.addModule);
      //设置为编辑
      this.addModule.type = "1";
      //设置弹框属性
      this.dialog.title = "编辑角色";
      this.$objCoppy(row, this.addModule);
      this.dialog.visible = true;
    },
    //新增或编辑取消事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModule.type == "0") {
            res = await addRoleApi(this.addModule);
          } else {
            res = await editRoleApi(this.addModule);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getRoleList();
            this.dialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getRoleList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getRoleList();
    },
    //新增按钮
    addBtn() {
      //清空表单数据
      this.$resetForm("addForm", this.addModule);
      this.addModule.type = "0";
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.roleName = "";
      this.getRoleList();
    },
    //搜索按钮
    searchBtn() {
      this.getRoleList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        this.roleList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第19讲  权限管理接口开发讲解

###### 1、新建权限实体

```js
package com.itmk.web.menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

@Data
@TableName("sys_menu")
public class Menu implements Serializable {
    //主键
    @TableId(type = IdType.AUTO)
    private Long menuId;
    //上级菜单id
    private Long parentId;
    //菜单名称
    private String menuLabel;
    //权限字段
    private String menuCode;
    //路由名称
    private String name;
    //路由地址
    private String path;
    //组件路径
    private String url;
    //菜单类型 0：目录 1：菜单 2：按钮
    private String type;
    //图标
    private String icon;
    //备注
    private String remark;
    //上级菜单名称
    private String parentName;
    //序号
    private Integer orderNum;
    //不属于数据库表中的字段，需要排除
    @TableField(exist = false)
    private List<Menu> children = new ArrayList<>();
}

```

###### 2、新建mapper层

```js
package com.itmk.web.menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.menu.entity.Menu;

public interface MenuMapper extends BaseMapper<Menu> {
}
```

**新建mapper映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.menu.mapper.MenuMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.menu.entity.Menu;

import java.util.List;

public interface MenuService extends IService<Menu> {
    //获取菜单列表树数据
    List<Menu> getList();
    //查询上级菜单
    List<Menu> getParentList();
}

```

**新建service实现类**

```js
package com.itmk.web.menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.menu.entity.MakeMenuTree;
import com.itmk.web.menu.entity.Menu;
import com.itmk.web.menu.mapper.MenuMapper;
import com.itmk.web.menu.service.MenuService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class MenuServiceImpl extends ServiceImpl<MenuMapper, Menu> implements MenuService {
    @Override
    public List<Menu> getList() {
        //构造查询条件
        QueryWrapper<Menu> query = new QueryWrapper<>();
        query.lambda().orderByAsc(Menu::getName);
        List<Menu> menus = this.baseMapper.selectList(query);
        //组装成树数据
        List<Menu> menus1 = MakeMenuTree.makeTree(menus, 0L);
        return menus1;
    }

    @Override
    public List<Menu> getParentList() {
        //只查询目录和菜单 即只查询 0 和 1 的数据
        String[] types = {"0","1"};
        //构造查询条件
        QueryWrapper<Menu> query = new QueryWrapper<>();
        query.lambda().in(Menu::getType,types).orderByAsc(Menu::getOrderNum);
        List<Menu> menus = this.baseMapper.selectList(query);
        //构造顶级菜单
        Menu menu = new Menu();
        menu.setMenuId(0L);
        menu.setParentId(-1L);
        menu.setMenuLabel("顶级菜单");
        menus.add(menu);
        //构造菜单树
        List<Menu> menus1 = MakeMenuTree.makeTree(menus, -1L);
        return menus1;
    }
}

```

**新建构造树工具类**

```js
package com.itmk.web.menu.entity;

import org.springframework.beans.BeanUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * 生成树工具
 */
public class MakeMenuTree {
    public static List<Menu> makeTree(List<Menu> menuList, Long pid) {
        List<Menu> list = new ArrayList<>();
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item -> item != null && item.getParentId() == pid)
                .forEach(dom -> {
                    Menu menu = new Menu();
                    BeanUtils.copyProperties(dom, menu);
                    List<Menu> menus = makeTree(menuList, dom.getMenuId());
                    menu.setChildren(menus);
                    list.add(menu);
                });
        return list;
    }

}
```



###### 4、新建controller层

```js
package com.itmk.web.menu.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.menu.entity.Menu;
import com.itmk.web.menu.service.MenuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/menu")
public class MenuController {
    @Autowired
    private MenuService menuService;

    //树数据列表
    @GetMapping("/list")
    public ResultVo list(){
        List<Menu> list = menuService.getList();
        return ResultUtils.success("查询成功",list);
    }

    //新增菜单
    @PostMapping
    public ResultVo addMenu(@RequestBody Menu menu){
        boolean save = menuService.save(menu);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑菜单
    @PutMapping
    public ResultVo editMenu(@RequestBody Menu menu){
        boolean save = menuService.updateById(menu);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除菜单
    @DeleteMapping("/{menuId}")
    public ResultVo deleteMenu(@PathVariable("menuId") Long menuId){
        boolean b = menuService.removeById(menuId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //获取上级菜单
    @GetMapping("/parent")
    public ResultVo getParent(){
        List<Menu> parentList = menuService.getParentList();
        return ResultUtils.success("查询成功",parentList);
    }
}

```



#### 第20讲 权限新增页面制作

###### 1、在src/api下新建menu.js

```js
import http from '@/utils/http'
//新增菜单
export async function addMenuApi(parm){
    return await http.post("/api/menu",parm);
}

//获取菜单列表
export async function getMenuListApi(){
    return await http.get("/api/menu/list",null);
}
```

###### 2、sysMenuList.vue页面代码

```js
<template>
  <el-main>
    <!-- 顶部新增按钮 -->
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus" @click="addMenu"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          style="margin-left: 30px"
          :model="addModule"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-row>
            <el-col :span="24">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModule.type" size="small">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="parentName" label="上级菜单">
            <el-input v-model="addModule.parentName"></el-input>
          </el-form-item>
          <el-form-item prop="menuLabel" label="菜单名称">
            <el-input v-model="addModule.menuLabel"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type != '2'"
            prop="icon"
            label="菜单图标"
          >
            <el-input v-model="addModule.icon"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="name"
            label="路由名称"
          >
            <el-input v-model="addModule.name"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="path"
            label="路由地址"
          >
            <el-input v-model="addModule.path"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="url"
            label="组件路径"
          >
            <el-input v-model="addModule.url"></el-input>
          </el-form-item>
          <el-form-item prop="menuCode" label="权限字段">
            <el-input v-model="addModule.menuCode"></el-input>
          </el-form-item>
          <el-form-item label="权限备注">
            <el-input v-model="addModule.remark"></el-input>
          </el-form-item>
          <el-form-item label="权限序号">
            <el-input type="number" v-model="addModule.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMenuListApi, addMenuApi } from "@/api/menu";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        type: [
          {
            required: true,
            trigger: "change",
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            required: true,
            trigger: "change",
            message: "请选择上级菜单",
          },
        ],
        menuLabel: [
          {
            required: true,
            trigger: "change",
            message: "请填写菜单名称",
          },
        ],
        icon: [
          {
            required: true,
            trigger: "change",
            message: "请填写图标",
          },
        ],
        name: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            required: true,
            trigger: "change",
            message: "请填写组件路径",
          },
        ],
        menuCode: [
          {
            required: true,
            trigger: "change",
            message: "请填写权限字段",
          },
        ],
      },
      //新增或编辑数据绑定
      addModule: {
        editType: "",
        menuId: "",
        parentId: "",
        menuLabel: "",
        menuCode: "",
        name: "",
        path: "",
        url: "",
        type: "",
        icon: "",
        remark: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 310,
        width: 660,
        visible: false,
      },
    };
  },
  created() {
    this.getMenuList();
  },
  methods: {
    //新增或编辑弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate((valid) => {
        if (valid) {
          this.dialog.visible = false;
        }
      });
    },
    //新增或编辑弹框取消事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮
    addMenu() {
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    async getMenuList() {
      let res = await getMenuListApi();
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第21讲  阿里iconfont图标库使用

###### 1.进入官网

https://www.iconfont.cn/

###### 2.搜索找到你想要的图标

###### 3.加入购物车

###### 4.点击购物车，选择添加到项目

###### 5.登录你的gethub账户或者选择其他登录方式，选择添加到项目，没有项目新建项目

###### 6.选择font class，然后点击下载到本地（下载下来压缩包，解压）

###### 7.选择如下文件

![](D:\项目实战\物业管理系统\资料\images\icon图标.png)

###### 8.添加到项目的assets目录下的icon文件下

###### 9.在main.js中引入阿里图标

```css
import '../src/assets/icon/iconfont.css'
```

###### 10.使用图标

使用class挂载图标， 在iconfont 后面加上图标的名称

```js
<i class="iconfont icon-jia"/>
```



#### 第22讲  选择上级部门页面制作

###### 页面源码

```js
<template>
  <el-main>
    <!-- 顶部新增按钮 -->
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus" @click="addMenu"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          style="margin-left: 30px"
          :model="addModule"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-row>
            <el-col :span="24">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModule.type" size="small">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="parentName" label="上级菜单">
            <el-input
              @click.native="selectParent"
              v-model="addModule.parentName"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuLabel" label="菜单名称">
            <el-input v-model="addModule.menuLabel"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type != '2'"
            prop="icon"
            label="菜单图标"
          >
            <el-input v-model="addModule.icon"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="name"
            label="路由名称"
          >
            <el-input v-model="addModule.name"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="path"
            label="路由地址"
          >
            <el-input v-model="addModule.path"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="url"
            label="组件路径"
          >
            <el-input v-model="addModule.url"></el-input>
          </el-form-item>
          <el-form-item prop="menuCode" label="权限字段">
            <el-input v-model="addModule.menuCode"></el-input>
          </el-form-item>
          <el-form-item label="权限备注">
            <el-input v-model="addModule.remark"></el-input>
          </el-form-item>
          <el-form-item label="权限序号">
            <el-input type="number" v-model="addModule.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :height="parentDialog.height"
      :width="parentDialog.width"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentList"
          node-key="menuId"
          :props="parentProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          @node-click="treeClick"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，就是最好一层 -->
            <span v-if="data.children.length == 0">
              <i style="margin-right: 3px" class="el-icon-document" />
            </span>
            <!-- 有下级，需要判断是展开还是关闭 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-right: 3px"
                class="iconfont icon-jia"
              />
              <i v-else style="margin-right: 3px" class="iconfont icon-jian" />
            </span>
            <!-- 树节点的名称 -->
            <span>{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMenuListApi, getParentApi, addMenuApi } from "@/api/menu";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      selectNode:{
        menuId:'',
        menuName:''
      },
      //上级菜单树属性配置
      parentProps: {
        children: "children",
        label: "menuLabel",
      },
      //上级菜单数据
      parentList: [],
      //上级菜单弹框属性
      parentDialog: {
        title: "选择上级菜单",
        width: 300,
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            required: true,
            trigger: "change",
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            required: true,
            trigger: "change",
            message: "请选择上级菜单",
          },
        ],
        menuLabel: [
          {
            required: true,
            trigger: "change",
            message: "请填写菜单名称",
          },
        ],
        icon: [
          {
            required: true,
            trigger: "change",
            message: "请填写图标",
          },
        ],
        name: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            required: true,
            trigger: "change",
            message: "请填写组件路径",
          },
        ],
        menuCode: [
          {
            required: true,
            trigger: "change",
            message: "请填写权限字段",
          },
        ],
      },
      //新增或编辑数据绑定
      addModule: {
        editType: "",
        menuId: "",
        parentId: "",
        menuLabel: "",
        menuCode: "",
        name: "",
        path: "",
        url: "",
        type: "",
        icon: "",
        remark: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 310,
        width: 660,
        visible: false,
      },
    };
  },
  created() {
    this.getMenuList();
  },
  methods: {
    //树节点加号和减号的点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级菜单节点点击事件
    treeClick(node) {
      console.log(node);
      this.selectNode.menuId = node.menuId;
      this.selectNode.menuName = node.menuLabel;
    },
    //上级弹框确认
    parentConfirm() {
      this.addModule.parentId = this.selectNode.menuId;
      this.addModule.parentName = this.selectNode.menuName;
      this.parentDialog.visible = false;
    },
    //上级弹框关闭
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单
    async selectParent() {
      //获取上级菜单数据
      let res = await getParentApi();
      if (res && res.code == 200) {
        // console.log(res)
        this.parentList = res.data;
        console.log(this.parentList);
      }
      this.parentDialog.visible = true;
    },
    //新增或编辑弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate((valid) => {
        if (valid) {
          this.dialog.visible = false;
        }
      });
    },
    //新增或编辑弹框取消事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮
    addMenu() {
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    async getMenuList() {
      let res = await getMenuListApi();
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```



#### 第23讲 新增权限数据对接

###### 新增完整源码

```js
<template>
  <el-main>
    <!-- 顶部新增按钮 -->
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus" @click="addMenu"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          style="margin-left: 30px"
          :model="addModule"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-row>
            <el-col :span="24">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModule.type" size="small">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="parentName" label="上级菜单">
            <el-input
              @click.native="selectParent"
              v-model="addModule.parentName"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuLabel" label="菜单名称">
            <el-input v-model="addModule.menuLabel"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type != '2'"
            prop="icon"
            label="菜单图标"
          >
            <el-input v-model="addModule.icon"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="name"
            label="路由名称"
          >
            <el-input v-model="addModule.name"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="path"
            label="路由地址"
          >
            <el-input v-model="addModule.path"></el-input>
          </el-form-item>
          <el-form-item
            v-if="addModule.type == '1'"
            prop="url"
            label="组件路径"
          >
            <el-input v-model="addModule.url"></el-input>
          </el-form-item>
          <el-form-item prop="menuCode" label="权限字段">
            <el-input v-model="addModule.menuCode"></el-input>
          </el-form-item>
          <el-form-item label="权限备注">
            <el-input v-model="addModule.remark"></el-input>
          </el-form-item>
          <el-form-item label="权限序号">
            <el-input type="number" v-model="addModule.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :height="parentDialog.height"
      :width="parentDialog.width"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentList"
          node-key="menuId"
          :props="parentProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          @node-click="treeClick"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，就是最好一层 -->
            <span v-if="data.children.length == 0">
              <i style="margin-right: 3px" class="el-icon-document" />
            </span>
            <!-- 有下级，需要判断是展开还是关闭 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-right: 3px"
                class="iconfont icon-jia"
              />
              <i v-else style="margin-right: 3px" class="iconfont icon-jian" />
            </span>
            <!-- 树节点的名称 -->
            <span>{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMenuListApi, getParentApi, addMenuApi } from "@/api/menu";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      selectNode:{
        menuId:'',
        menuName:''
      },
      //上级菜单树属性配置
      parentProps: {
        children: "children",
        label: "menuLabel",
      },
      //上级菜单数据
      parentList: [],
      //上级菜单弹框属性
      parentDialog: {
        title: "选择上级菜单",
        width: 300,
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            required: true,
            trigger: "change",
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            required: true,
            trigger: "change",
            message: "请选择上级菜单",
          },
        ],
        menuLabel: [
          {
            required: true,
            trigger: "change",
            message: "请填写菜单名称",
          },
        ],
        icon: [
          {
            required: true,
            trigger: "change",
            message: "请填写图标",
          },
        ],
        name: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            required: true,
            trigger: "change",
            message: "请填写组件路径",
          },
        ],
        menuCode: [
          {
            required: true,
            trigger: "change",
            message: "请填写权限字段",
          },
        ],
      },
      //新增或编辑数据绑定
      addModule: {
        editType: "",
        menuId: "",
        parentId: "",
        menuLabel: "",
        menuCode: "",
        name: "",
        path: "",
        url: "",
        type: "",
        icon: "",
        remark: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 310,
        width: 660,
        visible: false,
      },
    };
  },
  created() {
    this.getMenuList();
  },
  methods: {
    //树节点加号和减号的点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级菜单节点点击事件
    treeClick(node) {
      console.log(node);
      this.selectNode.menuId = node.menuId;
      this.selectNode.menuName = node.menuLabel;
    },
    //上级弹框确认
    parentConfirm() {
      this.addModule.parentId = this.selectNode.menuId;
      this.addModule.parentName = this.selectNode.menuName;
      this.parentDialog.visible = false;
    },
    //上级弹框关闭
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单
    async selectParent() {
      //获取上级菜单数据
      let res = await getParentApi();
      if (res && res.code == 200) {
        // console.log(res)
        this.parentList = res.data;
        console.log(this.parentList);
      }
      this.parentDialog.visible = true;
    },
    //新增或编辑弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if(this.addModule.editType == '0'){
            res = await addMenuApi(this.addModule);
          }
          if(res && res.code == 200){
            this.dialog.visible = false;
            this.$message.success(res.msg)
            this.getMenuList();
          }
        }
      });
    },
    //新增或编辑弹框取消事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮
    addMenu() {
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
      this.addModule.editType = '0';
    },
    async getMenuList() {
      let res = await getMenuListApi();
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```



#### 第24讲 权限管理列表制作

###### 1、权限列表完整源码

```js
<template>
  <el-main>
    <!-- 新增按钮 -->
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus" @click="addMenu"
          >新增</el-button
        >
      </el-form-item>
      <!-- <i class="iconfont icon-jia"></i> -->
    </el-form>
    <el-table
      :height="tableHeight"
      :data="tableList"
      row-key="menuId"
      :tree-props="{ children: 'children' }"
      border
      stripe
      default-expand-all
    >
      <el-table-column prop="menuLabel" label="菜单名称"></el-table-column>
      <el-table-column prop="type" label="菜单类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="icon" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
      <el-table-column prop="url" label="组件路径"> </el-table-column>
      <el-table-column prop="menuCode" label="权限字段"> </el-table-column>
      <el-table-column align="center" width="200" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editMenu(scope.row)"
          >编辑</el-button>
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteMenu(scope.row)"
          >删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          style="margin-left: 40px"
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="normal"
        >
          <el-row>
            <el-col :span="24">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="parentName" label="上级菜单">
            <el-input
              @click.native="selectParent"
              v-model="addModel.parentName"
              placeholder="请选择上级菜单"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuLabel" label="菜单名称">
            <el-input
              v-model="addModel.menuLabel"
              placeholder="请填写菜单名称"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="菜单图标">
            <el-input
              v-model="addModel.icon"
              placeholder="请填写菜单图标"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item
            prop="name"
            v-if="addModel.type == '1'"
            label="路由名称"
          >
            <el-input
              v-model="addModel.name"
              placeholder="请填写路由名称"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item
            prop="path"
            v-if="addModel.type == '1'"
            label="路由地址"
          >
            <el-input
              v-model="addModel.path"
              placeholder="请填写路由地址"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="url" v-if="addModel.type == '1'" label="组件路径">
            <el-input
              v-model="addModel.url"
              placeholder="请填写组件路径"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuCode" label="权限字段">
            <el-input
              v-model="addModel.menuCode"
              placeholder="请填写权限字段"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="权限备注">
            <el-input
              v-model="addModel.remark"
              placeholder="请填写权限备注"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="权限序号">
            <el-input
              v-model="addModel.orderNum"
              placeholder="请填写权限序号"
              size="small"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 选择上级部门弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="onParentClose"
      @onConfirm="onParentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentList"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="nodeSelect"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，显示文档图标 -->
            <span v-if="data.children.length == 0">
              <i style="margin-left: 3px" class="el-icon-document"></i>
            </span>
            <!-- 有下级，判断是否展开 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-left: 3px"
                class="iconfont icon-jia"
              ></i>
              <i v-else style="margin-left: 3px" class="iconfont icon-jian"></i>
            </span>
            <span style="margin-left: 3px">{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMenuListApi, addMenuApi, getParentTreeApi } from "@/api/menu";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //上级菜单树属性配置
      defaultProps: {
        children: "children",
        label: "menuLabel",
      },
      //上级部门树数据
      parentList: [],
      //上级部门弹框属性
      parentDialog: {
        title: "选择上级部门",
        width: 300,
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            required: true,
            trigger: "change",
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            required: true,
            trigger: "change",
            message: "请选择上级菜单",
          },
        ],
        menuLabel: [
          {
            required: true,
            trigger: "change",
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            required: true,
            trigger: "change",
            message: "请填写组件路径",
          },
        ],
        menuCode: [
          {
            required: true,
            trigger: "change",
            message: "请填写权限字段",
          },
        ],
      },
      //新增或编辑绑定的数据
      addModel: {
        editType: "", //标识  0：新增 1：编辑
        menuId: "",
        parentId: "",
        menuLabel: "",
        menuCode: "",
        name: "",
        path: "",
        url: "",
        type: "",
        icon: "",
        remark: "",
        parentName: "",
        orderNum: "",
      },
      //新增或编辑弹框属性
      dialog: {
        title: "",
        width: 700,
        height: 380,
        visible: false,
      },
      //表格数据
      tableList: [],
      selectNode: {
        menuId: "",
        menuLabel: "",
      },
    };
  },
  created() {
    this.getMenuList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 180;
    });
  },
  methods: {
    //编辑按钮
    editMenu(row) {
      console.log(row);
    },
    deleteMenu(row) {
      console.log(row);
    },
    //上级部门节点加号和减号点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级树节点点击事件
    nodeSelect(node) {
      console.log(node);
      this.selectNode.menuId = node.menuId;
      this.selectNode.menuLabel = node.menuLabel;
    },
    //选择上级部门点击事件
    async selectParent() {
      //获取上班部门树数据
      let res = await getParentTreeApi();
      if (res && res.code == 200) {
        console.log(res);
        this.parentList = res.data;
      }
      this.parentDialog.visible = true;
    },
    //上级部门弹框确认事件
    onParentConfirm() {
      this.addModel.parentId = this.selectNode.menuId;
      this.addModel.parentName = this.selectNode.menuLabel;
      console.log(this.addModel);
      this.parentDialog.visible = false;
    },
    //上级部门弹框关闭事件
    onParentClose() {
      this.parentDialog.visible = false;
    },
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getMenuList();
            this.dialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //弹框新增或编辑关闭事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮
    addMenu() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      this.dialog.title = "新增菜单";
      this.addModel.editType = "0";
      this.dialog.visible = true;
    },
    //获取列表
    async getMenuList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```



#### 第25讲 权限管理编辑、删除接口对接

###### 1、api中的menu.js源码

```js
import http from '@/utils/http'
//获取权限列表
export async function getMenuListApi(){
    return await http.get("/api/menu/list",null)
}
//新增权限
export async function addMenuApi(parm){
    return await http.post("/api/menu",parm)
}
//获取上级部门树
export async function getParentTreeApi(){
    return await http.get("/api/menu/parent")
}
//编辑权限
export async function editMenuApi(parm){
    return await http.put("/api/menu",parm)
}
//删除权限
export async function deleteMenuApi(parm){
    return await http.delete("/api/menu",parm)
}
```



###### 2、页面完整源码

```js
<template>
  <el-main>
    <!-- 新增按钮 -->
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus" @click="addMenu"
          >新增</el-button
        >
      </el-form-item>
      <!-- <i class="iconfont icon-jia"></i> -->
    </el-form>
    <el-table
      :height="tableHeight"
      :data="tableList"
      row-key="menuId"
      :tree-props="{ children: 'children' }"
      border
      stripe
      default-expand-all
    >
      <el-table-column prop="menuLabel" label="菜单名称"></el-table-column>
      <el-table-column prop="type" label="菜单类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="icon" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
      <el-table-column prop="url" label="组件路径"> </el-table-column>
      <el-table-column prop="menuCode" label="权限字段"> </el-table-column>
      <el-table-column align="center" width="200" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editMenu(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteMenu(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>

    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          style="margin-left: 40px"
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="normal"
        >
          <el-row>
            <el-col :span="24">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="parentName" label="上级菜单">
            <el-input
              @click.native="selectParent"
              v-model="addModel.parentName"
              placeholder="请选择上级菜单"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuLabel" label="菜单名称">
            <el-input
              v-model="addModel.menuLabel"
              placeholder="请填写菜单名称"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="菜单图标">
            <el-input
              v-model="addModel.icon"
              placeholder="请填写菜单图标"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item
            prop="name"
            v-if="addModel.type == '1'"
            label="路由名称"
          >
            <el-input
              v-model="addModel.name"
              placeholder="请填写路由名称"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item
            prop="path"
            v-if="addModel.type == '1'"
            label="路由地址"
          >
            <el-input
              v-model="addModel.path"
              placeholder="请填写路由地址"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="url" v-if="addModel.type == '1'" label="组件路径">
            <el-input
              v-model="addModel.url"
              placeholder="请填写组件路径"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="menuCode" label="权限字段">
            <el-input
              v-model="addModel.menuCode"
              placeholder="请填写权限字段"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="权限备注">
            <el-input
              v-model="addModel.remark"
              placeholder="请填写权限备注"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item label="权限序号">
            <el-input
              v-model="addModel.orderNum"
              placeholder="请填写权限序号"
              size="small"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 选择上级部门弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="onParentClose"
      @onConfirm="onParentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentList"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="nodeSelect"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，显示文档图标 -->
            <span v-if="data.children.length == 0">
              <i style="margin-left: 3px" class="el-icon-document"></i>
            </span>
            <!-- 有下级，判断是否展开 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-left: 3px"
                class="iconfont icon-jia"
              ></i>
              <i v-else style="margin-left: 3px" class="iconfont icon-jian"></i>
            </span>
            <span style="margin-left: 3px">{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getMenuListApi,
  addMenuApi,
  getParentTreeApi,
  editMenuApi,
  deleteMenuApi,
} from "@/api/menu";
import SysDialog from "@/components/system/SysDialog";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //上级菜单树属性配置
      defaultProps: {
        children: "children",
        label: "menuLabel",
      },
      //上级部门树数据
      parentList: [],
      //上级部门弹框属性
      parentDialog: {
        title: "选择上级部门",
        width: 300,
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            required: true,
            trigger: "change",
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            required: true,
            trigger: "change",
            message: "请选择上级菜单",
          },
        ],
        menuLabel: [
          {
            required: true,
            trigger: "change",
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            required: true,
            trigger: "change",
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            required: true,
            trigger: "change",
            message: "请填写组件路径",
          },
        ],
        menuCode: [
          {
            required: true,
            trigger: "change",
            message: "请填写权限字段",
          },
        ],
      },
      //新增或编辑绑定的数据
      addModel: {
        editType: "", //标识  0：新增 1：编辑
        menuId: "",
        parentId: "",
        menuLabel: "",
        menuCode: "",
        name: "",
        path: "",
        url: "",
        type: "",
        icon: "",
        remark: "",
        parentName: "",
        orderNum: "",
      },
      //新增或编辑弹框属性
      dialog: {
        title: "",
        width: 700,
        height: 380,
        visible: false,
      },
      //表格数据
      tableList: [],
      selectNode: {
        menuId: "",
        menuLabel: "",
      },
    };
  },
  created() {
    this.getMenuList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 180;
    });
  },
  methods: {
    //编辑按钮
    editMenu(row) {
      console.log(row);
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //把当前编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑的标识
      this.addModel.editType = "1";
      //设置弹框属性
      this.dialog.title = "编辑菜单";
      this.dialog.visible = true;
    },
    async deleteMenu(row) {
      console.log(row);
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteMenuApi({ menuId: row.menuId });
        if(res && res.code == 200){
          //刷新表格
          this.getMenuList();
          this.$message.success(res.msg);
        }
      }
    },
    //上级部门节点加号和减号点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级树节点点击事件
    nodeSelect(node) {
      console.log(node);
      this.selectNode.menuId = node.menuId;
      this.selectNode.menuLabel = node.menuLabel;
    },
    //选择上级部门点击事件
    async selectParent() {
      //获取上班部门树数据
      let res = await getParentTreeApi();
      if (res && res.code == 200) {
        console.log(res);
        this.parentList = res.data;
      }
      this.parentDialog.visible = true;
    },
    //上级部门弹框确认事件
    onParentConfirm() {
      this.addModel.parentId = this.selectNode.menuId;
      this.addModel.parentName = this.selectNode.menuLabel;
      console.log(this.addModel);
      this.parentDialog.visible = false;
    },
    //上级部门弹框关闭事件
    onParentClose() {
      this.parentDialog.visible = false;
    },
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          } else {
            res = await editMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getMenuList();
            this.dialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //弹框新增或编辑关闭事件
    onClose() {
      this.dialog.visible = false;
    },
    //新增按钮
    addMenu() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      this.dialog.title = "新增菜单";
      this.addModel.editType = "0";
      this.dialog.visible = true;
    },
    //获取列表
    async getMenuList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```



#### 第26讲 登录页面制作

###### 1、效果展示

![](D:\项目实战\物业管理系统\资料\images\26-1.png)



###### 2、引入背景图片

在assets目录下新建images文件夹，把课程资料中，【项目图片】里面的图片login_bg.png复制到项目images里面



###### 3、登录页面完整代码

```js
<template>
  <div class="login-container">
    <!--
  size:用于控制该表单内组件的尺寸大小 有三个值 medium / small / mini
  rules:表单验证规则
  ref：类型于平时的 div 给定的 id
  model: 绑定数据
    -->
    <el-form
      size="medium"
      :rules="rules"
      ref="loginForm"
      :model="loginForm"
      class="loginForm"
    >
      <el-form-item label>
        <div class="login-title">小区物业系统</div>
      </el-form-item>
      <el-form-item prop="username" label>
        <el-input
          type="text"
          v-model="loginForm.username"
          placeholder="请输入用户名"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password" label>
        <el-input
          type="password"
          v-model="loginForm.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="loginForm.userType">
          <el-radio :label="0">业主</el-radio>
          <el-radio :label="1">物业</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item label>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-button @click="submit()" class="my-button" type="primary">登录</el-button>
          </el-col>
          <el-col :span="12">
            <el-button class="my-button">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>
<script>
export default {
  data() {
    return {
      imgSrc: "",
      loginForm: {
        username: "", //登录名
        password: "", //密码
        userType: "", //用户类型 0：业主 1：物业
      },
      rules: {
        username: [
          {
            required: true,
            trigger: "change",
            message: "请输入用户名",
          },
        ],
        password: [
          {
            required: true,
            trigger: "change",
            message: "请输入密码",
          },
        ],
        userType: [
          {
            required: true,
            trigger: "change",
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  created() {},
  methods: {
    async submit() {
      this.$refs.loginForm.validate((valid) => {
        if (valid) {
          this.$router.push("home");
        }
      });
    },
  },
};
</script>

<style lang="scss" scoped>
.login-container {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-image: url("../../assets/images/login_bg.png");
}

.loginForm {
  height: 350px;
  width: 450px;
  border-radius: 10px;
  box-shadow: 0 0 25px #cac6c6;
  padding: 20px 35px;
  background-color: #fff;
}
.login-title {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  font-weight: 600;
  color: #409eff;
}
.my-button {
  width: 100%;
}
</style>

```



#### 第27讲 登录接口编写

###### 1、编写接收和返回登录参数的类

```js
package com.itmk.web.user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class LoginParm implements Serializable {
    private String username;
    private String password;
    private String userType;
}

```

```js
package com.itmk.web.user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class LoginResult implements Serializable {
    private Long userId;
    private String token;
    private Long expireTime;
}

```

###### 2、在配置文件加入token配置

```js
#jwt配置
jwt:
  secret: com.itmk
  #30分钟过期
  expiration: 1800000
```



###### 3、编写token生成工具

```js
package com.itmk.config.jwt;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
@Data
@ConfigurationProperties(prefix = "jwt")
@Component
public class JwtUtils {
    //密钥
    private String secret;

    // 过期时间 毫秒
    private Long expiration;


    /**
     * 从数据声明生成令牌
     *
     * @param claims 数据声明
     * @return 令牌
     */
    private String generateToken(Map<String, Object> claims) {
        Date expirationDate = new Date(System.currentTimeMillis() + expiration);
        return Jwts.builder().setClaims(claims).setExpiration(expirationDate).signWith(SignatureAlgorithm.HS512, secret).compact();
    }

    /**
     * 从令牌中获取数据声明
     *
     * @param token 令牌
     * @return 数据声明
     */
    public Claims getClaimsFromToken(String token) {
        Claims claims;
        try {
            claims = Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();
        } catch (Exception e) {
            claims = null;
        }
        return claims;
    }

    /**
     * 生成令牌
     *
     * @param username 用户
     * @return 令牌
     */
    public String generateToken(String username) {
        Map<String, Object> claims = new HashMap<>(2);
        claims.put(Claims.SUBJECT,username);
        claims.put(Claims.ISSUED_AT, new Date());
        return generateToken(claims);
    }

    /**
     * 从令牌中获取用户名
     *
     * @param token 令牌
     * @return 用户名
     */
    public String getUsernameFromToken(String token) {
        String username;
        try {
            Claims claims = getClaimsFromToken(token);
            username = claims.getSubject();
        } catch (Exception e) {
            username = null;
        }
        return username;
    }

    /**
     * 判断令牌是否过期
     *
     * @param token 令牌
     * @return 是否过期
     */
    public Boolean isTokenExpired(String token) {
        Claims claims = getClaimsFromToken(token);
        Date expiration = claims.getExpiration();
        return expiration.before(new Date());
    }

    /**
     * 刷新令牌
     *
     * @param token 原令牌
     * @return 新令牌
     */
    public String refreshToken(String token) {
        String refreshedToken;
        try {
            Claims claims = getClaimsFromToken(token);
            claims.put(Claims.ISSUED_AT, new Date());
            refreshedToken = generateToken(claims);
        } catch (Exception e) {
            refreshedToken = null;
        }
        return refreshedToken;
    }

    /**
     * 验证令牌
     *
     * @param token       令牌
     * @param username 用户名
     * @return 是否有效
     */
    public Boolean validateToken(String token, String username) {
        String tokenUsername = getUsernameFromToken(token);
        return (username.equals(tokenUsername) && !isTokenExpired(token));
    }
    
    /**
     * 获取token过期时间
     * @param token
     * @param secret
     * @return
     */
    public Long getExpireTime(String token,String secret){
        Long expireTime =  Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody().getExpiration().getTime();
        return expireTime;
    }
}
```



###### 4、编写登录方法

在UserController里面注入 JwtUtils

```js
@Autowired
private JwtUtils jwtUtils;
```

```js
/**
     *  用户登录
     * @param parm
     * @return
     */
    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm){
        if(StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())){
            return ResultUtils.error("用户名、密码或用户类型不能为空!");
        }
        //查询用户信息
        String password = DigestUtils.md5DigestAsHex(parm.getPassword().getBytes());
        QueryWrapper<User> query = new QueryWrapper<>();
        query.lambda().eq(User::getUserName,parm.getUsername())
                .eq(User::getPassword,password);
        User one = userService.getOne(query);
        if(one == null){
            return ResultUtils.error("用户名、密码或用户类型错误!");
        }
        //如果用户存在，生成token返回给前端
        String token = jwtUtils.generateToken(one.getUserName());
        //获取生成的token的过期时间
       Long expireTime =  jwtUtils.getExpireTime(token,jwtUtils.getSecret());
        LoginResult result = new LoginResult();
        result.setUserId(one.getUserId());
        result.setToken(token);
        result.setExpireTime(expireTime);
        return ResultUtils.success("登录成功",result);
    }
```



#### 第28讲 用户登录接口对接

**vue-admin-template登录流程图**

![](D:\项目实战\物业管理系统\资料\images\登录流程讲解.png)



###### 1、在src/api/user.js中修改login()方法

把原来的登录方法注释，改为如下所示

```js
//员工登录
export async function login(parm){
  return await http.post("/api/user/login",parm)
}
```

###### 2、在src/store/modules/user.js中的login()方法修改为如下

```js
// user login
  login({ commit }, userInfo) {
    const { username, password,userType } = userInfo
    return new Promise((resolve, reject) => {
      login({ username: username.trim(), password: password,userType:userType }).then(response => {
        console.log(response)
        const { data } = response
        console.log(data)
        commit('SET_TOKEN', data.token)
        setToken(data.token)
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```

###### 3、登录页面修改为如下

```js
<template>
  <div class="login-container">
    <!--
  size:用于控制该表单内组件的尺寸大小 有三个值 medium / small / mini
  rules:表单验证规则
  ref：类型于平时的 div 给定的 id
  model: 绑定数据
    -->
    <el-form
      size="medium"
      :rules="rules"
      ref="loginForm"
      :model="loginForm"
      class="loginForm"
    >
      <el-form-item label>
        <div class="login-title">小区物业系统</div>
      </el-form-item>
      <el-form-item prop="username" label>
        <el-input
          type="text"
          v-model="loginForm.username"
          placeholder="请输入用户名"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password" label>
        <el-input
          type="password"
          v-model="loginForm.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="loginForm.userType">
          <el-radio :label="0">业主</el-radio>
          <el-radio :label="1">物业</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item label>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-button @click="submit()" class="my-button" type="primary">登录</el-button>
          </el-col>
          <el-col :span="12">
            <el-button class="my-button">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>
<script>
import { loginApi } from "@/api/user";
export default {
  data() {
    return {
      imgSrc: "",
      loginForm: {
        username: "", //登录名
        password: "", //密码
        userType: "", //用户类型 0：业主 1：物业
      },
      rules: {
        username: [
          {
            required: true,
            trigger: "change",
            message: "请输入用户名",
          },
        ],
        password: [
          {
            required: true,
            trigger: "change",
            message: "请输入密码",
          },
        ],
        userType: [
          {
            required: true,
            trigger: "change",
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  created() {},
  methods: {
    async submit() {
      this.$refs.loginForm.validate(async (valid) => {
        if (valid) {
          this.loading = true;
          this.$store
            .dispatch("user/login", this.loginForm)
            .then(() => {
              this.$router.push({ path: this.redirect || "/" });
              this.loading = false;
            })
            .catch(() => {
              this.loading = false;
            });
        }
      });
    },
  },
};
</script>

<style lang="scss" scoped>
.login-container {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-image: url("../../assets/images/login_bg.png");
}

.loginForm {
  height: 350px;
  width: 450px;
  border-radius: 10px;
  box-shadow: 0 0 25px #cac6c6;
  padding: 20px 35px;
  background-color: #fff;
}
.login-title {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  font-weight: 600;
  color: #409eff;
}
.my-button {
  width: 100%;
}
</style>

```



#### 第29讲 获取用户信息

**权限验证流程图**

![](D:\项目实战\物业管理系统\资料\images\权限验证流程图.png)



###### 1、用户信息的数据格式

参照vue-admin-template中的mock.js，用户信息的格式如下所示

```js
const users = {
  'admin-token': {
    roles: ['admin'],
    introduction: 'I am a super administrator',
    avatar: 'https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif',
    name: 'Super Admin'
  },
  'editor-token': {
    roles: ['editor'],
    introduction: 'I am an editor',
    avatar: 'https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif',
    name: 'Normal Editor'
  }
}
```

综上所示，最终后端返回的用户信息格式如下

```js
{
    roles: ['admin'],
    introduction: 'I am a super administrator',
    avatar: 'https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif',
    name: 'Super Admin'
}
```



###### 2、后端新建UserInfo实体

在user的实体包中新建UserInfo实体，如下所示

```js
package com.itmk.web.user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class UserInfo implements Serializable {
    private Long id;
    //用户名
    private String name;
    //头像
    private String avatar;
    //介绍
    private String introduction;
    //权限集合
    private Object[] roles;
}
```



###### 3、新增获取用户信息的方法

在UserController控制器中添加getInfo()方法

```js
 /**
     * 获取用户信息
     */
    @GetMapping("/getInfo")
    public ResultVo getInfo(User user){
        User user1 = userService.getById(user.getUserId());
        UserInfo userInfo = new UserInfo();
        userInfo.setId(user1.getUserId());
        userInfo.setName(user1.getUserName());
        userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
        return ResultUtils.success("获取用户信息成功",userInfo);
    }
```



###### 4、前端添加保存用户id的方法

在src/utils下的auth.js中添加如下所示代码

```js

//设置用户id的key
const userIdKey = 'userId';
//保存用户id
export function setUserId(value){
  return Cookies.set(userIdKey,value);
}
//获取用户id
export function getUserId(){
  return Cookies.get(userIdKey)
}
//清空用户id
export function removeUserId(){
  return Cookies.remove(userIdKey);
}
```



###### 5、在src/store/modules/user.js里面保存用户id

```js
import { login, logout, getInfo } from '@/api/user'


login({ commit }, userInfo) {
    //解构出用户信息
    const { username, password,userType } = userInfo
    return new Promise((resolve, reject) => {
      //调用api/user中的login方法
      login({ username: username.trim(), password: password ,userType:userType}).then(response => {
        const { data } = response
        commit('SET_TOKEN', data.token)
        setToken(data.token)
        //保存用户id到cookies
        setUserId(data.userId);
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```



#### 第30讲 角色权限保存接口开发

###### 1、新建角色权限实体

```java
package com.itmk.web.role_menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
@Data
@TableName("sys_role_menu")
public class RoleMenu implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long roleMenuId;
    private Long roleId;
    private Long menuId;
}
```

###### 2、新建mapper层接口

```java
package com.itmk.web.role_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.role_menu.entity.RoleMenu;

public interface RoleMenuMapper extends BaseMapper<RoleMenu> {
}

```

###### 3、新建mapper层映射文件

```java
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.role_menu.mapper.RoleMenuMapper">
    <insert id="saveRoleMenu" >
        insert into sys_role_menu(role_id,menu_id) values 
        <foreach collection="menuIds" item="item" index="index" separator=",">
            (#{roleId},#{item})
        </foreach>
    </insert>
</mapper>
```

###### 4、新建service层

```js
package com.itmk.web.role_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.role_menu.entity.RoleMenu;

public interface RoleMenuService extends IService<RoleMenu> {
    //保存权限
    void saveRoleMenu(Long roleId, List<Long> menuIds);
}
```

**实现service**

```js
package com.itmk.web.role_menu.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.role_menu.entity.RoleMenu;
import com.itmk.web.role_menu.mapper.RoleMenuMapper;
import com.itmk.web.role_menu.service.RoleMenuService;
import org.springframework.stereotype.Service;

@Service
public class RoleMenuServiceImpl extends ServiceImpl<RoleMenuMapper, RoleMenu> implements RoleMenuService {
    @Override
    public void saveRoleMenu(Long roleId, List<Long> menuIds) {
        this.baseMapper.saveRoleMenu(roleId,menuIds);
    }
}
```



#### 第31讲  分配权限接口开发

###### 1、新建RoleParm类

```js
package com.itmk.web.role.entity;

import lombok.Data;

@Data
public class RoleAssignParm {
    //用户id
    private Long userId;
    //角色id
    private Long roleId;
}
```

2、新建RolePermissionVo类

```js
package com.itmk.web.role.entity;

import com.itmk.web.menu.entity.Menu;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
public class RolePermissionVo {
    //当前登录系统用户的菜单数据
    List<Menu> listmenu = new ArrayList<>();
    //原来分配的菜单
    private Object[] checkList;
}
```

###### 3、在菜单服务接口MenuService中添加方法

权限树的回显，需要根据用户id查询权限和角色id查询权限

```js
//根据用户id查询权限列表
    List<Menu> getMenuListByUserId(Long userId);
    //根据角色id查询权限信息
    List<Menu> getMenuListByRoleId(Long roleId);
```

###### 4、实现接口中的方法

```js
@Override
    public List<Menu> getMenuListByUserId(Long userId) {
        return this.baseMapper.getMenuListByUserId(userId);
    }

    @Override
    public List<Menu> getMenuListByRoleId(Long roleId) {
        return this.baseMapper.getMenuListByRoleId(roleId);
    }
```

###### 5、mapper层添加方法

```js
//根据用户id查询权限列表
    List<Menu> getMenuListByUserId(@Param("userId") Long userId);
    //根据角色id查询权限信息
    List<Menu> getMenuListByRoleId(@Param("roleId") Long roleId);
```

###### 6、添加映射的sql

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.menu.mapper.MenuMapper">
    <select id="getMenuListByUserId" parameterType="long" resultType="com.itmk.web.menu.entity.Menu">
        select m.menu_id,m.parent_id,m.`name`,m.menu_label,m.menu_code,m.url,
        m.type,m.icon,m.remark,m.path,m.order_num
        from sys_user as u
        left join sys_user_role  as ur on u.user_id = ur.user_id
        left join sys_role  as r on r.role_id = ur.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu as m on m.menu_id = rm.menu_id
        where u.user_id =#{userId}
    </select>

    <select id="getMenuListByRoleId" parameterType="long" resultType="com.itmk.web.menu.entity.Menu">
        select m.* from sys_role_menu as rm ,sys_menu as m
        where rm.menu_id = m.menu_id  and rm.role_id =#{roleId}
    </select>
</mapper>
```

###### 7、RoleService添加回显查询方法

```js
 //分配权限树数据回显查询
    RolePermissionVo getAssignTree(RoleAssignParm parm);
```

###### 8、回显查询实现

```js
@Override
    public RolePermissionVo getAssignTree(RoleAssignParm parm) {
        //根据用户id查询当前用户信息
        User user = userService.getById(parm.getUserId());
        //查询当前用户的所有权限信息,如果是超级管理员，全部权限
        List<Menu> menuList = null;
        if(user.getIsAdmin().equals("1")){ //如果是超级管理员
            menuList = menuService.list();
        }else{ //不是超级管理员，根据用户id查询权限信息
            menuList =   menuService.getMenuListByUserId(parm.getUserId());
        }
        //组装树
        List<Menu> menus = MakeMenuTree.makeTree(menuList, 0L);

        //根据角色id查询角色原来的权限信息
        List<Long> ids = new ArrayList<>();
        List<Menu> listByRoleId = menuService.getMenuListByRoleId(parm.getRoleId());
        Optional.ofNullable(menuList).orElse(new ArrayList<>()).stream().filter(item -> item !=null).forEach(item ->{
            Optional.ofNullable(listByRoleId).orElse(new ArrayList<>()).stream().filter(dom -> dom != null).forEach(dom ->{
                if(item.getMenuId().equals(dom.getMenuId())){
                    ids.add(dom.getMenuId());
                    return;
                }
            });
        });
        RolePermissionVo vo = new RolePermissionVo();
        vo.setListmenu(menus);
        vo.setCheckList(ids.toArray());
        return vo;
    }
```



###### 9、权限树控制器回显

```js
//权限树回显查询
    @GetMapping("/getAssignPermissionTree")
    public ResultVo getAssignMenuTree(RoleAssignParm roleParm){
        RolePermissionVo assignMenuTree = roleService.getAssignTree(roleParm);
        return ResultUtils.success("查询成功",assignMenuTree);
    }
```

###### 10、新增接受保存的类

```js
package com.itmk.web.role.entity;

import lombok.Data;

import java.util.List;

@Data
public class RolePermissionParm {
    private Long roleId;
    List<Long> list;
}
```

###### 11、角色RoleService层添加如下方法

```js
 //分配权限保存
    void saveAssignRole(Long roleId, List<Long> ids);
```

###### 12、实现上面的方法

```js
	@Override
    @Transactional
    public void saveAssignRole(Long roleId, List<Long> ids) {
        //保存权限之前，需要 把原来的权限删除
        QueryWrapper<RoleMenu> query = new QueryWrapper<>();
        query.lambda().eq(RoleMenu::getRoleId,roleId);
        roleMenuService.remove(query);
        //保存新的权限
        roleMenuService.saveRoleMenu(roleId,ids);
    }
```

###### 13、保存权限的控制器

在RoleController中添加如下方法

```js
	//分配权限保存
    @PostMapping("/saveAssignRole")
    public ResultVo saveAssignRole(@RequestBody RolePermissionParm parm){
        roleService.saveAssignRole(parm.getRoleId(),parm.getList());
        return ResultUtils.success("分配权限成功!");
    }
```









#### 第32讲 角色分配权限页面制作

###### 1、在api/role.js里面添加如下方法

```js
//分配角色回显查询
export async function getAssignTreeApi(parm){
    return await http.get("/api/role/getAssignTree",parm)
}
//保存权限
export async function assignSaveApi(parm){
    return await http.post("/api/role/saveAssign",parm)
}
```



###### 2、新增【分配权限】按钮

找到src/view/system下的sysRoleList.vue页面，在表格的操作栏中添加一个【分配权限】的按钮

```js
<el-table-column align="center" width="290" label="操作">
        <template slot-scope="scope">
          <el-button type="primary"  icon="el-icon-edit" size="small" @click="editBtn(scope.row)">编辑</el-button>
          <el-button type="primary"  icon="el-icon-edit" size="small" @click="assignRoleBtn(scope.row)">分配权限</el-button>
          <el-button type="danger" icon="el-icon-delete" size="small" @click="deleteBtn(scope.row)">删除</el-button>
        </template>
      </el-table-column><el-button type="primary"  icon="el-icon-edit" size="small" @click="assignRoleBtn(scope.row)">分配权限</el-button>
```

###### 3、定义assignRoleBtn()方法

```js
 	//分配权限按钮
    async assignRoleBtn(row) {
      this.assignTreeData = [];
      this.assignTreeChecked = [];
      this.roleId = row.roleId;
      //设置弹框属性
      this.assignDialog.title = "为【" + row.roleName + "】分配权限";
      this.assignDialog.visible = true;
      let parm = {
        userId: getUserId(),
        roleId: row.roleId,
      };
      let res = await getAssignTreeApi(parm);
      if (res && res.code == 200) {
        console.log(res);
        this.assignTreeData = res.data.listmenu;
        this.assignTreeChecked = res.data.checkList;
        console.log(this.assignTreeChecked);
      }
      if (this.assignTreeChecked.length > 0) {
        let newArr = [];
        this.assignTreeChecked.forEach((item) => {
          this.checked(item, this.assignTreeData, newArr);
        });
        this.assignTreeChecked = newArr;
        console.log(newArr)
      }
    },
    checked(id, data, newArr) {
      data.forEach((item) => {
        if (item.menuId == id) {
          if (item.children && item.children.length == 0) {
            newArr.push(item.menuId);
          }
        } else {
          if (item.children != null && item.children.length != 0) {
            this.checked(id, item.children, newArr);
          }
        }
      });
    },
```

###### 4、分配权限弹框

```js
<!-- 分配权限弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :height="assignDialog.height"
      :width="assignDialog.width"
      :visible="assignDialog.visible"
      @onClose="assignClose"
      @onConfirm="assignConfirm"
    >
      <template slot="content">
        <span>
          <el-tree
            ref="assignTree"
            default-expand-all
            :default-checked-keys="assignTreeChecked"
            :data="assignTreeData"
            node-key="menuId"
            :props="defaultProps"
            empty-text=""
            :show-checkbox="true"
          ></el-tree>
        </span>
      </template>
    </sys-dialog>
```

###### 5、分配权限确定按钮

```js
	  async assignConfirm() {
      let ids = this.$refs.assignTree
        .getCheckedKeys()
        .concat(this.$refs.assignTree.getHalfCheckedKeys());
      console.log(ids);
      if (ids.length == 0) {
        this.$message.warning("请勾选权限！");
        return;
      }
      let parm = {
        roleId: this.roleId,
        list: ids,
      };
      let res = await assignSaveApi(parm);
      if (res && res.code == 200) {
        this.assignDialog.visible = false;
        this.$message.success(res.msg);
      }
    },
```



#### 第33讲  用户分配角色接口开发

###### 1、创建用户角色实体

新建com.itmk.web.user_role.entity包，然后新建如下实体

```js
package com.itmk.web.user_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

@Data
@TableName("sys_user_role")
public class UserRole implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long userRoleId;
    private Long userId;
    private Long roleId;
}

```



###### 2、创建用户角色mapper层

新建com.itmk.web.user_role.mapper包，然后新建如下接口

```js
package com.itmk.web.user_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.user_role.entity.UserRole;

public interface UserRoleMapper extends BaseMapper<UserRole> {
}


```

###### 3、新建UserRoleMapper映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.user_role.mapper.UserRoleMapper">

</mapper>
```



###### 4、在用户的UserService层新建如下方法

新增getRoleByUserId()和saveRole()两个方法

```js
package com.itmk.web.user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.entity.UserParm;
import com.itmk.web.user_role.entity.UserRole;

public interface UserService extends IService<User> {
    //查询用户列表
    IPage<User> list(UserParm parm);
    //根据用户id查询角色id
    UserRole getRoleByUserId(UserRole userRole);
    //分配角色保存
    void saveRole(UserRole userRole);
}

```

###### 4、实现上面的方法

在UserServiceImpl类中实现上面的两个方法

```js
    @Override
    public UserRole getRoleByUserId(UserRole userRole) {
        QueryWrapper<UserRole> query = new QueryWrapper<>();
        query.lambda().eq(UserRole::getUserId,userRole.getUserId());
        return userRoleMapper.selectOne(query);
    }

    @Override
    @Transactional
    public void saveRole(UserRole userRole) {
        //删除原来的角色
        QueryWrapper<UserRole> query = new QueryWrapper<>();
        query.lambda().eq(UserRole::getUserId,userRole.getUserId());
        userRoleMapper.delete(query);
        //保存新的角色
        userRoleMapper.insert(userRole);
    }
```

###### 5、在UserController控制器添加如下方法

```js
	//根据用户id查询角色id
    @GetMapping("/getRoleByUserId")
    public ResultVo getRoleByUserId(UserRole userRole){
        UserRole userRole1 = userService.getRoleByUserId(userRole);
        return ResultUtils.success("查询成功",userRole1);
    }

    //分配角色保存
    @PostMapping("/saveRole")
    public ResultVo saveRole(@RequestBody UserRole userRole){
        userService.saveRole(userRole);
        return ResultUtils.success("分配角色成功!");
    }
```



#### 第34讲 用户分配角色页面制作与接口对接

###### 1、在src/api/user.js添加如下方法

```js
//根据用户id查询角色id
export async function getRoleByUserId(parm){
  return await http.get("/api/user/getRoleByUserId",parm);
}
//分配角色保存
export async function assignSave(parm){
  return await http.post("/api/user/saveRole",parm)
}
```

###### 2、用户表格操作栏更改为如下

宽度改为290，并添加 【分配角色】按钮

```js
	<el-table-column align="center" width="290" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editUser(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="assignRole(scope.row)"
            >分配角色</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteUser(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
```

###### 3、在data中添加如下属性

```js
	//分配角色保存参数
      assignParm:{
        roleId:'',
        userId:''
      },
      radio:'',
      //角色列表高度
      roleHeight:0,
      //角色列表
      roleList:[],
      //角色列表分页
      roleParm:{
        pageSize:10,
        currentPage:1,
        total:0
      },
      //分配角色弹框
      roleDialog: {
        title: "",
        height: 400,
        width: 800,
        visible: false,
      },
```

###### 4、在methods中添加如下方法

```js
 	//角色选中事件
    getCurrentRow(row){
       this.assignParm.roleId = row.roleId
      console.log(row)
    },
    //页数改变
    roleCurrentChange(val){
      this.roleParm.currentPage = val;
      this.getRoleList();
    },
    //页容量改变触发
    roleSizeChange(val){
      this.roleParm.pageSize = val;
      this.getRoleList();
    },
    //分配角色按钮
    async assignRole(row) {
      this.radio = ''
      this.assignParm.userId = row.userId;
      //设置弹框属性
      this.roleDialog.title = '为【'+row.userName+'】分配角色';
      this.roleDialog.visible = true;
      //查询角色列表
      await this.getRoleList();
      this.$nextTick(()=>{
        this.roleHeight = window.innerHeight-620
      })
      //角色回显
      let res = await getRoleByUserId({userId:row.userId});
      if(res && res.code == 200){
        this.radio = res.data.roleId;
        console.log(res)
      }
    },
    async getRoleList(){
      let res = await getRoleListApi(this.roleParm);
      if(res.code == 200){
        this.roleList = res.data.records;
        this.roleParm.total = res.data.total;
      }
    },
    //分配角色确认
    async roleConfirm() {
      if(!this.radio){
        this.$message.warning('请选择角色!');
        return;
      }
      let res = await assignSave(this.assignParm);
      if(res && res.code == 200){
        this.$message.success(res.msg);
        this.roleDialog.visible = false;
      }
    },
    //分配角色取消
    roleClose() {
      this.roleDialog.visible = false;
    },
```

###### 5、编写分配角色弹框页面

```js
<!-- 分配角色弹框 -->
    <sys-dialog
      :title="roleDialog.title"
      :height="roleDialog.height"
      :width="roleDialog.width"
      :visible="roleDialog.visible"
      @onClose="roleClose"
      @onConfirm="roleConfirm"
    >
      <template slot="content">
        <el-table :height="roleHeight" :data="roleList" border stripe>
          <el-table-column width="50" align="center" label="选择">
            <template slot-scope="scope">
              <el-radio v-model="radio" :label="scope.row.roleId" @change="getCurrentRow(scope.row)">
                {{""}}
              </el-radio>
              
            </template>
          </el-table-column>
          <el-table-column prop="roleName" label="角色名称"></el-table-column>
          <el-table-column prop="remark" label="角色备注"></el-table-column>
        </el-table>
        <el-pagination
          @size-change="roleSizeChange"
          @current-change="roleCurrentChange"
          :current-page.sync="roleParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="roleParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="roleParm.total"
          background
        >
        </el-pagination>
      </template>
    </sys-dialog>
```





#### 第35讲 房屋管理数据库设计





#### 第36讲 楼栋管理接口开发

###### 1、新建实体

```js
package com.itmk.web.house_building.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

@Data
@TableName("house_building")
public class HouseBuilding implements Serializable {
    @TableId(type= IdType.AUTO)
    private Long buildId;
    private String type;
    private String name;
    private Long orderNum;
}

```

**列表参接受实体**

```js
package com.itmk.web.house_building.entity;

import lombok.Data;

@Data
public class BuildingParm {
    //页容量
    private Long pageSize;
    //当前页
    private Long currentPage;
    //楼栋名称
    private String name;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.house_building.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.house_building.entity.HouseBuilding;

public interface HouseBuildingMapper extends BaseMapper<HouseBuilding> {
}

```

**mapper映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.house_building.mapper.HouseBuildingMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.house_building.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.house_building.entity.BuildingParm;
import com.itmk.web.house_building.entity.HouseBuilding;

public interface HouseBuildingService extends IService<HouseBuilding> {
    IPage<HouseBuilding> getList(BuildingParm parm);
}

```

**实现类**

```js
package com.itmk.web.house_building.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.house_building.entity.BuildingParm;
import com.itmk.web.house_building.entity.HouseBuilding;
import com.itmk.web.house_building.mapper.HouseBuildingMapper;
import com.itmk.web.house_building.service.HouseBuildingService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class HouseBuildingServiceImpl extends ServiceImpl<HouseBuildingMapper, HouseBuilding> implements HouseBuildingService {
    @Override
    public IPage<HouseBuilding> getList(BuildingParm parm) {
        //构造查询条件
        QueryWrapper<HouseBuilding> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getName())){
            query.lambda().like(HouseBuilding::getName,parm.getName());
        }
		 query.lambda().orderByAsc(HouseBuilding::getOrderNum);
        //构造分页对象
        IPage<HouseBuilding> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());

        return this.baseMapper.selectPage(page,query);
    }
}


```



###### 4、新建控制器

```js
package com.itmk.web.house_building.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.house_building.entity.BuildingParm;
import com.itmk.web.house_building.entity.HouseBuilding;
import com.itmk.web.house_building.service.HouseBuildingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 楼栋控制器
 */
@RestController
@RequestMapping("/api/houseBuild")
public class HouseBuildingController {
    @Autowired
    private HouseBuildingService houseBuildingService;

    //查询列表
    @GetMapping("/list")
    public ResultVo list(BuildingParm parm){
        IPage<HouseBuilding> list = houseBuildingService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }

    //新增
    @PostMapping
    public ResultVo add(@RequestBody HouseBuilding houseBuilding){
        boolean b = houseBuildingService.save(houseBuilding);
        if(b){
            return ResultUtils.success("新增楼栋成功!");
        }
        return ResultUtils.error("新增楼栋失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody HouseBuilding houseBuilding){
        boolean b = houseBuildingService.updateById(houseBuilding);
        if(b){
            return ResultUtils.success("编辑楼栋成功!");
        }
        return ResultUtils.error("编辑楼栋失败!");
    }

    //删除
     @DeleteMapping("/{buildId}")
    public ResultVo delete(@PathVariable("buildId") Long buildId){
        boolean b = houseBuildingService.removeById(buildId);
        if(b){
            return ResultUtils.success("删除楼栋成功!");
        }
        return ResultUtils.error("删除楼栋失败!");
    }
}

```



#### 第37讲 楼栋列表页面制作与数据对接

###### 1、新建api请求文件

在src/api下新建 houseBuilding.js文件

```js
import http from '@/utils/http'
//查询列表
export async function getListApi(parm){
    return await http.get("/api/houseBuild/list",parm)
}
```

###### 2、新建页面

在view下新建house文件夹，并建 houseBuilding.vue页面，并添加到路由里面

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'

/**
 * Note: sub-menu only appear when route children.length >= 1
 * Detail see: https://panjiachen.github.io/vue-element-admin-site/guide/essentials/router-and-nav.html
 *
 * hidden: true                   if set true, item will not show in the sidebar(default is false)
 * alwaysShow: true               if set true, will always show the root menu
 *                                if not set alwaysShow, when item has more than one children route,
 *                                it will becomes nested mode, otherwise not show the root menu
 * redirect: noRedirect           if set noRedirect will no redirect in the breadcrumb
 * name:'router-name'             the name is used by <keep-alive> (must set!!!)
 * meta : {
    roles: ['admin','editor']    control the page roles (you can set multiple roles)
    title: 'title'               the name show in sidebar and breadcrumb (recommend set)
    icon: 'svg-name'/'el-icon-x' the icon show in the sidebar
    breadcrumb: false            if set false, the item will hidden in breadcrumb(default is true)
    activeMenu: '/example/list'  if set path, the sidebar will highlight the path you set
  }
 */

/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  },
  {
    path: '/system',
    component: Layout,
    name: 'system',
    alwaysShow: true,
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '员工管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '权限管理', icon: 'tree' }
      }
    ]
  },
  {
    path: '/sysHouse',
    component: Layout,
    alwaysShow: true,
    name: 'sysHouse',
    meta: { title: '房屋管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/houseBuilding',
        name: 'houseBuilding',
        component: () => import('@/views/house/houseBuilding'),
        meta: { title: '栋数管理', icon: 'table' }
      },
      {
        path: '/unitList',
        name: 'unitList',
        component: () => import('@/views/house/unitList'),
        meta: { title: '单元管理', icon: 'table' }
      },
      {
        path: '/houseList',
        name: 'houseList',
        component: () => import('@/views/house/houseList'),
        meta: { title: '房屋管理', icon: 'table' }
      }
    ]
  },
  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router


```

**页面内容**

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parm"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parm.name"></el-input>
      </el-form-item>
      <el-form-item label="栋数类型">
        <el-select v-model="parm.type" placeholder="" clearable filterable>
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button @click="cancelBtn" style="color: #ff7670" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="type" label="栋数类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'" type="success" size="small">普通房</el-tag>
          <el-tag v-if="scope.row.type == '1'" type="danger" size="small">电梯房</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            @click="editBtn(scope.row)"
            size="small"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="dangerd"
            @click="deleteBtn(scope.row)"
            size="small"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/building";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      options: [
        {
          value: "0",
          label: "普通房",
        },
        {
          value: "1",
          label: "电梯房",
        },
      ],
      //存放列表的数据
      tableList: [],
      //获取列表的参数
      parm: {
        name: "",
        type: "",
        pageSize: 10,
        currentPage: 1,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //重置按钮
    cancelBtn() {
      this.parm.name = "";
      this.parm.type = "";
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {},
    //页数改变时触发
    currentChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //搜索按钮
    searchBtn() {
      console.log(this.parm);
    },
    async getList() {
      let res = await getListApi(this.parm);
      console.log(res);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第38讲 楼栋新增页面制作与接口对接

###### 1、在api/houseBuilding.js添加如下方法

```js
import http from '@/utils/http'
//查询列表
export async function getListApi(parm){
    return await http.get("/api/houseBuild/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/houseBuild",parm)
}
```

###### 2、页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parm"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parm.name"></el-input>
      </el-form-item>
      <el-form-item label="栋数类型">
        <el-select v-model="parm.type" placeholder="" clearable filterable>
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button @click="cancelBtn" style="color: #ff7670" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="type" label="栋数类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'" type="success" size="small">普通房</el-tag>
          <el-tag v-if="scope.row.type == '1'" type="danger" size="small">电梯房</el-tag>
        </template>
      </el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            @click="editBtn(scope.row)"
            size="small"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            @click="deleteBtn(scope.row)"
            size="small"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parm.total"
      background
    >
    </el-pagination>
    <!-- 新增栋数弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModle"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="name" label="栋数名称">
            <el-input v-model="addModle.name"></el-input>
          </el-form-item>
          <el-form-item prop="type" label="栋数类型">
            <el-select v-model="addModle.type">
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="栋数序号">
            <el-input v-model="addModle.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi } from "@/api/building";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //表单验证规则
      rules: {
        name: [
          {
            trigger: "change",
            required: true,
            message: "请填写栋数名称",
          },
        ],
        type: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数类型",
          },
        ]
      },
      //新增或编辑表单数据
      addModle: {
        buildId: "",
        editType: "", //0新增 1：编辑
        type: "", //0：普通房 1：电梯房
        name: "",
        orderNum: "",
      },
      //定义弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 630,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      options: [
        {
          value: "0",
          label: "普通房",
        },
        {
          value: "1",
          label: "电梯房",
        },
      ],
      //存放列表的数据
      tableList: [],
      //获取列表的参数
      parm: {
        name: "",
        type: "",
        pageSize: 10,
        currentPage: 1,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addRef.validate(async valid=>{
        if(valid){
          let res = null;
          if(this.addModle.editType == '0'){
            res = await addApi(this.addModle);
          }
          if(res && res.code == 200){
            //提示信息
            this.$message.success(res.msg)
            //关闭弹框、
            this.addDialog.visible = false;
            //刷新表格
            this.getList();
          }
        }
      })
      // this.addDialog.visible = false;
    },
    //新增或编辑关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      //设置弹框属性
      this.addModle.editType = '0'; //标识新增
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
    },
    //重置按钮
    cancelBtn() {
      this.parm.name = "";
      this.parm.type = "";
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {},
    //页数改变时触发
    currentChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //搜索按钮
    searchBtn() {
      console.log(this.parm);
      this.getList();
    },
    async getList() {
      let res = await getListApi(this.parm);
      console.log(res);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第49讲 栋数编辑、删除接口对接

###### 1、在api/houseBuilding.js添加如下方法

```js
import http from '@/utils/http'
//查询列表
export async function getListApi(parm){
    return await http.get("/api/houseBuild/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/houseBuild",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/houseBuild",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/houseBuild",parm)
}
```

###### 2、页面完整代码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parm"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parm.name"></el-input>
      </el-form-item>
      <el-form-item label="栋数类型">
        <el-select v-model="parm.type" placeholder="" clearable filterable>
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button @click="cancelBtn" style="color: #ff7670" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column prop="type" label="栋数类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'" type="success" size="small">普通房</el-tag>
          <el-tag v-if="scope.row.type == '1'" type="danger" size="small">电梯房</el-tag>
        </template>
      </el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            @click="editBtn(scope.row)"
            size="small"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            @click="deleteBtn(scope.row)"
            size="small"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parm.total"
      background
    >
    </el-pagination>
    <!-- 新增栋数弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModle"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="name" label="栋数名称">
            <el-input v-model="addModle.name"></el-input>
          </el-form-item>
          <el-form-item prop="type" label="栋数类型">
            <el-select v-model="addModle.type">
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="栋数序号">
            <el-input type="number" v-model="addModle.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi, editApi, deleteApi } from "@/api/building";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //表单验证规则
      rules: {
        name: [
          {
            trigger: "change",
            required: true,
            message: "请填写栋数名称",
          },
        ],
        type: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数类型",
          },
        ],
      },
      //新增或编辑表单数据
      addModle: {
        buildId: "",
        editType: "", //0新增 1：编辑
        type: "", //0：普通房 1：电梯房
        name: "",
        orderNum: "",
      },
      //定义弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 630,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      options: [
        {
          value: "0",
          label: "普通房",
        },
        {
          value: "1",
          label: "电梯房",
        },
      ],
      //存放列表的数据
      tableList: [],
      //获取列表的参数
      parm: {
        name: "",
        type: "",
        pageSize: 10,
        currentPage: 1,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModle.editType == "0") {
            res = await addApi(this.addModle);
          } else {
            res = await editApi(this.addModle);
          }
          if (res && res.code == 200) {
            //提示信息
            this.$message.success(res.msg);
            //关闭弹框、
            this.addDialog.visible = false;
            //刷新表格
            this.getList();
          }
        }
      });
      // this.addDialog.visible = false;
    },
    //新增或编辑关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addRef", this.addModle);
      //设置弹框属性
      this.addModle.editType = "0"; //标识新增
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
    },
    //重置按钮
    cancelBtn() {
      this.parm.name = "";
      this.parm.type = "";
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {},
    //页数改变时触发
    currentChange(val) {},
    //删除按钮
    async deleteBtn(row) {
      console.log(row);
      //先提示，不能直接删除
      const confirm = await this.$myconfirm("确定删除该数据吗？");
      if (confirm) {
        let res = await deleteApi({ buildId: row.buildId });
        if (res && res.code == 200) {
          //提示信息
          this.$message.success(res.msg);
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addRef", this.addModle);
      //设置编辑状态
      this.addModle.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑栋数";
      this.addDialog.visible = true;
      //设置需要编辑的数据
      this.$objCoppy(row, this.addModle);
    },
    //搜索按钮
    searchBtn() {
      console.log(this.parm);
      this.getList();
    },
    async getList() {
      let res = await getListApi(this.parm);
      console.log(res);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第40讲 房屋单元接口讲解

###### 1、新建实体

在com.itmk.web.house_unit.entity包新建HouseUnit实体类和HouseUnitParm类

```js
package com.itmk.web.house_unit.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

@Data
@TableName("house_unit")
public class HouseUnit implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long unitId;
    private Long buildId;
    private String unitName;
}
```

```js
package com.itmk.web.house_unit.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class HouseUnitParm implements Serializable {
    private String buildNme;
    private String unitName;
    private Long currentPage;
    private Long pageSize;
}
```

###### 2、新建mapper层

在包com.itmk.web.house_unit.mapper中新建HouseUnitMapper接口

```js
package com.itmk.web.house_unit.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.house_unit.entity.HouseUnit;
import org.apache.ibatis.annotations.Param;

public interface HouseUnitMapper extends BaseMapper<HouseUnit> {
    //单元列表
    IPage<HouseUnit> getList(IPage<HouseUnit> page,@Param("buildNme") String buildNme,@Param("unitName") String unitName);
}

```

###### 3、mapper映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.house_unit.mapper.HouseUnitMapper">
    <select id="getList" resultType="com.itmk.web.house_unit.entity.HouseUnit">
        select hu.*,hb.name
        from house_unit as hu,house_building as hb
        where hu.build_id = hb.build_id
        <if test="buildNme != null and buildNme != ''">
           and  hb.name like concat('%',#{buildNme},'%')
        </if>
        <if test="unitName != null and unitName != ''">
           and  hu.unit_name like concat('%',#{unitName},'%')
        </if>
    </select>
</mapper>
```

###### 4、新建service层

在包com.itmk.web.house_unit.service中新建HouseUnitService接口

```js
package com.itmk.web.house_unit.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.house_unit.entity.HouseUnit;
import com.itmk.web.house_unit.entity.HouseUnitParm;

public interface HouseUnitService extends IService<HouseUnit> {
    IPage<HouseUnit> getList(HouseUnitParm parm);
}

```

**实现类**

```js
package com.itmk.web.house_unit.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.house_unit.entity.HouseUnit;
import com.itmk.web.house_unit.entity.HouseUnitParm;
import com.itmk.web.house_unit.mapper.HouseUnitMapper;
import com.itmk.web.house_unit.service.HouseUnitService;
import org.springframework.stereotype.Service;

@Service
public class HouseUnitServiceImpl extends ServiceImpl<HouseUnitMapper, HouseUnit> implements HouseUnitService {
    @Override
    public IPage<HouseUnit> getList(HouseUnitParm parm) {
        IPage<HouseUnit> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        return this.baseMapper.getList(page,parm.getBuildNme(),parm.getUnitName());
    }
}

```

###### 5、新建控制器

在包com.itmk.web.house_unit.controller中新建控制器

```js
package com.itmk.web.house_unit.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.house_unit.entity.HouseUnit;
import com.itmk.web.house_unit.entity.HouseUnitParm;
import com.itmk.web.house_unit.service.HouseUnitService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 房屋单元控制器
 */
@RestController
@RequestMapping("/api/houseUnit")
public class HouseUnitController {
    @Autowired
    private HouseUnitService houseUnitService;

    /**
     * 单元列表
     */
    @GetMapping("/list")
    public ResultVo getList(HouseUnitParm parm){
        IPage<HouseUnit> list = houseUnitService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增单元
     * @param houseUnit
     * @return
     */
    @PostMapping
    public ResultVo add(@RequestBody HouseUnit houseUnit){
        boolean save = houseUnitService.save(houseUnit);
        if(save){
            return ResultUtils.success("新增单元成功!");
        }
        return ResultUtils.error("新增单元失败!");
    }
    /**
     * 编辑单元
     * @param houseUnit
     * @return
     */
    @PutMapping
    public ResultVo edit(@RequestBody HouseUnit houseUnit){
        boolean save = houseUnitService.updateById(houseUnit);
        if(save){
            return ResultUtils.success("编辑单元成功!");
        }
        return ResultUtils.error("编辑单元失败!");
    }

    /**
     * 删除单元
     * @param unitId
     * @return
     */
    @DeleteMapping("/{unitId}")
    public ResultVo edit(@PathVariable("unitId") Long unitId){
        boolean b = houseUnitService.removeById(unitId);
        if(b){
            return ResultUtils.success("删除单元成功!");
        }
        return ResultUtils.error("删除单元失败!");
    }
}
```

#### 第41讲 房屋单元列表页面制作与接口对接

###### 1、api下新建houseUnit.js

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return http.get("/api/houseUnit/list",parm)
}
```

###### 2、路由中添加页面路由

```js
	{
        path: '/houseUnit',
        name: 'houseUnit',
        component: () => import('@/views/house/houseUnit'),
        meta: { title: '单元管理', icon: 'table' }
      },
```

###### 3、houseUnit.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height='tableHeight' :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10,20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total" background>
    </el-pagination>
    
  </el-main>
</template>

<script>
import { getListApi } from "@/api/houseUnit";
export default {
  data() {
    return {
      //表格高度
      tableHeight:0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        buildNme: "",
        unitName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted(){
    this.$nextTick(()=>{
      this.tableHeight = window.innerHeight - 200
    })
  },
  methods: {
    //页数改变时触发
    currentChange(val){

    },
    //页容量改变时触发
    sizeChange(val){

    },
    //删除按钮
    deleteBtn(row){

    },
    //编辑按钮
    editBtn(row){

    },
    //新增
    addBtn() {},
    //重置
    resetBtn() {
      this.parms.buildNme = '';
      this.parms.unitName = '';
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log(res);
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第42讲 新增页面制作与接口对接

###### 1、在api/houseUnit.js中添加如下方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return http.get("/api/houseUnit/list",parm)
}
//获取栋数列表
export async function getBuildListApi(parm){
    return await http.get("/api/HouseBuilding/list",parm);
}
//新增
export async function addApi(parm){
    return await http.post("/api/houseUnit",parm)
}
```

###### 2、页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="单元名称">
            <el-select v-model="addModel.buildId">
              <el-option
                v-for="item in bulidTabeList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitName" label="单元名称">
            <el-input v-model="addModel.unitName"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getBuildListApi,addApi } from "@/api/houseUnit";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitName: [
          {
            trigger: "change",
            required: true,
            message: "请填写单元名称",
          },
        ],
      },
      addModel: {
        editType: "",
        unitId: "",
        buildId: "",
        unitName: "",
      },
      bulidTabeList: [],
      //栋数查询参数
      buildParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 620,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        buildNme: "",
        unitName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async(valid) => {
        if (valid) {
          let res = null;
          if(this.addModel.editType == '0'){
            res = await addApi(this.addModel);
          }
          if(res && res.code == 200){
            //刷新表格
            this.getList();
            this.$message.success(res.msg)
             this.addDialog.visible = false;
          }
        }
      });
    },
    //新增或编辑关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.visible = true;
      this.addDialog.title = "新增单元";
      //
    },
    //重置
    resetBtn() {
      this.parms.buildNme = "";
      this.parms.unitName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log(res);
    },
    //获取栋数列表
    async getBuildList() {
      let res = await getBuildListApi(this.buildParm);
      console.log(res);
      if (res && res.code == 200) {
        this.bulidTabeList = res.data.records;
        this.buildParm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第43讲 单元编辑、删除接口对接

###### 1、在src/api/houseUnit.js中添加如下方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return http.get("/api/houseUnit/list",parm)
}
//获取栋数列表
export async function getBuildListApi(parm){
    return await http.get("/api/HouseBuilding/list",parm);
}
//新增
export async function addApi(parm){
    return await http.post("/api/houseUnit",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/houseUnit",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/houseUnit",parm)
}
```

2、页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="单元名称">
            <el-select v-model="addModel.buildId">
              <el-option
                v-for="item in bulidTabeList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitName" label="单元名称">
            <el-input v-model="addModel.unitName"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getBuildListApi, addApi, editApi, deleteApi } from "@/api/houseUnit";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitName: [
          {
            trigger: "change",
            required: true,
            message: "请填写单元名称",
          },
        ],
      },
      addModel: {
        editType: "",
        unitId: "",
        buildId: "",
        unitName: "",
      },
      bulidTabeList: [],
      //栋数查询参数
      buildParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 620,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        buildNme: "",
        unitName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //新增或编辑确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增或编辑关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      const confirm = await this.$myconfirm('确定删除该数据吗？');
      if(confirm){
        let res = await deleteApi({unitId:row.unitId})
        if(res && res.code == 200){
          //刷新表格
          this.getList();
          this.$message.success(this.msg)
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addModel.editType = "1";
      this.addDialog.title = "编辑单元";
      this.addDialog.visible = true;
      //把当前要编辑的数据复制到数据域
      this.$objCoppy(row, this.addModel);
    },
    //新增
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.visible = true;
      this.addDialog.title = "新增单元";
      //
    },
    //重置
    resetBtn() {
      this.parms.buildNme = "";
      this.parms.unitName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log(res);
    },
    //获取栋数列表
    async getBuildList() {
      let res = await getBuildListApi(this.buildParm);
      console.log(res);
      if (res && res.code == 200) {
        this.bulidTabeList = res.data.records;
        this.buildParm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第44讲 房屋管理接口开发

###### 1、新建实体

```js
package com.itmk.web.house_list.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
@Data
@TableName("house_list")
public class HouseList implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long houseId;
    private Long unitId;
    private String houseNum;
    private String houseArea;
    private String status;
}
```

```js
package com.itmk.web.house_list.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class ListParm implements Serializable {
    private String buildNme;
    private String unitName;
    private String houseNum;
    private Long currentPage;
    private Long pageSize;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.house_list.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.house_list.entity.HouseList;
import org.apache.ibatis.annotations.Param;

public interface HouseListMapper extends BaseMapper<HouseList> {
    IPage<HouseList> getList(IPage<HouseList> page, @Param("name") String name,@Param("unitName") String unitName,@Param("houseNum") String houseNum);
}
```



###### 3、新建映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.house_list.mapper.HouseListMapper">
  <select id="getList" resultType="com.itmk.web.house_list.entity.HouseList">
      select hb.`name`,hu.unit_name,hl.*
      from house_building as hb,house_unit as hu,house_list as hl
      where hb.build_id = hu.build_id and hu.unit_id = hl.unit_id
      <if test="name != null and name !=''">
          and hb.name like concat('%',#{name},'%')
      </if>
      <if test="unitName != null and unitName !=''">
          and hu.unit_name like concat('%',#{unitName},'%')
      </if>
      <if test="houseNum != null and houseNum !=''">
          and hl.house_num like concat('%',#{houseNum},'%')
      </if>
  </select>
</mapper>
```

###### 4、新建service层

```js
package com.itmk.web.house_list.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.house_list.entity.HouseList;
import com.itmk.web.house_list.entity.ListParm;

public interface HouseListService extends IService<HouseList> {
    IPage<HouseList> getList(ListParm listParm);
}

```

**实现类**

```js
package com.itmk.web.house_list.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.house_list.entity.HouseList;
import com.itmk.web.house_list.entity.ListParm;
import com.itmk.web.house_list.mapper.HouseListMapper;
import com.itmk.web.house_list.service.HouseListService;
import org.springframework.stereotype.Service;

@Service
public class HouseListServiceImpl extends ServiceImpl<HouseListMapper, HouseList> implements HouseListService {
    @Override
    public IPage<HouseList> getList(ListParm listParm) {
        //构造分页对象
        IPage<HouseList> page = new Page<>();
        page.setCurrent(listParm.getCurrentPage());
        page.setSize(listParm.getPageSize());
        return this.baseMapper.getList(page,listParm.getBuildNme(),listParm.getUnitName(),listParm.getHouseNum());
    }
}

```

###### 5、新建控制器层

```js
package com.itmk.web.house_list.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.house_list.entity.HouseList;
import com.itmk.web.house_list.entity.ListParm;
import com.itmk.web.house_list.service.HouseListService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 房屋列表控制器
 */
@RestController
@RequestMapping("/api/houseList")
public class HouseListController {
    @Autowired
    private HouseListService houseListService;

    /**
     * 查询列表
     * @param listParm
     * @return
     */
    @RequestMapping("/list")
    public ResultVo getList(ListParm listParm){
        IPage<HouseList> list = houseListService.getList(listParm);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增房屋
     * @param houseList
     * @return
     */
    @PostMapping
    public ResultVo add(@RequestBody HouseList houseList){
        boolean save = houseListService.save(houseList);
        if(save){
            return ResultUtils.success("新增房屋成功!");
        }
        return ResultUtils.error("新增房屋失败!");
    }

    /**
     * 编辑房屋
     * @param houseList
     * @return
     */
    @PutMapping
    public ResultVo edit(@RequestBody HouseList houseList){
        boolean save = houseListService.updateById(houseList);
        if(save){
            return ResultUtils.success("编辑房屋成功!");
        }
        return ResultUtils.error("编辑房屋失败!");
    }

    /**
     * 删除房屋
     * @param houseId
     * @return
     */
    @DeleteMapping("/{houseId}")
    public ResultVo delete(@PathVariable("houseId") String houseId){
        boolean save = houseListService.removeById(houseId);
        if(save){
            return ResultUtils.success("删除房屋成功!");
        }
        return ResultUtils.error("删除房屋失败!");
    }

}
```



#### 第45讲 房屋管理列表页面制作与数据对接

###### 1、新增api方法

在src/api下面新建houseList.js文件

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/houseList/list",parm)
}
```

###### 2、houseList.vue页面完整源码如下

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input placeholder="请输入栋数名称" v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input placeholder="请输入单元名称" v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input placeholder="请输入房屋编号" v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item label="使用状态">
        <el-select v-model="parms.status">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="status" label="使用状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.statue == '0'" type="danger" size="small"
            >未使用</el-tag
          >
          <el-tag v-if="scope.row.statue == '1'" type="success" size="small"
            >未使用</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          ></el-button>
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          ></el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/houseList";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //使用状态
      options: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      //表格数据
      tableList: [],
      //列表参数，搜索框绑定的数据域
      parms: {
        buildNme: "",
        status: "",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {
        this.parms.buildNme = '';
        this.parms.unitName = '';
        this.parms.status = '';
        this.parms.houseNum = '';
        this.parms.currentPage = 1;
        this.getList();
    },
    //搜索按钮
    searchBtn() {
        this.getList();
    },
    //获取房屋列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>


```

#### 第46讲 房屋管理新增页面制作与数据对接

###### 1、添加根据栋数id查询单元列表的方法

在后端HouseUnitController控制器添加如下方法

```js
	/**
     * 根据栋数id查询单元列表
     */
    @GetMapping("/getUnitListByBuildId")
    public ResultVo getUnitListByBuildId(HouseUnit houseUnit){
        QueryWrapper<HouseUnit> query = new QueryWrapper<>();
        query.lambda().eq(HouseUnit::getBuildId,houseUnit.getBuildId());
        List<HouseUnit> list = houseUnitService.list(query);
        return ResultUtils.success("查询成功",list);
    }
```



###### 2、在src/api/houseList中添加如下方法

```js
//查询栋数列表
export async function getBuildApi() {
    return await http.get("/api/HouseBuilding/unitList", null);
}
//根据栋数id查询单元列表
export async function getUnitListByIdApi(parm){
    return await http.get("/api/houseUnit/getUnitListByBuildId",parm)
}
```

###### 3、houseList.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input placeholder="请输入栋数名称" v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input placeholder="请输入单元名称" v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input placeholder="请输入房屋编号" v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item label="使用状态">
        <el-select v-model="parms.status">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="status" label="使用状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未使用</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已使用</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          >编辑</el-button>
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          >删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildvalue" label="所属栋数">
            <el-select v-model="addModel.buildvalue" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="所属单元">
            <el-select v-model="addModel.unitId">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseNum" label="房屋编号">
            <el-input
              v-model="addModel.houseNum"
              placeholder="请输入房屋编号"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="houseArea" style="margin-left: 15px" label="使用面积">
            <el-input
              v-model="addModel.houseArea"
              placeholder="请输入使用面积"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="status" label="使用状态" size="normal">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="0">未使用</el-radio>
              <el-radio :label="1">已使用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getBuildApi, getUnitListByIdApi, addApi } from "@/api/houseList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //单元列表
      unitList: [],
      //栋数列表
      buildList: [],
      rules: {
        buildvalue: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属单元",
          },
        ],
        houseNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写房屋编号",
          },
        ],
        houseArea: [
          {
            trigger: "change",
            required: true,
            message: "请填写使用面积",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择使用状态",
          },
        ],
      },
      //新增或编辑数据
      addModel: {
        editType: "",
        houseId: "",
        unitId: "",
        houseNum: "",
        houseArea: "",
        status: "",
        buildvalue: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //使用状态
      options: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      //表格数据
      tableList: [],
      //列表参数，搜索框绑定的数据域
      parms: {
        buildNme: "",
        status: "",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //选择栋数触发事件
    selectBuild(val) {
      //清空原来的数据
      this.addModel.unitId = "";
      //根据栋数id查询对应的单元
      this.getUnitListById(val);
      console.log(val);
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑type
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增房屋";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.buildNme = "";
      this.parms.unitName = "";
      this.parms.status = "";
      this.parms.houseNum = "";
      this.parms.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取房屋列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //栋数列表
    async getBuildList() {
      let res = await getBuildApi();
      console.log("返回栋数");
      console.log(res);
      if (res && res.code == 200) {
        //赋值给栋数列表
        this.buildList = res.data;
      }
    },
    //单元列表
    async getUnitListById(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.code == 200) {
        //赋值给单元列表
        this.unitList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>


```



#### 第47讲 房屋管理编辑、删除接口对接

###### 1、在src/api/houseList.js中添加方法

```js

//编辑
export async function editApi(parm){
    return await http.put("/api/houseList",parm);
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/houseList",parm)
}
```

###### 2、完整页面源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="栋数名称">
        <el-input placeholder="请输入栋数名称" v-model="parms.buildNme"></el-input>
      </el-form-item>
      <el-form-item label="单元名称">
        <el-input placeholder="请输入单元名称" v-model="parms.unitName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input placeholder="请输入房屋编号" v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item label="使用状态">
        <el-select v-model="parms.status">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="name" label="栋数名称"></el-table-column>
      <el-table-column prop="unitName" label="单元名称"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="status" label="使用状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未使用</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已使用</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildvalue" label="所属栋数">
            <el-select v-model="addModel.buildvalue" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="所属单元">
            <el-select v-model="addModel.unitId">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseNum" label="房屋编号">
            <el-input
              v-model="addModel.houseNum"
              placeholder="请输入房屋编号"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="houseArea" style="margin-left: 15px" label="使用面积">
            <el-input
              v-model="addModel.houseArea"
              placeholder="请输入使用面积"
              size="small"
            ></el-input>
          </el-form-item>
          <el-form-item prop="status" label="使用状态" size="normal">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">未使用</el-radio>
              <el-radio :label="'1'">已使用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getListApi,
  getBuildApi,
  getUnitListByIdApi,
  addApi,
  editApi,
  deleteApi,
} from "@/api/houseList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //单元列表
      unitList: [],
      //栋数列表
      buildList: [],
      rules: {
        buildvalue: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属单元",
          },
        ],
        houseNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写房屋编号",
          },
        ],
        houseArea: [
          {
            trigger: "change",
            required: true,
            message: "请填写使用面积",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择使用状态",
          },
        ],
      },
      //新增或编辑数据
      addModel: {
        editType: "",
        houseId: "",
        unitId: "",
        houseNum: "",
        houseArea: "",
        status: "",
        buildvalue: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //使用状态
      options: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      //表格数据
      tableList: [],
      //列表参数，搜索框绑定的数据域
      parms: {
        buildNme: "",
        status: "",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //选择栋数触发事件
    selectBuild(val) {
      //清空原来的数据
      this.addModel.unitId = "";
      //根据栋数id查询对应的单元
      this.getUnitListById(val);
      console.log(val);
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      console.log(row);
      //信息提示
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({ houseId: row.houseId });
        if (res && res.code == 200) {
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg);
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //根据栋数id查询单元列表
      this.getUnitListById(row.buildId);
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑房屋";
      this.addDialog.visible = true;

      //把当前编辑的行数据设置到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑标志
      this.addModel.editType = "1";
      console.log(row);
      console.log(this.addModel);
      //栋数回显
      this.addModel.buildvalue = row.name;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑type
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增房屋";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.buildNme = "";
      this.parms.unitName = "";
      this.parms.status = "";
      this.parms.houseNum = "";
      this.parms.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取房屋列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //栋数列表
    async getBuildList() {
      let res = await getBuildApi();
      console.log("返回栋数");
      console.log(res);
      if (res && res.code == 200) {
        //赋值给栋数列表
        this.buildList = res.data;
      }
    },
    //单元列表
    async getUnitListById(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.code == 200) {
        //赋值给单元列表
        this.unitList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>


```







#### 第48讲  项目添加添加tagsview

###### 1、添加TagsView文件

把vue-element-admin项目中的src\layout\components下的TagsView文件夹复制到vue-admin-template的 src\layout\components下

把vue-admin-template\src\store\modules\tagsView.js 复制到vue-admin-template\srcstore\modules\

###### 2、修改 vue-admin-template\src\layout\components\AppMain.vueAppMain.vue文件

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style scoped>
.app-main {
  /*50 = navbar  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}
.fixed-header + .app-main {
  padding-top: 50px;
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```



###### 3、修改vue-admin-template\src\layout\components\index.js

```js
新增如下行：
export { default as TagsView } from './TagsView'
```

###### 4、修改 vue-admin-template\src\layout\index.vue

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div v-if="device==='mobile'&&sidebar.opened" class="drawer-bg" @click="handleClickOutside" />
    <sidebar class="sidebar-container" />
    <div class="main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
      <tags-view />
      <app-main />
    </div>
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain,TagsView  } from './components'
import ResizeMixin from './mixin/ResizeHandler'

export default {
  name: 'Layout',
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView 
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar
    },
    device() {
      return this.$store.state.app.device
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === 'mobile'
      }
    }
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch('app/closeSideBar', { withoutAnimation: false })
    }
  }
}
</script>

<style lang="scss" scoped>
  @import "~@/styles/mixin.scss";
  @import "~@/styles/variables.scss";

  .app-wrapper {
    @include clearfix;
    position: relative;
    height: 100%;
    width: 100%;
    &.mobile.openSidebar{
      position: fixed;
      top: 0;
    }
  }
  .drawer-bg {
    background: #000;
    opacity: 0.3;
    width: 100%;
    top: 0;
    height: 100%;
    position: absolute;
    z-index: 999;
  }

  .fixed-header {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 9;
    width: calc(100% - #{$sideBarWidth});
    transition: width 0.28s;
  }

  .hideSidebar .fixed-header {
    width: calc(100% - 54px)
  }

  .mobile .fixed-header {
    width: 100%;
  }
</style>

```



###### 5、修改 vue-admin-template\src\store\getters.js，

新增

 visitedViews: state => state.tagsView.visitedViews,
 cachedViews: state => state.tagsView.cachedViews

```js
const getters = {
  sidebar: state => state.app.sidebar,
  device: state => state.app.device,
  token: state => state.user.token,
  avatar: state => state.user.avatar,
  name: state => state.user.name,
  visitedViews: state => state.tagsView.visitedViews,
  cachedViews: state => state.tagsView.cachedViews
}
export default getters

```

###### 6、修改 vue-admin-template\src\store\index.js

引入 import tagsView from './modules/tagsView'

```js
import Vue from 'vue'
import Vuex from 'vuex'
import getters from './getters'
import app from './modules/app'
import settings from './modules/settings'
import user from './modules/user'
import tagsView from './modules/tagsView'
Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    app,
    settings,
    user,
    tagsView
  },
  getters
})

export default store

```

###### 7、运行报错如下

![](D:\项目实战\物业管理系统\资料\images\tagsview错误.png)

解决方式

删除vue-admin-template\src\layout\components\TagsView\index.vue中routes方法

![](D:\项目实战\物业管理系统\资料\images\tags报错1.png)

![](D:\项目实战\物业管理系统\资料\images\tags报错2.png)



###### 8、解决开启头部固定，不会显示 TagsView的问题

如果settings里面开启的如下所示，TagsView将不会显示

```js
  fixedHeader: true,
```

8.1、修改vue-admin-template\src\settings.js 添加

```js
tagsView: true,
```

8.2、修改vue-admin-template\src\store\modules\settings.js

```js
import defaultSettings from '@/settings'

const { showSettings, fixedHeader, sidebarLogo,tagsView } = defaultSettings

const state = {
  showSettings: showSettings,
  fixedHeader: fixedHeader,
  sidebarLogo: sidebarLogo,
  tagsView: tagsView,
}

const mutations = {
  CHANGE_SETTING: (state, { key, value }) => {
    // eslint-disable-next-line no-prototype-builtins
    if (state.hasOwnProperty(key)) {
      state[key] = value
    }
  }
}

const actions = {
  changeSetting({ commit }, data) {
    commit('CHANGE_SETTING', data)
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}
```

8.3、修改 vue-admin-template\src\layout\components\AppMain.vueAppMain.vue文件的样式如下

主要是有hasTagsView样式的时候

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style lang="scss" scoped>
.app-main {
  /* 50= navbar  50  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}

.fixed-header+.app-main {
  padding-top: 50px;
}

.hasTagsView {
  .app-main {
    /* 84 = navbar + tags-view = 50 + 34 */
    min-height: calc(100vh - 84px);
  }

  .fixed-header+.app-main {
    padding-top: 84px;
  }
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```

8.4、修改 vue-admin-template\src\layout\index.vue如下

主要是通过needTagsView进行判断

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div
      v-if="device === 'mobile' && sidebar.opened"
      class="drawer-bg"
      @click="handleClickOutside"
    />
    <sidebar class="sidebar-container" />
    <div :class="{ hasTagsView: needTagsView }" class="main-container">
      <div :class="{ 'fixed-header': fixedHeader }">
        <navbar />
        <tags-view v-if="needTagsView" />
      </div>
      <app-main />
    </div>
    <!-- <div class="hasTagsView main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
       <tags-view />
      <app-main />
    </div> -->
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain, TagsView } from "./components";
import ResizeMixin from "./mixin/ResizeHandler";

export default {
  name: "Layout",
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView,
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar;
    },
    device() {
      return this.$store.state.app.device;
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader;
    },
    needTagsView() {
      return this.$store.state.settings.tagsView;
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === "mobile",
      };
    },
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch("app/closeSideBar", { withoutAnimation: false });
    },
  },
};
</script>

<style lang="scss" scoped>
@import "~@/styles/mixin.scss";
@import "~@/styles/variables.scss";

.app-wrapper {
  @include clearfix;
  position: relative;
  height: 100%;
  width: 100%;
  &.mobile.openSidebar {
    position: fixed;
    top: 0;
  }
}
.drawer-bg {
  background: #000;
  opacity: 0.3;
  width: 100%;
  top: 0;
  height: 100%;
  position: absolute;
  z-index: 999;
}

.fixed-header {
  position: fixed;
  top: 0;
  right: 0;
  z-index: 9;
  width: calc(100% - #{$sideBarWidth});
  transition: width 0.28s;
}

.hideSidebar .fixed-header {
  width: calc(100% - 54px);
}

.mobile .fixed-header {
  width: 100%;
}
</style>

```

 

#### 第49讲  车位管理接口开发

###### 1、新建实体

```js
package com.itmk.web.park_list.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

@Data
@TableName("parking_list")
public class ParkList implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long parkId;
    //车位类型 0：地上 1：地下
    private String parkType;
    //车位名称
    private String parkName;
    //使用状态 0：未使用 1：已使用
    private String parkStatus;
    //序号
    private Long parkNum;
}

```

```js
package com.itmk.web.park_list.entity;

import lombok.Data;

@Data
public class ParkListParm {
    private Long currentPage;
    private Long pageSize;
    private String parkName;
    private String parkStatus;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.park_list.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.park_list.entity.ParkList;

public interface ParkListMapper extends BaseMapper<ParkList> {
}

```

**映射文件** 

新建ParkListMapper.xml

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.park_list.mapper.ParkListMapper">

</mapper>
```



###### 3、新建service层

```js
package com.itmk.web.park_list.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.park_list.entity.ParkList;
import com.itmk.web.park_list.entity.ParkListParm;

public interface ParkListService extends IService<ParkList> {
    IPage<ParkList> getList(ParkListParm parkListParm);
}
```

**实现类**

```js
package com.itmk.web.park_list.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.park_list.entity.ParkList;
import com.itmk.web.park_list.entity.ParkListParm;
import com.itmk.web.park_list.mapper.ParkListMapper;
import com.itmk.web.park_list.service.ParkListService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class ParkListServiceImpl extends ServiceImpl<ParkListMapper, ParkList> implements ParkListService {
    @Override
    public IPage<ParkList> getList(ParkListParm parkListParm) {
        //构造分页查询条件
        QueryWrapper<ParkList> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parkListParm.getParkName())){
            query.lambda().like(ParkList::getParkName,parkListParm.getParkName());
        }
        if(StringUtils.isNotEmpty(parkListParm.getParkStatus())){
            query.lambda().eq(ParkList::getParkStatus,parkListParm.getParkStatus());
        }
        query.lambda().orderByAsc(ParkList::getParkNum);
        //构造分页对象
        IPage<ParkList> page = new Page<>();
        page.setCurrent(parkListParm.getCurrentPage());
        page.setSize(parkListParm.getPageSize());
        return this.baseMapper.selectPage(page,query);
    }
}
```

###### 4、新建控制器层

```js
package com.itmk.web.park_list.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.park_list.entity.ParkList;
import com.itmk.web.park_list.entity.ParkListParm;
import com.itmk.web.park_list.service.ParkListService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 车位管理模块控制器
 */
@RestController
@RequestMapping("/api/parkList")
public class ParkListController {
    @Autowired
    private ParkListService parkListService;

    /**
     * 查询列表
     */
    @GetMapping("/list")
    public ResultVo getList(ParkListParm parkListParm){
        IPage<ParkList> list = parkListService.getList(parkListParm);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增车位
     */
    @PostMapping
    public ResultVo add(@RequestBody ParkList parkList){
        boolean save = parkListService.save(parkList);
        if(save){
            return ResultUtils.success("新增车位成功!");
        }
        return ResultUtils.error("新增车位失败!");
    }

    /**
     * 编辑车位
     */
    @PutMapping
    public ResultVo edit(@RequestBody ParkList parkList){
        boolean save = parkListService.updateById(parkList);
        if(save){
            return ResultUtils.success("编辑车位成功!");
        }
        return ResultUtils.error("编辑车位失败!");
    }

    /**
     * 删除车位
     */
    @DeleteMapping("/{parkId}")
    public ResultVo delete(@PathVariable("parkId") Long parkId){
        boolean b = parkListService.removeById(parkId);
        if(b){
            return ResultUtils.success("删除车位成功!");
        }
        return ResultUtils.error("删除车位失败!");
    }
}
```



#### 第50讲 车位管理列表开发

###### 1、新增车位管理路由

在src/router中的index.js中添加如下路由

```js
{
    path: '/sysPark',
    component: Layout,
    alwaysShow: true,
    name: 'sysPark',
    meta: { title: '车位管理', icon: 'el-icon-money' },
    children: [
      {
        path: '/parkList',
        name: 'parkList',
        component: () => import('@/views/park/parkList'),
        meta: { title: '车位管理', icon: 'table' }
      }
    ]
  }
```

###### 2、新建页面组件

在views下新建park文件夹，然后新建parkList.vue页面

###### 3、新建请求api

在src/api下新建parkList.js，然后新建getListApi()方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/parkList/list",parm)
}
```

###### 4、parkList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="车位名称">
        <el-input v-model="parms.parkName"></el-input>
      </el-form-item>
      <el-form-item label="车位类型">
        <el-select v-model="parms.parkType">
          <el-option
            v-for="item in typeOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="使用状态">
        <el-select v-model="parms.parkStatus">
          <el-option
            v-for="item in statusOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="parkName" label="车位名称"></el-table-column>
      <el-table-column prop="parkType" label="车位类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
            >地上</el-tag
          >
          <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
            >地下</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="parkName" label="使用状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkStatus == '0'" type="danger" size="small"
            >未使用</el-tag
          >
          <el-tag v-if="scope.row.parkStatus == '1'" type="success" size="small"
            >已使用</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="parkNum" label="序号"></el-table-column>
      <el-table-column width="180" align="center" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/parkList";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      statusOptions: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      typeOptions: [
        {
          value: "0",
          label: "地上",
        },
        {
          value: "1",
          label: "地下",
        },
      ],
      //表格数据
      tableList: [],
      //查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        parkName: "",
        parkStatus: "",
        parkType: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted(){
      this.$nextTick(()=>{
          this.tableHeight = window.innerHeight -210
      })
  },
  methods: {
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {},
    // 搜索按钮
    searchBtn() {},
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回值赋值给表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第51讲  新增车位页面制作与接口对接

###### 1、在src/api下添加方法

在src/api/parkList.js添加 addApi()方法，如下所示

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/parkList/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/parkList",parm)
}
```

###### 2、parkList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="车位名称">
        <el-input v-model="parms.parkName"></el-input>
      </el-form-item>
      <el-form-item label="车位类型">
        <el-select v-model="parms.parkType">
          <el-option
            v-for="item in typeOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="使用状态">
        <el-select v-model="parms.parkStatus">
          <el-option
            v-for="item in statusOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="parkName" label="车位名称"></el-table-column>
      <el-table-column prop="parkType" label="车位类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
            >地上</el-tag
          >
          <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
            >地下</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="parkName" label="使用状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkStatus == '0'" type="danger" size="small"
            >未使用</el-tag
          >
          <el-tag v-if="scope.row.parkStatus == '1'" type="success" size="small"
            >已使用</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="parkNum" label="序号"></el-table-column>
      <el-table-column width="180" align="center" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 定义弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="parkName" label="车位名称">
            <el-input v-model="addModel.parkName"></el-input>
          </el-form-item>
          <el-form-item prop="parkType" label="车位类型">
            <el-select v-model="addModel.parkType">
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="parkStatus" label="使用状态">
            <el-select v-model="addModel.parkStatus">
              <el-option
                v-for="item in useOptions"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="车位序号">
            <el-input v-model="addModel.parkNum"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi } from "@/api/parkList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //车位使用状态
      useOptions: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      //车位类型
      options: [
        {
          value: "0",
          label: "地上",
        },
        {
          value: "1",
          label: "地下",
        },
      ],
      //表单验证
      rules: {
        parkName: [
          {
            trigger: "change",
            required: true,
            message: "请填写车位名称",
          },
        ],
        parkType: [
          {
            trigger: "change",
            required: true,
            message: "请选择车位类型",
          },
        ],
        parkStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择使用状态",
          },
        ],
      },
      //表单数据
      addModel: {
        editType: "", //0 新增 1：编辑
        parkId: "",
        parkType: "",
        parkName: "",
        parkStatus: "",
        parkNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 620,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      statusOptions: [
        {
          value: "0",
          label: "未使用",
        },
        {
          value: "1",
          label: "已使用",
        },
      ],
      typeOptions: [
        {
          value: "0",
          label: "地上",
        },
        {
          value: "1",
          label: "地下",
        },
      ],
      //表格数据
      tableList: [],
      //查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        parkName: "",
        parkStatus: "",
        parkType: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          // 数据提交
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.addDialog.visible = false;
            //刷新表格
            this.getList();
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置设置编辑标识
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增车位";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {},
    // 搜索按钮
    searchBtn() {},
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回值赋值给表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第52将 车位编辑、删除接口对接

###### 1、新增请求方法

在src/api/parkList.js添加编辑和删除的方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/parkList/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/parkList",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/parkList",parm);
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/parkList",parm)
}
```



#### 第53讲 业主模块数据库设计



#### 第54讲 房屋、租户关系表接口开发

###### 1、新建业主和车位关系实体

```js
package com.itmk.web.live_park.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

/**
 * 租户和房屋的关系表
 */
@Data
@TableName("live_park")
public class LivePark implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long liveParkId;
    //业主id
    private Long userId;
    //车位id
    private Long parkId;
    //使用状态
    private String liveStatue;
}
```

###### 2、新建mapper层

```js
package com.itmk.web.live_park.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.live_park.entity.LivePark;

public interface LiveParkMapper extends BaseMapper<LivePark> {
}
```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.live_park.mapper.LiveParkMapper">

</mapper>
```



###### 3、新建业主和房屋关系表实体

```js
package com.itmk.web.live_house.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

/**
 * 业主跟房屋的关系表
 */
@Data
@TableName("live_house")
public class LiveHouse implements Serializable {
    //主键
    @TableId(type = IdType.AUTO)
    private Long liveHouseId;
    //业主id
    private Long userId;
    //房屋id
    private Long houseId;
    //使用状态 0:未使用 1：已使用
    private String useStatus;
}
```

###### 4、新建mapper接口

```js
package com.itmk.web.live_house.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.live_house.entity.LiveHouse;

public interface LiveHouseMapper extends BaseMapper<LiveHouse> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.live_house.mapper.LiveHouseMapper">

</mapper>
```



#### 第55讲 新增业主接口开发

功能说明：新增的时候，有用户的基本信息，还有用户的角色信息选择

功能实现：保存用户信息的时候，除了业主表需要存入用户基本信息，还需要在用户角色表插入用户角色信息

###### 1、新建业主实体

```js
package com.itmk.web.live_user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

/**
 * 业主表实体映射
 */
@Data
@TableName("live_user")
public class LiveUser implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long userId;
    //姓名
    private String userName;
    //联系电话
    private String phone;
    //性别
    private String sex;
    //登录账户
    private String loginName;
    //登录密码
    private String password;
    //状态 0:启用 1：禁用
    private String status;
    //角色id不属于业主表，需要排除
    @TableField(exist =  false)
    private Long roleId;
}
```

###### 2、新建mapper层

```js
package com.itmk.web.live_user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.live_user.entity.LiveUser;

public interface LiveUserMapper extends BaseMapper<LiveUser> {
}
```

###### 3、新建service层

```js
package com.itmk.web.live_user.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.live_user.entity.LiveUser;

public interface LiveUserService extends IService<LiveUser> {
    void saveLiveUser(LiveUser liveUser);
}

```

**实现类**

```js
package com.itmk.web.live_user.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.mapper.LiveUserMapper;
import com.itmk.web.live_user.service.LiveUserService;
import com.itmk.web.user_role.entity.UserRole;
import com.itmk.web.user_role.mapper.UserRoleMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

@Service
public class LiveUserServiceImpl extends ServiceImpl<LiveUserMapper, LiveUser> implements LiveUserService {
    @Resource
    private UserRoleMapper userRoleMapper;

    @Override
    @Transactional
    public void saveLiveUser(LiveUser liveUser) {
        //1.保存业主信息
        this.baseMapper.insert(liveUser);
        //2.维护角色信息
        UserRole userRole = new UserRole();
        userRole.setRoleId(liveUser.getRoleId());
        userRole.setUserId(liveUser.getUserId());
        userRoleMapper.insert(userRole);
    }
}
```

###### 4、新建控制器

```js
package com.itmk.web.live_user.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * 业主控制器
 */
@RestController
@RequestMapping("/api/liveUser")
public class LiveUserController {
    @Autowired
    private LiveUserService liveUserService;

    /**
     * 新增业主
     */
    @PostMapping
    public ResultVo add(@RequestBody LiveUser liveUser){
        liveUserService.saveLiveUser(liveUser);
        return ResultUtils.success("新增业主成功!");
    }
}
```



#### 第56讲 新增业主页面制作与接口对接

###### 1、在src/api新建liveUser.js，并添加如下方法

新增业主时，需要选择业主的角色，所以需要查询出角色列表

```js
import http from '@/utils/http'
//新增
export async function addApi(parm){
    return await http.post("/api/liveUser",parm)
}
//获取角色列表
export async function getRoleListApi(){
    return await http.get("/api/role/getList",null)
}
```

###### 2、RoleController控制器添加如下查询角色列表的方法

```js
 //获取角色列表，不需要参数
    @GetMapping("/getList")
    public ResultVo getList(){
        List<Role> list = roleService.list();
        return ResultUtils.success("成功",list);
    }
```



###### 3、添加页面路由

在src/router里面添加如下路由

```js
{
    path: '/live',
    component: Layout,
    alwaysShow: true,
    name: 'live',
    meta: { title: '业主管理', icon: 'el-icon-s-grid' },
    children: [
      {
        path: '/liveUser',
        name: 'liveUser',
        component: () => import('@/views/live/liveUser'),
        meta: { title: '业主列表', icon: 'el-icon-s-data' }
      }
    ]
  },
```

###### 4、前端views下新建live文件夹，并新建liveUser.vue页面

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="0">男</el-radio>
              <el-radio :label="1">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="0">启用</el-radio>
              <el-radio :label="1">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getRoleListApi, addApi } from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
      },
    };
  },
  created() {
    this.getRoleList();
  },
  methods: {
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

###### 5、修改LiveUserController控制器的新增方法

新增时候密码需要加密，同时需要判断登录名是否被占用

```js
package com.itmk.web.live_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * 业主控制器
 */
@RestController
@RequestMapping("/api/liveUser")
public class LiveUserController {
    @Autowired
    private LiveUserService liveUserService;

    /**
     * 新增业主
     */
    @PostMapping
    public ResultVo add(@RequestBody LiveUser liveUser){
        //查询登录名是否被占用
        QueryWrapper<LiveUser> query = new QueryWrapper<>();
        query.lambda().eq(LiveUser::getLoginName,liveUser.getLoginName());
        LiveUser one = liveUserService.getOne(query);
        if(one != null){
            return ResultUtils.error("登录名被占用!");
        }
        //用户名需要加密
        liveUser.setPassword(DigestUtils.md5DigestAsHex(liveUser.getPassword().getBytes()));
        liveUserService.saveLiveUser(liveUser);
        return ResultUtils.success("新增业主成功!");
    }
}

```



#### 第57讲  新增业主角色保存

存在的问题：由于业主表格物主表的用户id保存到用户角色关系表中存在重复，需要区分

1、数据库新增 live_role表

```js
create table live_role
(
   liv_role_id          int not null auto_increment comment '主键',
   role_id              int comment '角色id',
   user_id              int comment '业主id',
   primary key (liv_role_id)
);
```

###### 2、新建业主角色实体类

```js
package com.itmk.web.live_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

/**
 * 业主和角色的关联表
 */
@Data
@TableName("live_role")
public class LiveRole implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long livRoleId;
    private Long roleId;
    private Long userId;

}

```

###### 3、新建mapper层接口

```js
package com.itmk.web.live_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.live_role.entity.LiveRole;

public interface LiveRoleMapper extends BaseMapper<LiveRole> {
}

```

**映射文件**

新建LiveRoleMapper.xml文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.live_role.mapper.LiveRoleMapper">

</mapper>
```

###### 4、修改业主保存实现类的新增业主方法 saveLiveUser()

```js
package com.itmk.web.live_user.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.live_role.entity.LiveRole;
import com.itmk.web.live_role.mapper.LiveRoleMapper;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.mapper.LiveUserMapper;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

@Service
public class LiveUserServiceImpl extends ServiceImpl<LiveUserMapper, LiveUser> implements LiveUserService {
    @Resource
//    private UserRoleMapper userRoleMapper;
    private LiveRoleMapper liveRoleMapper;
    @Override
    @Transactional
    public void saveLiveUser(LiveUser liveUser) {
        //1.保存业主信息
        this.baseMapper.insert(liveUser);
        //2.维护角色信息
        LiveRole userRole = new LiveRole();
        userRole.setRoleId(liveUser.getRoleId());
        userRole.setUserId(liveUser.getUserId());
        liveRoleMapper.insert(userRole);
    }
}

```



#### 第58讲 业主列表制作与接口对接

###### 1、LiveUserMapper接口新建getList()查询方法

```js
package com.itmk.web.live_user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.live_user.entity.LiveUser;
import org.apache.ibatis.annotations.Param;

public interface LiveUserMapper extends BaseMapper<LiveUser> {
    IPage<LiveUser> getList(IPage<LiveUser> page, @Param("userName") String userName,@Param("phone") String phone);
}

```

###### 2、LiveUserMapper.xml映射文件新建查询sql

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.live_user.mapper.LiveUserMapper">
<select id="getList" resultType="com.itmk.web.live_user.entity.LiveUser">
    select lu.user_id,lu.user_name,lu.phone,lu.sex,hl.house_num,hl.house_area,hu.unit_name,hb.`name`,pl.park_name from live_user as lu
    left join live_house as lh on lu.user_id = lh.user_id
    left join house_list as hl on lh.house_id = hl.house_id
    left join house_unit as hu on hu.unit_id = hl.unit_id
    left join house_building  as hb on hb.build_id = hu.build_id
    left join live_park as lp on lu.user_id = lp.user_id
    left join parking_list as pl on pl.park_id = lp.park_id
    where 1=1
    <if test="userName != null and userName !=''">
        and lu.user_name like concat('%',#{userName},'%')
    </if>
    <if test="phone != null and phone !=''">
        and lu.phone like concat('%',#{phone},'%')
    </if>
</select>
</mapper>
```



###### 3、LiveUserService接口新增查询方法

```js
package com.itmk.web.live_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.live_user.entity.LiveUser;
public interface LiveUserService extends IService<LiveUser> {
    //保存用户
    void saveLiveUser(LiveUser liveUser);
    //业主列表
    IPage<LiveUser> getList(IPage<LiveUser> page, String userName, String phone);
}

```

**实现类**

```js
package com.itmk.web.live_user.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.live_role.entity.LiveRole;
import com.itmk.web.live_role.mapper.LiveRoleMapper;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.mapper.LiveUserMapper;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

@Service
public class LiveUserServiceImpl extends ServiceImpl<LiveUserMapper, LiveUser> implements LiveUserService {
    @Resource
//    private UserRoleMapper userRoleMapper;
    private LiveRoleMapper liveRoleMapper;
    @Override
    @Transactional
    public void saveLiveUser(LiveUser liveUser) {
        //1.保存业主信息
        this.baseMapper.insert(liveUser);
        //2.维护角色信息
        LiveRole userRole = new LiveRole();
        userRole.setRoleId(liveUser.getRoleId());
        userRole.setUserId(liveUser.getUserId());
        liveRoleMapper.insert(userRole);
    }

    @Override
    public IPage<LiveUser> getList(IPage<LiveUser> page, String userName, String phone) {
        return this.baseMapper.getList(page,userName,phone);
    }
}
```

###### 4、新增接收参数的实体类

```js
package com.itmk.web.live_user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class LiveUserParm implements Serializable {
    //当前页
    private Long currentPage;
    //页容量
    private Long pageSize;
    //姓名
    private String userName;
    //电话
    private String phone;
}

```

###### 5、LiveUserController控制器新增查询列表方法getList()

```js
package com.itmk.web.live_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.entity.LiveUserParm;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

/**
 * 业主控制器
 */
@RestController
@RequestMapping("/api/liveUser")
public class LiveUserController {
    @Autowired
    private LiveUserService liveUserService;

    /**
     * 业主列表查询
     */

    @GetMapping("/list")
    public ResultVo getList(LiveUserParm liveUserParm){
        //构造分页对象
        IPage<LiveUser> page = new Page<>();
        page.setSize(liveUserParm.getPageSize());
        page.setCurrent(liveUserParm.getCurrentPage());
        IPage<LiveUser> list = liveUserService.getList(page, liveUserParm.getUserName(), liveUserParm.getPhone());
        return ResultUtils.success("查询成功",list);
    }
    /**
     * 新增业主
     */
    @PostMapping
    public ResultVo add(@RequestBody LiveUser liveUser){
        //查询登录名是否被占用
        QueryWrapper<LiveUser> query = new QueryWrapper<>();
        query.lambda().eq(LiveUser::getLoginName,liveUser.getLoginName());
        LiveUser one = liveUserService.getOne(query);
        if(one != null){
            return ResultUtils.error("登录名被占用!");
        }
        //用户名需要加密
        liveUser.setPassword(DigestUtils.md5DigestAsHex(liveUser.getPassword().getBytes()));
        liveUserService.saveLiveUser(liveUser);
        return ResultUtils.success("新增业主成功!");
    }
}

```

###### 6、api/liveUser.js添加getListApi()方法

```js
import http from '@/utils/http'
//新增
export async function addApi(parm){
    return await http.post("/api/liveUser",parm)
}
//获取角色列表
export async function getRoleListApi(){
    return await http.get("/api/role/getList",null)
}
//业主列表
export async function getListApi(parm){
    console.log(parm)
    return await http.get("/api/liveUser/list",parm)
}
```

###### 7、liveUser.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="350" label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="0">男</el-radio>
              <el-radio :label="1">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="0">启用</el-radio>
              <el-radio :label="1">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getRoleListApi, addApi, getListApi } from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位
    assignPark(row) {},
    //分配房屋
    assignHose(row) {},
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第59讲 编辑业主

```
1.编辑的时候，不能编辑业主密码，业主密码只能自己修改，或者物主进行重置密码；
2.编辑到登录名的时候，需要判断登录名是否重复；
3.编辑的时候，需要回显业主的角色，所以，编辑的信息需要联合业主角色关联表进行查询；
4.编辑保存的时候，针对角色关联表，会删除原来的，再把编辑的数据保存进去；
```

###### 1、在LiveUserMapper接口中添加查询业主信息的方法getUser()

```js
package com.itmk.web.live_user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.live_user.entity.LiveUser;
import org.apache.ibatis.annotations.Param;

public interface LiveUserMapper extends BaseMapper<LiveUser> {
    IPage<LiveUser> getList(IPage<LiveUser> page, @Param("userName") String userName,@Param("phone") String phone);

    LiveUser getUser(@Param("userId") Long userId);
}

```

2、编写映射文件LiveUserMapper.xml

```js
	<select id="getUser" parameterType="long" resultType="com.itmk.web.live_user.entity.LiveUser">

        select lu.*,lr.role_id from live_user as lu, live_role  as lr
        where lu.user_id = lr.user_id  and lu.user_id =#{userId}
    </select>
```

###### 3、在LiveUserService接口中添加getUser()方法 和 editLiveUser()

```js
 	//编辑业主
    void editLiveUser(LiveUser liveUser);
    //编辑查询
    LiveUser getUser(Long userId);
```

###### 4、实现上面的方法

```js
package com.itmk.web.live_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.live_role.entity.LiveRole;
import com.itmk.web.live_role.mapper.LiveRoleMapper;
import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.mapper.LiveUserMapper;
import com.itmk.web.live_user.service.LiveUserService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

@Service
public class LiveUserServiceImpl extends ServiceImpl<LiveUserMapper, LiveUser> implements LiveUserService {
    @Resource
//    private UserRoleMapper userRoleMapper;
    private LiveRoleMapper liveRoleMapper;

    @Override
    @Transactional
    public void saveLiveUser(LiveUser liveUser) {
        //1.保存业主信息
        this.baseMapper.insert(liveUser);
        //2.维护角色信息
        LiveRole userRole = new LiveRole();
        userRole.setRoleId(liveUser.getRoleId());
        userRole.setUserId(liveUser.getUserId());
        liveRoleMapper.insert(userRole);
    }

    @Override
    public IPage<LiveUser> getList(IPage<LiveUser> page, String userName, String phone) {
        return this.baseMapper.getList(page,userName,phone);
    }

    @Override
    @Transactional
    public void editLiveUser(LiveUser liveUser) {
        //1.更新业主表
        this.baseMapper.updateById(liveUser);
        //2.角色关联表的数据删除
        QueryWrapper<LiveRole> query = new QueryWrapper<>();
        query.lambda().eq(LiveRole::getUserId,liveUser.getUserId());
        liveRoleMapper.delete(query);
        //3.插入新的角色
        LiveRole liveRole = new LiveRole();
        liveRole.setRoleId(liveUser.getRoleId());
        liveRole.setUserId(liveUser.getUserId());
        liveRoleMapper.insert(liveRole);
    }

    @Override
    public LiveUser getUser(Long userId) {
        return this.baseMapper.getUser(userId);
    }
}
```

###### 5、编辑控制器 LiveUserController

在控制器中添加getUserById()和edit()方法

```js
 	/**
     * 编辑业主
     */
    @PutMapping
    public ResultVo edit(@RequestBody LiveUser liveUser){
        //编辑判断登录名是否被占用
        //查询登录名是否被占用
        QueryWrapper<LiveUser> query = new QueryWrapper<>();
        query.lambda().eq(LiveUser::getLoginName,liveUser.getLoginName());
        LiveUser one = liveUserService.getOne(query);
        if(one != null && !one.getUserId().equals(liveUser.getUserId())){
            return ResultUtils.error("登录名被占用!");
        }
        liveUserService.editLiveUser(liveUser);
        return ResultUtils.success("编辑成功!");
    }
    /**
     * 编辑查询回显
     */
    @GetMapping("/getUserById")
    public ResultVo getUserById( LiveUser liveUser){
        LiveUser user = liveUserService.getUser(liveUser.getUserId());
        return ResultUtils.success("查询成功",user);
    }
```



###### 7、前端项目src/api/liveUser.js中添加 getUserByIdApi() 和 editApi()方法

```js
//根据id查询用户
export async function getUserByIdApi(parm){
    return await http.get("/api/liveUser/getUserById",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/liveUser",parm)
}
```

###### 8、liveUser.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType !='1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getRoleListApi, addApi, getListApi, getUserByIdApi,editApi } from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
     
      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
       //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title ='编辑业主';
      this.addDialog.visible = true;
      console.log(this.addModel)
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位
    assignPark(row) {},
    //分配房屋
    assignHose(row) {},
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }else{
            res = await editApi(this.addModel)
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第60讲 分配房屋

**功能分析**

```js
1.管理员可以对业主进行房屋分配，点击分配房屋按钮，显示出未使用的房屋列表；
2.分配房屋后，会在租户和房屋关系表中进行数据的存储；并且房屋的状态也需要设置为使用中；
```

###### 1、在src/api/liveUser.js中添加获取列表的方法

```js
//获取房屋列表
export async function getHouseListApi(parm){
    return await http.get("/api/houseList/list",parm)
}
```

###### 2、liveUser.vue页面代码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType != '1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
    <!-- 分配房屋 -->
    <sys-dialog
      :title="assignHouseDialog.title"
      :height="assignHouseDialog.height"
      :width="assignHouseDialog.width"
      :visible="assignHouseDialog.visible"
      @onClose="assignHoseClose"
      @onConfirm="assignHoseConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form
            :model="houseParms"
            ref="assignHoseForm"
            label-width="70px"
            :inline="true"
            size="small"
          >
            <el-form-item label="栋数名称">
              <el-input
                placeholder="请输入栋数名称"
                v-model="houseParms.buildNme"
              ></el-input>
            </el-form-item>
            <el-form-item label="单元名称">
              <el-input
                placeholder="请输入单元名称"
                v-model="houseParms.unitName"
              ></el-input>
            </el-form-item>
            <el-form-item label="房屋编号">
              <el-input
                placeholder="请输入房屋编号"
                v-model="houseParms.houseNum"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search">搜索</el-button>
              <el-button icon="el-icon-close">重置</el-button>
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :data="houseList" border stripe>
            <el-table-column width="50" align="center" label="选择">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignHoseParm.houseId"
                  :label="scope.row.houseId"
                  @change="getCurrentRow(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="name"
              label="栋数名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="unitName"
              label="单元名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseNum"
              label="房屋编号"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseArea"
              label="使用面积"
            ></el-table-column>
            <el-table-column align="center" prop="status" label="使用状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
                  >未使用</el-tag
                >
                <el-tag v-if="scope.row.status == '1'" type="success" size="small"
                  >已使用</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
        </el-main>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import {
  getRoleListApi,
  addApi,
  getListApi,
  getUserByIdApi,
  editApi,
  getHouseListApi,
} from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //分配房屋提交的数据
      assignHoseParm: {
        houseId:'',
        userId:''
      },
      //分配房屋弹框属性
      assignHouseDialog: {
        title: "",
        height: 400,
        width: 1050,
        visible: false,
      },
      //房屋数据域
      houseList: [],
      //获取房屋列表的参数
      houseParms: {
        buildNme: "",
        status: "0",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //房屋选择事件
    getCurrentRow(row) {
      console.log(row);
      this.assignHoseParm.houseId = row.houseId;
      console.log(this.assignHoseParm)
    },
    // 分配房屋关闭事件
    assignHoseClose() {
      this.assignHouseDialog.visible = false;
    },
    //分配房屋确认事件
    assignHoseConfirm() {
      this.assignHouseDialog.visible = false;
    },
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);

      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑业主";
      this.addDialog.visible = true;
      console.log(this.addModel);
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位
    assignPark(row) {},
    //分配房屋
    async assignHose(row) {
      console.log(row);
      //获取未分配的房屋列表
      let res = await getHouseListApi(this.houseParms);
      if (res && res.code == 200) {
        //把返回的数据放到接收房屋的数据域里面
        console.log(res);
        this.houseList = res.data.records;
        this.houseParms.total = res.data.total;
      }
      //弹框属性设置
      this.assignHouseDialog.title = "为【" + row.userName + "】分配房屋";
      this.assignHouseDialog.visible = true;
      //设置分配人
      this.assignHoseParm.userId = row.userId;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第61讲 分配房屋接口对接

###### 1、新增保存分配房屋的接口

在LiveUserService接口中添加如下方法和新建 AssignHouseParm类

```js
//分配房屋保存
void assignHouse(AssignHouseParm parm);
```

```js
package com.itmk.web.live_user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class AssignHouseParm implements Serializable {
    private Long userId;
    private Long houseId;
}

```

###### 2、实现接口方法

```js
	@Override
    @Transactional
    public void assignHouse(AssignHouseParm parm) {
        //保存到租户和房屋的关系表
        LiveHouse liveHouse = new LiveHouse();
        liveHouse.setHouseId(parm.getHouseId());
        liveHouse.setUserId(parm.getUserId());
        liveHouse.setUseStatus("0");
        liveHouseMapper.insert(liveHouse);
        //更改房屋的使用状态
        HouseList house = new HouseList();
        house.setHouseId(parm.getHouseId());
        house.setStatus("1");
        houseListMapper.updateById(house);
    }
```

###### 3、LiveUserController控制器添加assignSave()方法

```js
	/**
     * 分配房屋保存
     */
    @PostMapping("/assignSave")
    public ResultVo assignSave(@RequestBody AssignHouseParm parm){
        liveUserService.assignHouse(parm);
        return ResultUtils.success("分配房屋成功!");
    }
```

###### 4、src/api下的liveUser.js添加assignSaveApi()方法

```js
//分配房屋保存
export async function assignSaveApi(parm){
    return await http.post("/api/liveUser/assignSave",parm)
}
```

###### 5、liveUser.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType != '1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
    <!-- 分配房屋 -->
    <sys-dialog
      :title="assignHouseDialog.title"
      :height="assignHouseDialog.height"
      :width="assignHouseDialog.width"
      :visible="assignHouseDialog.visible"
      @onClose="assignHoseClose"
      @onConfirm="assignHoseConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form
            :model="houseParms"
            ref="assignHoseForm"
            label-width="70px"
            :inline="true"
            size="small"
          >
            <el-form-item label="栋数名称">
              <el-input
                placeholder="请输入栋数名称"
                v-model="houseParms.buildNme"
              ></el-input>
            </el-form-item>
            <el-form-item label="单元名称">
              <el-input
                placeholder="请输入单元名称"
                v-model="houseParms.unitName"
              ></el-input>
            </el-form-item>
            <el-form-item label="房屋编号">
              <el-input
                placeholder="请输入房屋编号"
                v-model="houseParms.houseNum"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="assignHouseSearchBtn"
                >搜索</el-button
              >
              <el-button icon="el-icon-close" @click="assignHouseResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="assignTableHeight" :data="houseList" border stripe>
            <el-table-column width="50" align="center" label="选择">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignHoseParm.houseId"
                  :label="scope.row.houseId"
                  @change="getCurrentRow(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="name"
              label="栋数名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="unitName"
              label="单元名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseNum"
              label="房屋编号"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseArea"
              label="使用面积"
            ></el-table-column>
            <el-table-column align="center" prop="status" label="分配状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
                  >未分配</el-tag
                >
                <el-tag v-if="scope.row.status == '1'" type="success" size="small"
                  >已分配</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignHouseSize"
            @current-change="assignHouseChange"
            :current-page.sync="houseParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="houseParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="houseParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import {
  getRoleListApi,
  addApi,
  getListApi,
  getUserByIdApi,
  editApi,
  getHouseListApi,
  assignSaveApi,
} from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //分配房屋列表高度
      assignTableHeight: 0,
      //分配房屋提交的数据
      assignHoseParm: {
        houseId: "",
        userId: "",
      },
      //分配房屋弹框属性
      assignHouseDialog: {
        title: "",
        height: 400,
        width: 1050,
        visible: false,
      },
      //房屋数据域
      houseList: [],
      //获取房屋列表的参数
      houseParms: {
        buildNme: "",
        status: "0",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
      this.assignTableHeight = window.innerHeight - 660;
    });
  },
  methods: {
    //分配房屋列表页数改变
    assignHouseChange(val) {
      this.houseParms.currentPage = val;
      this.getAssignHoseList();
    },
    //分配房屋列表页容量改变事件
    assignHouseSize(val) {
      this.houseParms.pageSize = val;
      this.getAssignHoseList();
    },
    //分配房屋列表搜索事件
    assignHouseSearchBtn() {
      this.getAssignHoseList();
    },
    //分配房屋列表重置事件
    assignHouseResetBtn() {
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.getAssignHoseList();
    },
    //房屋选择事件
    getCurrentRow(row) {
      console.log(row);
      this.assignHoseParm.houseId = row.houseId;
      console.log(this.assignHoseParm);
    },
    // 分配房屋关闭事件
    assignHoseClose() {
      this.assignHouseDialog.visible = false;
    },
    //分配房屋确认事件
    async assignHoseConfirm() {
      if (!this.assignHoseParm.houseId) {
        this.$message.warning("请选择要分配的房屋!");
        return;
      }
      //数据提交
      let res = await assignSaveApi(this.assignHoseParm);
      if (res && res.code == 200) {
        //刷新列表
        this.getList();
        this.assignHouseDialog.visible = false;
        this.$message.success(res.msg);
      }
    },
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);

      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑业主";
      this.addDialog.visible = true;
      console.log(this.addModel);
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位
    assignPark(row) {},
    //分配房屋
    async assignHose(row) {
      console.log(row);
      if(row.houseNum){
        this.$message.warning('已经分配房屋，不能重复分配!');
        return;
      }
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.assignHoseParm.houseId = "";
      this.assignHoseParm.userId = "";
      //获取未分配的房屋列表
      this.getAssignHoseList();
      //弹框属性设置
      this.assignHouseDialog.title = "为【" + row.userName + "】分配房屋";
      this.assignHouseDialog.visible = true;
      //设置分配人
      this.assignHoseParm.userId = row.userId;
    },
    async getAssignHoseList() {
      let res = await getHouseListApi(this.houseParms);
      if (res && res.code == 200) {
        //把返回的数据放到接收房屋的数据域里面
        console.log(res);
        this.houseList = res.data.records;
        this.houseParms.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第62讲  分配车位页面制作

**功能分析**

```js
1、管理员对业主分配车位，查询出未分配的车位列表；
2、分配保存到 租户和车位的关系表中，同时需要把车位状态设为已使用状态；
```

###### 1、在src/api/liveUser.js中添加如下方法

```js
//获取车位列表
export async function getParkListApi(parm){
    return await http.get("/api/parkList/list",parm)
}
```

###### 2、liveUser.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType != '1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
    <!-- 分配房屋 -->
    <sys-dialog
      :title="assignHouseDialog.title"
      :height="assignHouseDialog.height"
      :width="assignHouseDialog.width"
      :visible="assignHouseDialog.visible"
      @onClose="assignHoseClose"
      @onConfirm="assignHoseConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form
            :model="houseParms"
            ref="assignHoseForm"
            label-width="70px"
            :inline="true"
            size="small"
          >
            <el-form-item label="栋数名称">
              <el-input
                placeholder="请输入栋数名称"
                v-model="houseParms.buildNme"
              ></el-input>
            </el-form-item>
            <el-form-item label="单元名称">
              <el-input
                placeholder="请输入单元名称"
                v-model="houseParms.unitName"
              ></el-input>
            </el-form-item>
            <el-form-item label="房屋编号">
              <el-input
                placeholder="请输入房屋编号"
                v-model="houseParms.houseNum"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="assignHouseSearchBtn"
                >搜索</el-button
              >
              <el-button icon="el-icon-close" @click="assignHouseResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="assignTableHeight" :data="houseList" border stripe>
            <el-table-column width="50" align="center" label="选择">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignHoseParm.houseId"
                  :label="scope.row.houseId"
                  @change="getCurrentRow(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="name"
              label="栋数名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="unitName"
              label="单元名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseNum"
              label="房屋编号"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseArea"
              label="使用面积"
            ></el-table-column>
            <el-table-column align="center" prop="status" label="分配状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
                  >未分配</el-tag
                >
                <el-tag v-if="scope.row.status == '1'" type="success" size="small"
                  >已分配</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignHouseSize"
            @current-change="assignHouseChange"
            :current-page.sync="houseParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="houseParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="houseParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
    <!-- 分配车位 -->
    <sys-dialog
      :title="parkDialog.title"
      :height="parkDialog.height"
      :width="parkDialog.width"
      :visible="parkDialog.visible"
      @onClose="parkOnClose"
      @onConfirm="parkOnConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form :model="parkParms" label-width="80px" :inline="true" size="small">
            <el-form-item label="车位名称">
              <el-input v-model="parkParms.parkName"></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="parkSearchBtn">查询</el-button>
              <el-button style="color: #ff7670" icon="el-icon-close" @click="parkResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="parkTableHeight" :data="parkList" border stripe>
            <el-table-column align="center" label="操作" width="50">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignParkParm.parkId"
                  :label="scope.row.parkId"
                  @change="getAssignParkId(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="parkName"
              label="车位名称"
            ></el-table-column>
            <el-table-column align="center" prop="parkType" label="车位类型">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
                  >地上</el-tag
                >
                <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
                  >地下</el-tag
                >
              </template>
            </el-table-column>
            <el-table-column align="center" prop="parkName" label="使用状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkStatus == '0'" type="danger" size="small"
                  >未使用</el-tag
                >
                <el-tag v-if="scope.row.parkStatus == '1'" type="success" size="small"
                  >已使用</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignParkSizeChange"
            @current-change="assignParkCurrentChange"
            :current-page.sync="parkParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="parkParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="parkParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import {
  getRoleListApi,
  addApi,
  getListApi,
  getUserByIdApi,
  editApi,
  getHouseListApi,
  assignSaveApi,
  getParkListApi,
} from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //分配车位列表高度
      parkTableHeight: 0,
      //分配车位参数
      assignParkParm: {
        parkId: "",
        userId: "",
      },
      //车位弹框属性
      parkDialog: {
        title: "",
        height: 400,
        width: 900,
        visible: false,
      },
      //车位列表
      parkList: [],
      //车位查询参数
      parkParms: {
        currentPage: 1,
        pageSize: 10,
        parkName: "",
        parkStatus: "0", //0未使用 1 已使用
        parkType: "",
        total: 0,
      },
      //分配房屋列表高度
      assignTableHeight: 0,
      //分配房屋提交的数据
      assignHoseParm: {
        houseId: "",
        userId: "",
      },
      //分配房屋弹框属性
      assignHouseDialog: {
        title: "",
        height: 400,
        width: 1050,
        visible: false,
      },
      //房屋数据域
      houseList: [],
      //获取房屋列表的参数
      houseParms: {
        buildNme: "",
        status: "0",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
      this.assignTableHeight = window.innerHeight - 660;
      this.parkTableHeight = window.innerHeight - 660;
    });
  },
  methods: {
    //分配车位页数改变触发
    assignParkCurrentChange(val) {
      this.parkParms.currentPage = val;
      this.getAssignParkList();
    },
    //分配车位页容量改变触发
    assignParkSizeChange(val) {
      this.parkParms.pageSize = val;
      this.getAssignParkList();
    },
    //分配车位点击
    getAssignParkId(row) {
      this.assignParkParm.parkId = row.parkId;
      console.log(this.assignParkParm);
    },
    //分配车位弹框确认
    parkOnConfirm() {
      this.parkDialog.visible = false;
    },
    //分配车位弹框关闭
    parkOnClose() {
      this.parkDialog.visible = false;
    },
    //分配房屋列表页数改变
    assignHouseChange(val) {
      this.houseParms.currentPage = val;
      this.getAssignHoseList();
    },
    //分配房屋列表页容量改变事件
    assignHouseSize(val) {
      this.houseParms.pageSize = val;
      this.getAssignHoseList();
    },
    //分配房屋列表搜索事件
    assignHouseSearchBtn() {
      this.getAssignHoseList();
    },
    //分配房屋列表重置事件
    assignHouseResetBtn() {
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.getAssignHoseList();
    },
    //房屋选择事件
    getCurrentRow(row) {
      console.log(row);
      this.assignHoseParm.houseId = row.houseId;
      console.log(this.assignHoseParm);
    },
    // 分配房屋关闭事件
    assignHoseClose() {
      this.assignHouseDialog.visible = false;
    },
    //分配房屋确认事件
    async assignHoseConfirm() {
      if (!this.assignHoseParm.houseId) {
        this.$message.warning("请选择要分配的房屋!");
        return;
      }
      //数据提交
      let res = await assignSaveApi(this.assignHoseParm);
      if (res && res.code == 200) {
        //刷新列表
        this.getList();
        this.assignHouseDialog.visible = false;
        this.$message.success(res.msg);
      }
    },
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);

      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑业主";
      this.addDialog.visible = true;
      console.log(this.addModel);
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位列表重置事件
    parkResetBtn() {
      this.parkParms.parkName = "";
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位查询按钮
    parkSearchBtn() {
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位
    async assignPark(row) {
      console.log(row);
      //清空数据
      this.assignParkParm.parkId = "";
      this.parkParms.parkName = "";
      this.assignParkParm.userId = row.userId;
      //获取车位列表
      this.getAssignParkList();
      //弹框属性设置
      this.parkDialog.title = "为【" + row.userName + "】分配车位";
      this.parkDialog.visible = true;
    },
    async getAssignParkList() {
      let res = await getParkListApi(this.parkParms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给车位列表
        this.parkList = res.data.records;
        this.parkParms.total = res.data.total;
      }
    },
    //分配房屋
    async assignHose(row) {
      console.log(row);
      if (row.houseNum) {
        this.$message.warning("已经分配房屋，不能重复分配!");
        return;
      }
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.assignHoseParm.houseId = "";
      this.assignHoseParm.userId = "";
      //获取未分配的房屋列表
      this.getAssignHoseList();
      //弹框属性设置
      this.assignHouseDialog.title = "为【" + row.userName + "】分配房屋";
      this.assignHouseDialog.visible = true;
      //设置分配人
      this.assignHoseParm.userId = row.userId;
    },
    async getAssignHoseList() {
      let res = await getHouseListApi(this.houseParms);
      if (res && res.code == 200) {
        //把返回的数据放到接收房屋的数据域里面
        console.log(res);
        this.houseList = res.data.records;
        this.houseParms.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第63讲 分配车位接口对接

###### 1、在LiveUserService接口添加如下方法

```js
//分配车位保存
void assignSavePark(LivePark livePark);
```

###### 2、实现上面接口中的方法

```js
 	@Override
    public void assignSavePark(LivePark livePark) {
        //1.把数据存储到租户和车位的关系表里面
        livePark.setLiveStatue("0");
        liveParkMapper.insert(livePark);
        //2.把车位表的状态改为已使用
        ParkList parkList = new ParkList();
        parkList.setParkId(livePark.getParkId());
        parkList.setParkStatus("1");
        parkListMapper.updateById(parkList);
    }
```

###### 3、LiveUserController控制器添加如下方法

```js
	/**
     * 分配车位保存
     */
    @PostMapping("/assignParkSave")
    public ResultVo assignParkSave(@RequestBody LivePark livePark){
        liveUserService.assignSavePark(livePark);
        return ResultUtils.success("分配车位成功!");
    }
```

###### 4、在src/api/liveUser.js中添加如下方法

```js
//分配车位保存
export async function assignParkSaveApi(parm){
    return await http.post("/api/liveUser/assignParkSave",parm)
}
```

###### 5、liveUser.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType != '1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
    <!-- 分配房屋 -->
    <sys-dialog
      :title="assignHouseDialog.title"
      :height="assignHouseDialog.height"
      :width="assignHouseDialog.width"
      :visible="assignHouseDialog.visible"
      @onClose="assignHoseClose"
      @onConfirm="assignHoseConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form
            :model="houseParms"
            ref="assignHoseForm"
            label-width="70px"
            :inline="true"
            size="small"
          >
            <el-form-item label="栋数名称">
              <el-input
                placeholder="请输入栋数名称"
                v-model="houseParms.buildNme"
              ></el-input>
            </el-form-item>
            <el-form-item label="单元名称">
              <el-input
                placeholder="请输入单元名称"
                v-model="houseParms.unitName"
              ></el-input>
            </el-form-item>
            <el-form-item label="房屋编号">
              <el-input
                placeholder="请输入房屋编号"
                v-model="houseParms.houseNum"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="assignHouseSearchBtn"
                >搜索</el-button
              >
              <el-button icon="el-icon-close" @click="assignHouseResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="assignTableHeight" :data="houseList" border stripe>
            <el-table-column width="50" align="center" label="选择">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignHoseParm.houseId"
                  :label="scope.row.houseId"
                  @change="getCurrentRow(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="name"
              label="栋数名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="unitName"
              label="单元名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseNum"
              label="房屋编号"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseArea"
              label="使用面积"
            ></el-table-column>
            <el-table-column align="center" prop="status" label="分配状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
                  >未分配</el-tag
                >
                <el-tag v-if="scope.row.status == '1'" type="success" size="small"
                  >已分配</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignHouseSize"
            @current-change="assignHouseChange"
            :current-page.sync="houseParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="houseParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="houseParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
    <!-- 分配车位 -->
    <sys-dialog
      :title="parkDialog.title"
      :height="parkDialog.height"
      :width="parkDialog.width"
      :visible="parkDialog.visible"
      @onClose="parkOnClose"
      @onConfirm="parkOnConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form :model="parkParms" label-width="80px" :inline="true" size="small">
            <el-form-item label="车位名称">
              <el-input v-model="parkParms.parkName"></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="parkSearchBtn">查询</el-button>
              <el-button style="color: #ff7670" icon="el-icon-close" @click="parkResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="parkTableHeight" :data="parkList" border stripe>
            <el-table-column align="center" label="操作" width="50">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignParkParm.parkId"
                  :label="scope.row.parkId"
                  @change="getAssignParkId(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="parkName"
              label="车位名称"
            ></el-table-column>
            <el-table-column align="center" prop="parkType" label="车位类型">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
                  >地上</el-tag
                >
                <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
                  >地下</el-tag
                >
              </template>
            </el-table-column>
            <el-table-column align="center" prop="parkName" label="使用状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkStatus == '0'" type="danger" size="small"
                  >未使用</el-tag
                >
                <el-tag v-if="scope.row.parkStatus == '1'" type="success" size="small"
                  >已使用</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignParkSizeChange"
            @current-change="assignParkCurrentChange"
            :current-page.sync="parkParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="parkParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="parkParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import {
  getRoleListApi,
  addApi,
  getListApi,
  getUserByIdApi,
  editApi,
  getHouseListApi,
  assignSaveApi,
  getParkListApi,
  assignParkSaveApi,
} from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //分配车位列表高度
      parkTableHeight: 0,
      //分配车位参数
      assignParkParm: {
        parkId: "",
        userId: "",
      },
      //车位弹框属性
      parkDialog: {
        title: "",
        height: 400,
        width: 900,
        visible: false,
      },
      //车位列表
      parkList: [],
      //车位查询参数
      parkParms: {
        currentPage: 1,
        pageSize: 10,
        parkName: "",
        parkStatus: "0", //0未使用 1 已使用
        parkType: "",
        total: 0,
      },
      //分配房屋列表高度
      assignTableHeight: 0,
      //分配房屋提交的数据
      assignHoseParm: {
        houseId: "",
        userId: "",
      },
      //分配房屋弹框属性
      assignHouseDialog: {
        title: "",
        height: 400,
        width: 1050,
        visible: false,
      },
      //房屋数据域
      houseList: [],
      //获取房屋列表的参数
      houseParms: {
        buildNme: "",
        status: "0",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
      this.assignTableHeight = window.innerHeight - 660;
      this.parkTableHeight = window.innerHeight - 660;
    });
  },
  methods: {
    //分配车位页数改变触发
    assignParkCurrentChange(val) {
      this.parkParms.currentPage = val;
      this.getAssignParkList();
    },
    //分配车位页容量改变触发
    assignParkSizeChange(val) {
      this.parkParms.pageSize = val;
      this.getAssignParkList();
    },
    //分配车位点击
    getAssignParkId(row) {
      this.assignParkParm.parkId = row.parkId;
      console.log(this.assignParkParm);
    },
    //分配车位弹框确认
    async parkOnConfirm() {
      //验证是否选择车位
      if (!this.assignParkParm.parkId) {
        this.$message.warning("请选择车位！");
        return;
      }
      let res = await assignParkSaveApi(this.assignParkParm);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.parkDialog.visible = false;
        //刷新列表
        this.getList();
      }
    },
    //分配车位弹框关闭
    parkOnClose() {
      this.parkDialog.visible = false;
    },
    //分配房屋列表页数改变
    assignHouseChange(val) {
      this.houseParms.currentPage = val;
      this.getAssignHoseList();
    },
    //分配房屋列表页容量改变事件
    assignHouseSize(val) {
      this.houseParms.pageSize = val;
      this.getAssignHoseList();
    },
    //分配房屋列表搜索事件
    assignHouseSearchBtn() {
      this.getAssignHoseList();
    },
    //分配房屋列表重置事件
    assignHouseResetBtn() {
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.getAssignHoseList();
    },
    //房屋选择事件
    getCurrentRow(row) {
      console.log(row);
      this.assignHoseParm.houseId = row.houseId;
      console.log(this.assignHoseParm);
    },
    // 分配房屋关闭事件
    assignHoseClose() {
      this.assignHouseDialog.visible = false;
    },
    //分配房屋确认事件
    async assignHoseConfirm() {
      if (!this.assignHoseParm.houseId) {
        this.$message.warning("请选择要分配的房屋!");
        return;
      }
      //数据提交
      let res = await assignSaveApi(this.assignHoseParm);
      if (res && res.code == 200) {
        //刷新列表
        this.getList();
        this.assignHouseDialog.visible = false;
        this.$message.success(res.msg);
      }
    },
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);

      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑业主";
      this.addDialog.visible = true;
      console.log(this.addModel);
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    leavePark(row) {},
    //退房
    leaveHose(row) {},
    //分配车位列表重置事件
    parkResetBtn() {
      this.parkParms.parkName = "";
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位查询按钮
    parkSearchBtn() {
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位
    async assignPark(row) {
      console.log(row);
      if (row.parkName) {
        this.$message.warning("已分配车位，不能重复分配!");
        return;
      }
      //清空数据
      this.assignParkParm.parkId = "";
      this.parkParms.parkName = "";
      this.assignParkParm.userId = row.userId;
      //获取车位列表
      this.getAssignParkList();
      //弹框属性设置
      this.parkDialog.title = "为【" + row.userName + "】分配车位";
      this.parkDialog.visible = true;
    },
    async getAssignParkList() {
      let res = await getParkListApi(this.parkParms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给车位列表
        this.parkList = res.data.records;
        this.parkParms.total = res.data.total;
      }
    },
    //分配房屋
    async assignHose(row) {
      console.log(row);
      if (row.houseNum) {
        this.$message.warning("已经分配房屋，不能重复分配!");
        return;
      }
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.assignHoseParm.houseId = "";
      this.assignHoseParm.userId = "";
      //获取未分配的房屋列表
      this.getAssignHoseList();
      //弹框属性设置
      this.assignHouseDialog.title = "为【" + row.userName + "】分配房屋";
      this.assignHouseDialog.visible = true;
      //设置分配人
      this.assignHoseParm.userId = row.userId;
    },
    async getAssignHoseList() {
      let res = await getHouseListApi(this.houseParms);
      if (res && res.code == 200) {
        //把返回的数据放到接收房屋的数据域里面
        console.log(res);
        this.houseList = res.data.records;
        this.houseParms.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第64讲 收费管理数据库设计



#### 第65讲 电费管理模块接口开发

**功能分析**

```js
页面展示 
	1、点击新增按钮，选择栋数、单元、房间号  --->  获取栋数、单元(根据栋数id获取)、房屋列表(根据单元id获取)的方法
    2、提交：保存到电费表，其中涉及到业主的id，业主的id就是当前正在使用房屋的用户，可以从 租户和房屋关系表中获取业主的id
    3、编辑的时候，需要数据回显展示
```

###### 1、新建实体类

```js
package com.itmk.web.fee_power.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

@Data
@TableName("fee_power")
public class FeePower implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long powerId;
    //房屋id
    private Long houseId;
    //.用户id
    private Long userId;
    //所属月份
    private String payPowerMonth;
    //缴费金额
    private BigDecimal payPowerMoney;
    //表显
    private String powerNum;
    //缴费状态
    private String payPowerStatus;
    //缴费时间
    private Date payPowerTime;
}
```



###### 2、新建mapper层

```js
package com.itmk.web.fee_power.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.fee_power.entity.FeePower;

public interface FeePowerMapper extends BaseMapper<FeePower> {
}
```

**新建映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.fee_power.mapper.FeePowerMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.fee_power.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.fee_power.entity.FeePower;

public interface FeePowerService extends IService<FeePower>{
    //新增电费
    void saveFeePower(FeePower feePower);
    //编辑电费
    void updateFeePower(FeePower feePower);
}

```

**实现类**

```js
package com.itmk.web.fee_power.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.mapper.FeePowerMapper;
import com.itmk.web.fee_power.service.FeePowerService;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.mapper.LiveHouseMapper;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

@Service
public class FeePowerServiceImpl extends ServiceImpl<FeePowerMapper, FeePower> implements FeePowerService {
    @Resource
    private LiveHouseMapper liveHouseMapper;

    @Override
    public void saveFeePower(FeePower feePower) {
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
        .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseMapper.selectOne(query);
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        //保存电费到数据库
        this.baseMapper.insert(feePower);
    }

    @Override
    public void updateFeePower(FeePower feePower) {
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseMapper.selectOne(query);
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        //保存电费到数据库
        this.baseMapper.updateById(feePower);
    }
}

```

###### 4、新建控制器

```js
package com.itmk.web.fee_power.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.service.FeePowerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 电费管理控制器
 */
@RestController
@RequestMapping("/api/feePower")
public class FeePowerController {
    @Autowired
    private FeePowerService feePowerService;

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody FeePower feePower){
        feePowerService.saveFeePower(feePower);
        return ResultUtils.success("新增电费成功!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeePower feePower){
        feePowerService.updateFeePower(feePower);
        return ResultUtils.success("编辑电费成功!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{powerId}")
    public ResultVo delete(@PathVariable("powerId") Long powerId){
        //如果已经缴费，就不能删除
        QueryWrapper<FeePower> query = new QueryWrapper<>();
        query.lambda().eq(FeePower::getPowerId,powerId).eq(FeePower::getPayPowerStatus,"1");
        FeePower one = feePowerService.getOne(query);
        if(one != null){
            return ResultUtils.error("已缴费，不能删除!");
        }
        //删除操作
        boolean b = feePowerService.removeById(powerId);
        if(b){
            return ResultUtils.success("删除电费成功!");
        }
        return ResultUtils.error("删除电费失败!");
    }
}
```



#### 第66讲 新增电费页面制作与接口对接

**功能分析**

```js
页面展示 
	1、点击新增按钮，选择栋数、单元、房间号  --->  获取栋数、单元(根据栋数id获取)、房屋列表(根据单元id获取)的方法
    2、提交：保存到电费表，其中涉及到业主的id，业主的id就是当前正在使用房屋的用户，可以从 租户和房屋关系表中获取业主的id
```

###### 1、新建页面和路由

在src/router里面添加如下路由

```js
{
    path: '/fee',
    component: Layout,
    alwaysShow: true,
    name: 'fee',
    meta: { title: '收费管理', icon: 'el-icon-s-open' },
    children: [
      {
        path: '/feePower',
        name: 'feePower',
        component: () => import('@/views/fee/feePower'),
        meta: { title: '电费管理', icon: 'el-icon-picture' }
      },
      {
        path: '/feeWater',
        name: 'feeWater',
        component: () => import('@/views/fee/feeWater'),
        meta: { title: '水费管理', icon: 'el-icon-s-data' }
      },
      {
        path: '/feePark',
        name: 'feePark',
        component: () => import('@/views/fee/feePark'),
        meta: { title: '停车管理', icon: 'el-icon-s-order' }
      }
    ]
  },
```

###### 2、在views下新建上面路由的三个页面

在views下新建 fee文件夹，并建三个页面

###### 3、feePower.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="selectUnit">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payPowerMonth" label="所属月份">
            <el-date-picker
              v-model="addModel.payPowerMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payPowerMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payPowerMoney"></el-input>
          </el-form-item>
          <el-form-item prop="powerNum" label="表显" size="small">
            <el-input v-model="addModel.powerNum"></el-input>
          </el-form-item>
          <el-form-item prop="payPowerStatus" label="表显" size="small">
            <el-radio-group v-model="addModel.payPowerStatus">
              <el-radio :label="0">未缴费</el-radio>
              <el-radio :label="6">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import { getHouseByUnitIdApi } from "@/api/feePower";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payPowerMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payPowerMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        powerNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payPowerStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增表单绑定数据源
      addModel: {
        houseId: "",
        unitId: "",
        buildId: "",
        editType: "",
        powerId: "",
        payPowerMonth: "",
        payPowerMoney: "",
        powerNum: "",
        payPowerStatus: "",
      },
      houseList: [],
      unitList: [],
      buildList: [],
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //搜索参数
      parms: {
        userName: "",
        houseNum: "",
      },
    };
  },
  created() {
    this.getBuildList();
  },
  methods: {
    //单元选择事件
    selectUnit(val) {
      console.log(val);
      this.getHouseByUnitId(val);
    },
    //栋数选择事件
    selectBuild(val) {
      console.log(val);
      this.getUnitList(val);
    },
    //新增按钮
    addBtn() {
      //清空表单
      //设置弹框属性
      this.addDialog.title = "新增电费";
      this.addDialog.visible = true;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate((valid) => {
        if (valid) {
          this.addDialog.visible = false;
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async getBuildList() {
      let res = await getBuildApi();
      console.log(res);
      this.buildList = res.data;
    },
    //根据栋数id获取单元列表
    async getUnitList(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.data) {
        this.unitList = res.data;
      }
    },
    //根据单元id获取房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      if (res && res.code == 200) {
        console.log(res);
        this.houseList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第67讲 电费列表页面制作与接口对接

###### 1、mapper层新建获取参数列表的接口

```js
package com.itmk.web.fee_power.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.fee_power.entity.FeePower;
import org.apache.ibatis.annotations.Param;

public interface FeePowerMapper extends BaseMapper<FeePower> {
    IPage<FeePower> getList(IPage<FeePower> page, @Param("userName") String userName,@Param("houseNum") String houseNum);
}

```

###### 2、映射文件新增查询语句

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.fee_power.mapper.FeePowerMapper">
    <select id="getList" resultType="com.itmk.web.fee_power.entity.FeePower">
        select fp.*,lu.user_name,lu.phone,hl.house_num,hu.unit_name,hb.name,hb.build_id,hb.name,hu.unit_id from fee_power as fp
        left join live_user as lu  on lu.user_id = fp.user_id
        left join house_list as hl on hl.house_id = fp.house_id
        left join house_unit as hu on hu.unit_id = hl.unit_id
        left join house_building as hb on hb.build_id = hu.build_id
        where 1=1
        <if test="userName !=null and userName !=''">
            and lu.user_name like concat('%',#{userName},'%')
        </if>
        <if test="houseNum !=null and houseNum !=''">
            and hl.house_num like concat('%',#{houseNum},'%')
        </if>
    </select>
</mapper>
```

###### 3、新建service层查询列表接口方法getList()

```js
package com.itmk.web.fee_power.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.entity.FeePowerParm;

public interface FeePowerService extends IService<FeePower>{
    //新增电费
    void saveFeePower(FeePower feePower);
    //编辑电费
    void updateFeePower(FeePower feePower);
    //查询列表
    IPage<FeePower> getList(FeePowerParm feePowerParm);
}
```

**实体类**

```js
package com.itmk.web.fee_power.entity;

import lombok.Data;

import java.io.Serializable;
@Data
public class FeePowerParm implements Serializable {
    private Long currentPage;
    private Long pageSize;
    private String userName;
    private String houseNum;
}

```

**实现类**

```js
package com.itmk.web.fee_power.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.entity.FeePowerParm;
import com.itmk.web.fee_power.mapper.FeePowerMapper;
import com.itmk.web.fee_power.service.FeePowerService;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.mapper.LiveHouseMapper;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

@Service
public class FeePowerServiceImpl extends ServiceImpl<FeePowerMapper, FeePower> implements FeePowerService {
    @Resource
    private LiveHouseMapper liveHouseMapper;

    @Override
    public void saveFeePower(FeePower feePower) {
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
        .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseMapper.selectOne(query);
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        //保存电费到数据库
        this.baseMapper.insert(feePower);
    }

    @Override
    public void updateFeePower(FeePower feePower) {
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseMapper.selectOne(query);
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        //保存电费到数据库
        this.baseMapper.updateById(feePower);
    }

    @Override
    public IPage<FeePower> getList(FeePowerParm feePowerParm) {
        //构造分页对象
        IPage<FeePower> page = new Page<>();
        page.setCurrent(feePowerParm.getCurrentPage());
        page.setSize(feePowerParm.getPageSize());
        return this.baseMapper.getList(page,feePowerParm.getUserName(),feePowerParm.getHouseNum());
    }
}

```

###### 4、控制器

在控制器添加getList()方法

```js
package com.itmk.web.fee_power.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.entity.FeePowerParm;
import com.itmk.web.fee_power.service.FeePowerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 电费管理控制器
 */
@RestController
@RequestMapping("/api/feePower")
public class FeePowerController {
    @Autowired
    private FeePowerService feePowerService;

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody FeePower feePower){
        feePowerService.saveFeePower(feePower);
        return ResultUtils.success("新增电费成功!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeePower feePower){
        feePowerService.updateFeePower(feePower);
        return ResultUtils.success("编辑电费成功!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{powerId}")
    public ResultVo delete(@PathVariable("powerId") Long powerId){
        //如果已经缴费，就不能删除
        QueryWrapper<FeePower> query = new QueryWrapper<>();
        query.lambda().eq(FeePower::getPowerId,powerId).eq(FeePower::getPayPowerStatus,"1");
        FeePower one = feePowerService.getOne(query);
        if(one != null){
            return ResultUtils.error("已缴费，不能删除!");
        }
        //删除操作
        boolean b = feePowerService.removeById(powerId);
        if(b){
            return ResultUtils.success("删除电费成功!");
        }
        return ResultUtils.error("删除电费失败!");
    }

    /**
     * 列表查询
     */
    @GetMapping("/list")
    public ResultVo getList(FeePowerParm parm){
        IPage<FeePower> list = feePowerService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```

###### 5、src/api/feePower.js添加如下方法

```js
import http from '@/utils/http'
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addPowerApi(parm){
    return await http.post("/api/feePower",parm)
}
//查询列表
export async function getListApi(parm){
    return await http.get("/api/feePower/list",parm)
}
```

###### 6、feePower.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <el-table :height="tableHeight" :data="powerList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="payPowerMoney" label="缴费金额"></el-table-column>
      <el-table-column prop="payPowerMonth" label="所属月份"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payPowerStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payPowerStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="200" align="center" label="操作">
        <template slot-scope="scope">
          <el-button icon="el-icon-edit" type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
           <el-button icon="el-icon-delete" type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="selectUnit">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payPowerMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payPowerMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payPowerMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payPowerMoney"></el-input>
          </el-form-item>
          <el-form-item prop="powerNum" label="表显" size="small">
            <el-input v-model="addModel.powerNum"></el-input>
          </el-form-item>
          <el-form-item prop="payPowerStatus" label="表显" size="small">
            <el-radio-group v-model="addModel.payPowerStatus">
              <el-radio :label="0">未缴费</el-radio>
              <el-radio :label="6">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import { getHouseByUnitIdApi, addPowerApi, getListApi } from "@/api/feePower";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //列表数据
      powerList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payPowerMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payPowerMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        powerNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payPowerStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增表单绑定数据源
      addModel: {
        houseId: "",
        unitId: "",
        buildId: "",
        editType: "",
        powerId: "",
        payPowerMonth: "",
        payPowerMoney: "",
        powerNum: "",
        payPowerStatus: "",
      },
      houseList: [],
      unitList: [],
      buildList: [],
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //搜索参数
      parms: {
        userName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getBuildList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //删除按钮
    deleteBtn(row){

    },
    //编辑按钮
    editBtn(row) {},
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log("列表");
        console.log(res);
        //赋值到列表
        this.powerList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //单元选择事件
    selectUnit(val) {
      console.log(val);
      this.getHouseByUnitId(val);
    },
    //栋数选择事件
    selectBuild(val) {
      console.log(val);
      this.getUnitList(val);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增电费";
      this.addDialog.visible = true;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addPowerApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async getBuildList() {
      let res = await getBuildApi();
      console.log(res);
      this.buildList = res.data;
    },
    //根据栋数id获取单元列表
    async getUnitList(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.data) {
        this.unitList = res.data;
      }
    },
    //根据单元id获取房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      if (res && res.code == 200) {
        console.log(res);
        this.houseList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第68讲 电费编辑接口对接

**功能分析**

```js
编辑的时候，需要回显栋数、单元、房屋编号
```

###### 1、在src/api下添加编辑请求方法editPowerApi()

```js
import http from '@/utils/http'
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addPowerApi(parm){
    return await http.post("/api/feePower",parm)
}
//查询列表
export async function getListApi(parm){
    return await http.get("/api/feePower/list",parm)
}
//编辑
export async function editPowerApi(parm){
    return await http.put("/api/feePower",parm)
}
```

###### 2、feePower.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close">重置</el-button>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <el-table :height="tableHeight" :data="powerList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="payPowerMoney" label="缴费金额"></el-table-column>
      <el-table-column prop="payPowerMonth" label="所属月份"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payPowerStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payPowerStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="200" align="center" label="操作">
        <template slot-scope="scope">
          <el-button icon="el-icon-edit" type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
           <el-button icon="el-icon-delete" type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="selectUnit">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payPowerMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payPowerMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payPowerMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payPowerMoney"></el-input>
          </el-form-item>
          <el-form-item style="margin-left:15px;" prop="powerNum" label="表显" size="small">
            <el-input v-model="addModel.powerNum"></el-input>
          </el-form-item>
          <el-form-item prop="payPowerStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payPowerStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import { getHouseByUnitIdApi, addPowerApi, getListApi,editPowerApi } from "@/api/feePower";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //列表数据
      powerList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payPowerMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payPowerMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        powerNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payPowerStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增表单绑定数据源
      addModel: {
        houseId: "",
        unitId: "",
        buildId: "",
        editType: "",
        powerId: "",
        payPowerMonth: "",
        payPowerMoney: "",
        powerNum: "",
        payPowerStatus: "",
      },
      houseList: [],
      unitList: [],
      buildList: [],
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //搜索参数
      parms: {
        userName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getBuildList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //搜索按钮
    searchBtn(){
      this.getList();
    },
    //重置按钮
    resetBtn(){
      this.parms.userName = '';
      this.parms.houseNum = '';
      this.getList();
    },
    //删除按钮
    deleteBtn(row){

    },
    //编辑按钮
    editBtn(row) {
      console.log(row)
      //查询单元列表
      this.getUnitList(row.buildId);
      //查询房屋列表
       this.getHouseByUnitId(row.unitId);
        //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑电费";
      this.addDialog.visible = true;
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row,this.addModel)

    },
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log("列表");
        console.log(res);
        //赋值到列表
        this.powerList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //单元选择事件
    selectUnit(val) {
      console.log(val);
      this.getHouseByUnitId(val);
    },
    //栋数选择事件
    selectBuild(val) {
      this.addModel.unitId = '';
      this.addModel.houseId = '';
      console.log(val);
      this.getUnitList(val);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增电费";
      this.addDialog.visible = true;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addPowerApi(this.addModel);
          }else{
            res = await editPowerApi(this.addModel)
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async getBuildList() {
      let res = await getBuildApi();
      console.log(res);
      this.buildList = res.data;
    },
    //根据栋数id获取单元列表
    async getUnitList(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.data) {
        this.unitList = res.data;
      }
    },
    //根据单元id获取房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      if (res && res.code == 200) {
        console.log(res);
        this.houseList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

###### 3、后端live_house模块添加service层

```js
package com.itmk.web.live_house.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.live_house.entity.LiveHouse;

public interface LiveHouseService extends IService<LiveHouse> {
}

```

**实现类**

```js
package com.itmk.web.live_house.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.mapper.LiveHouseMapper;
import com.itmk.web.live_house.service.LiveHouseService;
import org.springframework.stereotype.Service;

@Service
public class LiveHouseServiceImpl extends ServiceImpl<LiveHouseMapper, LiveHouse> implements LiveHouseService {
}

```

###### 4、修改FeePowerService的实现类FeePowerServiceImpl改为如下

```js
package com.itmk.web.fee_power.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.entity.FeePowerParm;
import com.itmk.web.fee_power.mapper.FeePowerMapper;
import com.itmk.web.fee_power.service.FeePowerService;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.mapper.LiveHouseMapper;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

@Service
public class FeePowerServiceImpl extends ServiceImpl<FeePowerMapper, FeePower> implements FeePowerService {
    @Resource
    private LiveHouseMapper liveHouseMapper;

    @Override
    public void saveFeePower(FeePower feePower) {

        //保存电费到数据库
        this.baseMapper.insert(feePower);
    }

    @Override
    public void updateFeePower(FeePower feePower) {

        //保存电费到数据库
        this.baseMapper.updateById(feePower);
    }

    @Override
    public IPage<FeePower> getList(FeePowerParm feePowerParm) {
        //构造分页对象
        IPage<FeePower> page = new Page<>();
        page.setCurrent(feePowerParm.getCurrentPage());
        page.setSize(feePowerParm.getPageSize());
        return this.baseMapper.getList(page,feePowerParm.getUserName(),feePowerParm.getHouseNum());
    }
}
```

###### 5、FeePowerController控制器的新增和编辑方法改为如下所示

```js
	@Autowired
    private LiveHouseService liveHouseService;

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody FeePower feePower){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能添加电费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        feePowerService.saveFeePower(feePower);
        return ResultUtils.success("新增电费成功!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeePower feePower){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能编辑电费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        feePowerService.updateFeePower(feePower);
        return ResultUtils.success("编辑电费成功!");
    }
```



#### 第69讲 电费删除接口对接

###### 1、在src/api下的feePower.js中添加deletePowerApi()方法

```js
import http from '@/utils/http'
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addPowerApi(parm){
    return await http.post("/api/feePower",parm)
}
//查询列表
export async function getListApi(parm){
    return await http.get("/api/feePower/list",parm)
}
//编辑
export async function editPowerApi(parm){
    return await http.put("/api/feePower",parm)
}
//删除
export async function deletePowerApi(parm){
    return await http.delete("/api/feePower",parm)
}
```

###### 2、在feePower.vue页面引入，完整源码如下所示

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close">重置</el-button>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <el-table :height="tableHeight" :data="powerList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="payPowerMoney" label="缴费金额"></el-table-column>
      <el-table-column prop="payPowerMonth" label="所属月份"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payPowerStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payPowerStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="200" align="center" label="操作">
        <template slot-scope="scope">
          <el-button icon="el-icon-edit" type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
           <el-button icon="el-icon-delete" type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="selectUnit">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payPowerMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payPowerMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payPowerMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payPowerMoney"></el-input>
          </el-form-item>
          <el-form-item style="margin-left:15px;" prop="powerNum" label="表显" size="small">
            <el-input v-model="addModel.powerNum"></el-input>
          </el-form-item>
          <el-form-item prop="payPowerStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payPowerStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import { getHouseByUnitIdApi, addPowerApi, getListApi,editPowerApi,deletePowerApi } from "@/api/feePower";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //列表数据
      powerList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payPowerMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payPowerMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        powerNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payPowerStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增表单绑定数据源
      addModel: {
        houseId: "",
        unitId: "",
        buildId: "",
        editType: "",
        powerId: "",
        payPowerMonth: "",
        payPowerMoney: "",
        powerNum: "",
        payPowerStatus: "",
      },
      houseList: [],
      unitList: [],
      buildList: [],
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //搜索参数
      parms: {
        userName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getBuildList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //搜索按钮
    searchBtn(){
      this.getList();
    },
    //重置按钮
    resetBtn(){
      this.parms.userName = '';
      this.parms.houseNum = '';
      this.getList();
    },
    //删除按钮
    async deleteBtn(row){
      console.log(row)
      //信息提示
      const confirm = await this.$myconfirm('确定删除该数据吗？');
      if(confirm){
        let res = await deletePowerApi({powerId:row.powerId})
        if(res && res.code == 200){
          //刷新表格
          this.$message.success(res.msg)
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      console.log(row)
      //查询单元列表
      this.getUnitList(row.buildId);
      //查询房屋列表
       this.getHouseByUnitId(row.unitId);
        //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑电费";
      this.addDialog.visible = true;
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row,this.addModel)

    },
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log("列表");
        console.log(res);
        //赋值到列表
        this.powerList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //单元选择事件
    selectUnit(val) {
      console.log(val);
      this.getHouseByUnitId(val);
    },
    //栋数选择事件
    selectBuild(val) {
      this.addModel.unitId = '';
      this.addModel.houseId = '';
      console.log(val);
      this.getUnitList(val);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增电费";
      this.addDialog.visible = true;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addPowerApi(this.addModel);
          }else{
            res = await editPowerApi(this.addModel)
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async getBuildList() {
      let res = await getBuildApi();
      console.log(res);
      this.buildList = res.data;
    },
    //根据栋数id获取单元列表
    async getUnitList(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.data) {
        this.unitList = res.data;
      }
    },
    //根据单元id获取房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      if (res && res.code == 200) {
        console.log(res);
        this.houseList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

#### 第70讲 电费缴费功能开发

**功能分析**

```js
如果业主已经缴费，那相关的关联员，可以把缴费数据设为已缴费；
```

###### 1、后端FeePowerController控制器添加payPower()方法

```js
package com.itmk.web.fee_power.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.fee_power.entity.FeePower;
import com.itmk.web.fee_power.entity.FeePowerParm;
import com.itmk.web.fee_power.service.FeePowerService;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.mapper.LiveHouseMapper;
import com.itmk.web.live_house.service.LiveHouseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 电费管理控制器
 */
@RestController
@RequestMapping("/api/feePower")
public class FeePowerController {
    @Autowired
    private FeePowerService feePowerService;
    @Autowired
    private LiveHouseService liveHouseService;

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody FeePower feePower){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能添加电费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        feePowerService.saveFeePower(feePower);
        return ResultUtils.success("新增电费成功!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeePower feePower){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feePower.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能编辑电费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feePower.setUserId(house.getUserId());
        feePowerService.updateFeePower(feePower);
        return ResultUtils.success("编辑电费成功!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{powerId}")
    public ResultVo delete(@PathVariable("powerId") Long powerId){
        //如果已经缴费，就不能删除
        QueryWrapper<FeePower> query = new QueryWrapper<>();
        query.lambda().eq(FeePower::getPowerId,powerId).eq(FeePower::getPayPowerStatus,"1");
        FeePower one = feePowerService.getOne(query);
        if(one != null){
            return ResultUtils.error("已缴费，不能删除!");
        }
        //删除操作
        boolean b = feePowerService.removeById(powerId);
        if(b){
            return ResultUtils.success("删除电费成功!");
        }
        return ResultUtils.error("删除电费失败!");
    }

    /**
     * 列表查询
     */
    @GetMapping("/list")
    public ResultVo getList(FeePowerParm parm){
        IPage<FeePower> list = feePowerService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 缴费
     */
    @PostMapping("/payPower")
    public ResultVo payPower(@RequestBody FeePower feePower){
        boolean b = feePowerService.updateById(feePower);
        if(b){
            return ResultUtils.success("缴费成功!");
        }
        return ResultUtils.error("缴费失败!");
    }
}

```

###### 2、前端src/api下的feePower.js添加payPowerApi()方法

```js
import http from '@/utils/http'
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addPowerApi(parm){
    return await http.post("/api/feePower",parm)
}
//查询列表
export async function getListApi(parm){
    return await http.get("/api/feePower/list",parm)
}
//编辑
export async function editPowerApi(parm){
    return await http.put("/api/feePower",parm)
}
//删除
export async function deletePowerApi(parm){
    return await http.delete("/api/feePower",parm)
}
//缴费
export async function payPowerApi(parm){
    return await http.post("/api/feePower/payPower",parm)
}
```

###### 3、feePower.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close">重置</el-button>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <el-table :height="tableHeight" :data="powerList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="payPowerMoney" label="缴费金额"></el-table-column>
      <el-table-column prop="payPowerMonth" label="所属月份"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payPowerStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payPowerStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button icon="el-icon-edit" type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
           <el-button icon="el-icon-delete" type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
           <el-button v-if="scope.row.payPowerStatus == '0'" icon="el-icon-delete" type="warning" size="small" @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="selectUnit">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payPowerMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payPowerMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payPowerMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payPowerMoney"></el-input>
          </el-form-item>
          <el-form-item style="margin-left:15px;" prop="powerNum" label="表显" size="small">
            <el-input v-model="addModel.powerNum"></el-input>
          </el-form-item>
          <el-form-item prop="payPowerStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payPowerStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import { getHouseByUnitIdApi, addPowerApi, getListApi,editPowerApi,deletePowerApi,payPowerApi } from "@/api/feePower";
export default {
  //注册组件
  components: { SysDialog },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //列表数据
      powerList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payPowerMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payPowerMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        powerNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payPowerStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增表单绑定数据源
      addModel: {
        houseId: "",
        unitId: "",
        buildId: "",
        editType: "",
        powerId: "",
        payPowerMonth: "",
        payPowerMoney: "",
        powerNum: "",
        payPowerStatus: "",
      },
      houseList: [],
      unitList: [],
      buildList: [],
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //搜索参数
      parms: {
        userName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getBuildList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    async payBtn(row){
      console.log(row)
      //提示信息
      const confirm = await this.$myconfirm('确定缴费吗？');
      if(confirm){
        let parm = {
          powerId:row.powerId,
          payPowerStatus:"1"
        }
        let res = await payPowerApi(parm)
        if(res && res.code == 200){
          this.$message.success(res.msg)
          //刷新列表
          this.getList();
        }
      }
    },
    //搜索按钮
    searchBtn(){
      this.getList();
    },
    //重置按钮
    resetBtn(){
      this.parms.userName = '';
      this.parms.houseNum = '';
      this.getList();
    },
    //删除按钮
    async deleteBtn(row){
      console.log(row)
      //信息提示
      const confirm = await this.$myconfirm('确定删除该数据吗？');
      if(confirm){
        let res = await deletePowerApi({powerId:row.powerId})
        if(res && res.code == 200){
          //刷新表格
          this.$message.success(res.msg)
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      console.log(row)
      //查询单元列表
      this.getUnitList(row.buildId);
      //查询房屋列表
       this.getHouseByUnitId(row.unitId);
        //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑电费";
      this.addDialog.visible = true;
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row,this.addModel)

    },
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log("列表");
        console.log(res);
        //赋值到列表
        this.powerList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
    //单元选择事件
    selectUnit(val) {
      console.log(val);
      this.getHouseByUnitId(val);
    },
    //栋数选择事件
    selectBuild(val) {
      this.addModel.unitId = '';
      this.addModel.houseId = '';
      console.log(val);
      this.getUnitList(val);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增电费";
      this.addDialog.visible = true;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addPowerApi(this.addModel);
          }else{
            res = await editPowerApi(this.addModel)
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async getBuildList() {
      let res = await getBuildApi();
      console.log(res);
      this.buildList = res.data;
    },
    //根据栋数id获取单元列表
    async getUnitList(buildId) {
      let res = await getUnitListByIdApi({ buildId: buildId });
      console.log(res);
      if (res && res.data) {
        this.unitList = res.data;
      }
    },
    //根据单元id获取房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      if (res && res.code == 200) {
        console.log(res);
        this.houseList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第71讲  水费管理模块接口开发

###### 1、新建实体

```js
package com.itmk.web.fee_water.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

@Data
@TableName("fee_water")
public class FeeWater implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long waterId;
    //房屋id
    private Long houseId;
    //用户id
    private Long userId;
    //所属月份
    private String payWaterMonth;
    //缴费金额
    private BigDecimal payWaterMoney;
    //表显
    private String waterrNum;
    //缴费状态
    private String payWaterStatus;
    //缴费时间
    private Date payWaterTime;
    //数据库没有的字段需要排除
    @TableField(exist = false)
    private String userName;
    @TableField(exist = false)
    private String phone;
    @TableField(exist = false)
    private String houseNum;
    @TableField(exist = false)
    private String unitName;
    @TableField(exist = false)
    private Long buildId;
    @TableField(exist = false)
    private Long unitId;
    @TableField(exist = false)
    private String name;
}
```

```js
package com.itmk.web.fee_power.entity;

import lombok.Data;

import java.io.Serializable;
@Data
public class FeePowerParm implements Serializable {
    private Long currentPage;
    private Long pageSize;
    private String userName;
    private String houseNum;
}
```

###### 2、新建mapper层

```js
package com.itmk.web.fee_power.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.fee_power.entity.FeePower;
import org.apache.ibatis.annotations.Param;

public interface FeePowerMapper extends BaseMapper<FeePower> {
    IPage<FeePower> getList(IPage<FeePower> page, @Param("userName") String userName,@Param("houseNum") String houseNum);
}
```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.fee_water.mapper.FeeWaterMapper">
    <select id="getList" resultType="com.itmk.web.fee_water.entity.FeeWater">
        select fp.*,lu.user_name,lu.phone,hl.house_num,hu.unit_name,hb.name,hb.build_id,hu.unit_id from fee_water as fp
        left join live_user as lu  on lu.user_id = fp.user_id
        left join house_list as hl on hl.house_id = fp.house_id
        left join house_unit as hu on hu.unit_id = hl.unit_id
        left join house_building as hb on hb.build_id = hu.build_id
        where 1=1
        <if test="userName !=null and userName !=''">
            and lu.user_name like concat('%',#{userName},'%')
        </if>
        <if test="houseNum !=null and houseNum !=''">
            and hl.house_num like concat('%',#{houseNum},'%')
        </if>
    </select>
</mapper>
```

###### 3、新建service层

新建FeeWaterService接口

```js
package com.itmk.web.fee_water.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.fee_water.entity.FeeWater;
import com.itmk.web.fee_water.entity.FeeWaterParm;

public interface FeeWaterService extends IService<FeeWater> {
    //查询列表
    IPage<FeeWater> getList(FeeWaterParm feeWaterParm);
}
```

**实现类**

```js
package com.itmk.web.fee_water.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.fee_water.entity.FeeWater;
import com.itmk.web.fee_water.entity.FeeWaterParm;
import com.itmk.web.fee_water.mapper.FeeWaterMapper;
import com.itmk.web.fee_water.service.FeeWaterService;
import org.springframework.stereotype.Service;

@Service
public class FeeWaterServiceImpl extends ServiceImpl<FeeWaterMapper, FeeWater> implements FeeWaterService {
    @Override
    public IPage<FeeWater> getList(FeeWaterParm feeWaterParm) {
        //构造分页对象
        IPage<FeeWater> page =  new Page<>();
        page.setCurrent(feeWaterParm.getCurrentPage());
        page.setSize(feeWaterParm.getPageSize());
        return this.baseMapper.getList(page,feeWaterParm.getUserName(),feeWaterParm.getHouseNum());

    }
}
```

###### 4、新建控制器FeeWaterController

```js
package com.itmk.web.fee_water.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.fee_water.entity.FeeWater;
import com.itmk.web.fee_water.entity.FeeWaterParm;
import com.itmk.web.fee_water.service.FeeWaterService;
import com.itmk.web.live_house.entity.LiveHouse;
import com.itmk.web.live_house.service.LiveHouseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 水费管理模块
 */
@RestController
@RequestMapping("/api/feeWater")
public class FeeWaterController {
    @Autowired
    private FeeWaterService feeWaterService;
    @Autowired
    private LiveHouseService liveHouseService;
    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody FeeWater feeWater){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feeWater.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能添加水费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feeWater.setUserId(house.getUserId());
        feeWaterService.save(feeWater);
        return ResultUtils.success("新增水费成功!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeeWater feeWater){
        //根据房屋id查询正在使用该房间用户
        QueryWrapper<LiveHouse> query = new QueryWrapper<>();
        query.lambda().eq(LiveHouse::getHouseId,feeWater.getHouseId())
                .eq(LiveHouse::getUseStatus,"0");
        LiveHouse house = liveHouseService.getOne(query);
        if(house == null){
            return ResultUtils.error("该房间没有人使用，不能编辑水费!");
        }
        //把查询出来的用户id设置到电费实体里面
        feeWater.setUserId(house.getUserId());
        feeWaterService.updateById(feeWater);
        return ResultUtils.success("编辑水费成功!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{waterId}")
    public ResultVo delete(@PathVariable("waterId") Long waterId){
        //如果已经缴费，就不能删除
        QueryWrapper<FeeWater> query = new QueryWrapper<>();
        query.lambda().eq(FeeWater::getWaterId,waterId).eq(FeeWater::getPayWaterStatus,"1");
        FeeWater one = feeWaterService.getOne(query);
        if(one != null){
            return ResultUtils.error("已缴费，不能删除!");
        }
        //删除操作
        boolean b = feeWaterService.removeById(waterId);
        if(b){
            return ResultUtils.success("删除水费成功!");
        }
        return ResultUtils.error("删除水费失败!");
    }

    /**
     * 列表查询
     */
    @GetMapping("/list")
    public ResultVo getList(FeeWaterParm parm){
        IPage<FeeWater> list = feeWaterService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 缴费
     */
    @PostMapping("/payPower")
    public ResultVo payPower(@RequestBody FeeWater feeWater){
        boolean b = feeWaterService.updateById(feeWater);
        if(b){
            return ResultUtils.success("缴费成功!");
        }
        return ResultUtils.error("缴费失败!");
    }
}
```



#### 第72讲 水费管理列表制作

###### 1、在src/api下新建feeWater.js

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feeWater/list",parm)
}
```

###### 2、feeWater.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="栋数" prop="name"></el-table-column>
      <el-table-column label="单元" prop="unitName"></el-table-column>
      <el-table-column label="房屋编号" prop="houseNum"></el-table-column>
      <el-table-column label="缴费金额" prop="payWaterMoney"></el-table-column>
      <el-table-column label="所属月份" prop="payWaterMonth"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payWaterStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payWaterStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payPowerStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/feeWater";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //页数改变时触发
      currentChange(val) {},
      //页容量改变时触发
      sizeChange(val) {},
      //表格参数
      tableList: [],
      //表格参数
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userName: "",
        houseNum: "",
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //缴费按钮
    payBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      console.log(row);
    },
    //   新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //获取表格列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //把返回的值赋值到列表数据域
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 73讲 新增水费页面制作与接口对接

**功能分析**

```
1、栋数列表查询
2、根据栋数id查询单元列表
3、根据单元id查询房屋列表
4、表单数据提交
```

###### 1、在src/api下的feeWater.js新增getHouseByUnitIdApi()方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feeWater/list",parm)
}
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
```

###### 2、feeWater.vue页面完整代码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="栋数" prop="name"></el-table-column>
      <el-table-column label="单元" prop="unitName"></el-table-column>
      <el-table-column label="房屋编号" prop="houseNum"></el-table-column>
      <el-table-column label="缴费金额" prop="payWaterMoney"></el-table-column>
      <el-table-column label="所属月份" prop="payWaterMonth"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payWaterStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payWaterStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payPowerStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="unitSelect">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payWaterMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payWaterMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payWaterMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payWaterMoney"></el-input>
          </el-form-item>
          <el-form-item
            style="margin-left: 15px"
            prop="waterrNum"
            label="表显"
            size="small"
          >
            <el-input v-model="addModel.waterrNum"></el-input>
          </el-form-item>
          <el-form-item prop="payWaterStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payWaterStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getHouseByUnitIdApi } from "@/api/feeWater";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  //组件注册
  components: {
    SysDialog,
  },
  data() {
    return {
      //房屋编号列表
      houseList: [],
      //单元列表
      unitList: [],
      //栋数列表
      buildList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payWaterMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payWaterMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        waterrNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payWaterStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增弹框绑定数据域
      addModel: {
        editType: "",
        waterId: "",
        buildId: "",
        unitId:'',
        houseId: "",
        payWaterMonth: "",
        payWaterMoney: "",
        waterrNum: "",
        payWaterStatus: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //页数改变时触发
      currentChange(val) {},
      //页容量改变时触发
      sizeChange(val) {},
      //表格参数
      tableList: [],
      //表格参数
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userName: "",
        houseNum: "",
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //单元点击事件
    async unitSelect(val) {
       this.addModel.houseId = ''
      let res = await getHouseByUnitIdApi({ unitId: val });
      console.log(res);
      if (res && res.code == 200) {
        this.houseList = res.data;
      }
    },
    //根据栋数id查询单元列表
    async getUnitListById(val) {
      let res = await getUnitListByIdApi({ buildId: val });
      console.log("单元");
      console.log(res);
      if (res && res.code == 200) {
        this.unitList = res.data;
      }
    },
    //栋数点击事件
    selectBuild(val) {
      this.addModel.unitId = '';
      this.addModel.houseId = ''
      console.log(val);
      this.getUnitListById(val);
    },
    //获取栋数列表
    async getBuildList() {
      let res = await getBuildApi();
      if (res && res.code == 200) {
        //把栋数赋值到列表
        this.buildList = res.data;
      }
    },
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate((valid) => {
        if (valid) {
          this.addDialog.visible = false;
        }
      });
    },
    //弹框关闭事件
    onClose() {
      this.addDialog.visible = false;
    },
    //缴费按钮
    payBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      console.log(row);
    },
    //   新增按钮
    addBtn() {
      //清空表单
      this.$resetForm('addForm',this.addModel)
      //设置编辑属性
      this.addModel.editType = '0'
      //设置弹框属性
      this.addDialog.title = "新增水费";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //获取表格列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //把返回的值赋值到列表数据域
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第74 编辑水费接口对接

**功能分析**

```js
1、栋数列表查询
2、根据栋数id查询单元列表
3、根据单元id查询房屋列表
4、表单数据提交
```

###### 1、在src/api下的feeWater.js添加如下方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feeWater/list",parm)
}
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/feeWater",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/feeWater",parm)
}
```

###### 2、feeWater.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="栋数" prop="name"></el-table-column>
      <el-table-column label="单元" prop="unitName"></el-table-column>
      <el-table-column label="房屋编号" prop="houseNum"></el-table-column>
      <el-table-column label="缴费金额" prop="payWaterMoney"></el-table-column>
      <el-table-column label="所属月份" prop="payWaterMonth"></el-table-column>
      <el-table-column label="表显" prop="waterrNum"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payWaterStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payWaterStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payPowerStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="unitSelect">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payWaterMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payWaterMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payWaterMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payWaterMoney"></el-input>
          </el-form-item>
          <el-form-item
            style="margin-left: 15px"
            prop="waterrNum"
            label="表显"
            size="small"
          >
            <el-input v-model="addModel.waterrNum"></el-input>
          </el-form-item>
          <el-form-item prop="payWaterStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payWaterStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getHouseByUnitIdApi, addApi,editApi } from "@/api/feeWater";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  //组件注册
  components: {
    SysDialog,
  },
  data() {
    return {
      //房屋编号列表
      houseList: [],
      //单元列表
      unitList: [],
      //栋数列表
      buildList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payWaterMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payWaterMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        waterrNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payWaterStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增弹框绑定数据域
      addModel: {
        editType: "",
        waterId: "",
        buildId: "",
        unitId: "",
        houseId: "",
        payWaterMonth: "",
        payWaterMoney: "",
        waterrNum: "",
        payWaterStatus: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //页数改变时触发
      currentChange(val) {},
      //页容量改变时触发
      sizeChange(val) {},
      //表格参数
      tableList: [],
      //表格参数
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userName: "",
        houseNum: "",
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //单元点击事件
    async unitSelect(val) {
      this.addModel.houseId = "";
      this.getHouseByUnitId(val);
    },
    //根据单元id查询房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      console.log(res);
      if (res && res.code == 200) {
        this.houseList = res.data;
      }
    },
    //根据栋数id查询单元列表
    async getUnitListById(val) {
      let res = await getUnitListByIdApi({ buildId: val });
      console.log("单元");
      console.log(res);
      if (res && res.code == 200) {
        this.unitList = res.data;
      }
    },
    //栋数点击事件
    selectBuild(val) {
      this.addModel.unitId = "";
      this.addModel.houseId = "";
      console.log(val);
      this.getUnitListById(val);
    },
    //获取栋数列表
    async getBuildList() {
      let res = await getBuildApi();
      if (res && res.code == 200) {
        //把栋数赋值到列表
        this.buildList = res.data;
      }
    },
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }else{
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            this.addDialog.visible = false;
            //信息提示
            this.$message.success(res.msg);
          }
        }
      });
    },
    //弹框关闭事件
    onClose() {
      this.addDialog.visible = false;
    },
    //缴费按钮
    payBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      console.log(row);
      //1.查询栋数列表回显，在created里面已经查询
      //2.根据栋数的id查询单元列表
      this.getUnitListById(row.buildId);
      //3.根据单元id查询房屋列表
      this.getHouseByUnitId(row.unitId);
      //清空表单
      this.$resetForm('addForm',this.addModel)
      //设置弹框属性
      this.addDialog.title = '编辑水费';
      this.addDialog.visible = true;
      //把当前要编辑的行复制到表单数据域
      this.$objCoppy(row,this.addModel)
       //设置编辑属性
      this.addModel.editType = '1';
      console.log(this.addModel)
    },
    //   新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增水费";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //获取表格列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //把返回的值赋值到列表数据域
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

#### 第75讲 删除和缴费接口对接

###### 1、在src/api下的feeWater.js添加删除和缴费方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feeWater/list",parm)
}
//根据单元id查询房屋列表
export async function getHouseByUnitIdApi(parm){
    return await http.get("/api/houseList/getHouseByUnitId",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/feeWater",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/feeWater",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/feeWater",parm)
}
//缴费
export async function payApi(parm){
    return await http.post("/api/feeWater/payPower",parm)
}
```

###### 2、修改后的FeeWaterController控制器中的payPower()方法如下

```js
 	/**
     * 缴费
     */
    @PostMapping("/payPower")
    public ResultVo payPower(@RequestBody FeeWater feeWater){
        //缴费时间
        feeWater.setPayWaterTime(new Date());
        feeWater.setPayWaterStatus("1");
        boolean b = feeWaterService.updateById(feeWater);
        if(b){
            return ResultUtils.success("缴费成功!");
        }
        return ResultUtils.error("缴费失败!");
    }
```



###### 3、feeWater.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="房屋编号">
        <el-input v-model="parms.houseNum"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="栋数" prop="name"></el-table-column>
      <el-table-column label="单元" prop="unitName"></el-table-column>
      <el-table-column label="房屋编号" prop="houseNum"></el-table-column>
      <el-table-column label="缴费金额" prop="payWaterMoney"></el-table-column>
      <el-table-column label="所属月份" prop="payWaterMonth"></el-table-column>
      <el-table-column label="表显" prop="waterrNum"></el-table-column>
      <el-table-column prop="payPowerStatus" label="缴费状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payWaterStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payWaterStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payWaterStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="buildId" label="栋数">
            <el-select v-model="addModel.buildId" @change="selectBuild">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.name"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="unitId" label="单元">
            <el-select v-model="addModel.unitId" @change="unitSelect">
              <el-option
                v-for="item in unitList"
                :key="item.unitId"
                :label="item.unitName"
                :value="item.unitId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="houseId" label="房屋编号">
            <el-select v-model="addModel.houseId">
              <el-option
                v-for="item in houseList"
                :key="item.houseId"
                :label="item.houseNum"
                :value="item.houseId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payWaterMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payWaterMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payWaterMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payWaterMoney"></el-input>
          </el-form-item>
          <el-form-item
            style="margin-left: 15px"
            prop="waterrNum"
            label="表显"
            size="small"
          >
            <el-input v-model="addModel.waterrNum"></el-input>
          </el-form-item>
          <el-form-item prop="payWaterStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payWaterStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getHouseByUnitIdApi, addApi,editApi,deleteApi,payApi } from "@/api/feeWater";
import { getBuildApi, getUnitListByIdApi } from "@/api/houseList";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  //组件注册
  components: {
    SysDialog,
  },
  data() {
    return {
      //房屋编号列表
      houseList: [],
      //单元列表
      unitList: [],
      //栋数列表
      buildList: [],
      //表单验证规则
      rules: {
        buildId: [
          {
            trigger: "change",
            required: true,
            message: "请选择栋数",
          },
        ],
        unitId: [
          {
            trigger: "change",
            required: true,
            message: "请选择单元",
          },
        ],
        houseId: [
          {
            trigger: "change",
            required: true,
            message: "请选择房屋编号",
          },
        ],
        payWaterMonth: [
          {
            trigger: "change",
            required: true,
            message: "请选择所属月份",
          },
        ],
        payWaterMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        waterrNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写表显",
          },
        ],
        payWaterStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //新增弹框绑定数据域
      addModel: {
        editType: "",
        waterId: "",
        buildId: "",
        unitId: "",
        houseId: "",
        payWaterMonth: "",
        payWaterMoney: "",
        waterrNum: "",
        payWaterStatus: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //页数改变时触发
      currentChange(val) {},
      //页容量改变时触发
      sizeChange(val) {},
      //表格参数
      tableList: [],
      //表格参数
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userName: "",
        houseNum: "",
      },
    };
  },
  created() {
    this.getList();
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //单元点击事件
    async unitSelect(val) {
      this.addModel.houseId = "";
      this.getHouseByUnitId(val);
    },
    //根据单元id查询房屋列表
    async getHouseByUnitId(val) {
      let res = await getHouseByUnitIdApi({ unitId: val });
      console.log(res);
      if (res && res.code == 200) {
        this.houseList = res.data;
      }
    },
    //根据栋数id查询单元列表
    async getUnitListById(val) {
      let res = await getUnitListByIdApi({ buildId: val });
      console.log("单元");
      console.log(res);
      if (res && res.code == 200) {
        this.unitList = res.data;
      }
    },
    //栋数点击事件
    selectBuild(val) {
      this.addModel.unitId = "";
      this.addModel.houseId = "";
      console.log(val);
      this.getUnitListById(val);
    },
    //获取栋数列表
    async getBuildList() {
      let res = await getBuildApi();
      if (res && res.code == 200) {
        //把栋数赋值到列表
        this.buildList = res.data;
      }
    },
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }else{
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            this.addDialog.visible = false;
            //信息提示
            this.$message.success(res.msg);
          }
        }
      });
    },
    //弹框关闭事件
    onClose() {
      this.addDialog.visible = false;
    },
    //缴费按钮
    async payBtn(row) {
      console.log(row)
      //信息提示
      let confirm = await this.$myconfirm('确定缴费吗?');
      if(confirm){
        let res = await payApi({waterId:row.waterId});
        if(res && res.code == 200){
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg)
        }
      }
    },
    //删除按钮
    async deleteBtn(row) {
      console.log(row)
      //信息提示
      let confirm = await this.$myconfirm('确定删除该数据吗?');
      if(confirm){
        let res = await deleteApi({waterId:row.waterId})
        if(res && res.code == 200){
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg)
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      console.log(row);
      //1.查询栋数列表回显，在created里面已经查询
      //2.根据栋数的id查询单元列表
      this.getUnitListById(row.buildId);
      //3.根据单元id查询房屋列表
      this.getHouseByUnitId(row.unitId);
      //清空表单
      this.$resetForm('addForm',this.addModel)
      //设置弹框属性
      this.addDialog.title = '编辑水费';
      this.addDialog.visible = true;
      //把当前要编辑的行复制到表单数据域
      this.$objCoppy(row,this.addModel)
       //设置编辑属性
      this.addModel.editType = '1';
      console.log(this.addModel)
    },
    //   新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增水费";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      //把搜索框的数据清空
      this.parms.userName = '';
      this.parms.houseNum = '';
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取表格列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //把返回的值赋值到列表数据域
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第76讲  停车费管理模块接口开发

**功能分析**

```js
1、新增：新增的时候，需要查询当前正在使用车库的用户
2、编辑：编辑也需要查询当前使用的用户信息
3、删除：如果已经缴费，不能删除
4、缴费：设置缴费时间、缴费状态
```

###### 1、新建实体

```js
package com.itmk.web.fee_park.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

@Data
@TableName("fee_park")
public class FeePark implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long parkFeeId;
    //租户id
    private Long userId;
    //车位id
    private Long parkId;
    //所属月份
    private String payParkMonth;
    //缴费金额
    private BigDecimal payParkMoney;
    //缴费状态
    private String payParkStatus;
    //缴费时间
    private Date payParkTime;

    //数据库没有的字段需要排除
    @TableField(exist = false)
    private String userName;
    @TableField(exist = false)
    private String phone;
    @TableField(exist = false)
    private String parkName;
    @TableField(exist = false)
    private String parkType;
}

```

```js
package com.itmk.web.fee_park.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class FeeParkParm implements Serializable {
    private Long currentPage;
    private Long pageSize;
    private String userName;
    private String parkName;
}
```

###### 2、新建mapper层

```js
package com.itmk.web.fee_park.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.fee_park.entity.FeePark;
import org.apache.ibatis.annotations.Param;

public interface FeeParkMapper extends BaseMapper<FeePark> {
    IPage<FeePark> getList(IPage<FeePark> page, @Param("userName") String userName,@Param("parkName") String parkName);
}

```

###### 3、新建mapper映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.fee_park.mapper.FeeParkMapper">
    <select id="getList" resultType="com.itmk.web.fee_park.entity.FeePark">
        select lu.user_name,lu.phone,fp.*,pl.park_name,pl.park_type from fee_park as fp
        left join live_user as lu on lu.user_id = fp.user_id
        left join parking_list pl on pl.park_id = fp.park_id
        where 1=1
        <if test="userName !=null and userName !=''">
            and lu.user_name like concat('%',#{userName},'%')
        </if>
        <if test="parkName !=null and parkName !=''">
            and pl.park_name like concat('%',#{parkName},'%')
        </if>
    </select>
</mapper>
```

###### 4、新建service层

```js
package com.itmk.web.fee_park.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.fee_park.entity.FeePark;
import com.itmk.web.fee_park.entity.FeeParkParm;
public interface FeeParkService extends IService<FeePark> {
    IPage<FeePark> getList(FeeParkParm parkParm);
}

```

**实现类**

```js
package com.itmk.web.fee_park.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.fee_park.entity.FeePark;
import com.itmk.web.fee_park.entity.FeeParkParm;
import com.itmk.web.fee_park.mapper.FeeParkMapper;
import com.itmk.web.fee_park.service.FeeParkService;
import org.springframework.stereotype.Service;

@Service
public class FeeParkServiceImpl extends ServiceImpl<FeeParkMapper, FeePark> implements FeeParkService {
    @Override
    public IPage<FeePark> getList(FeeParkParm parkParm) {
        //构造分页对象
        IPage<FeePark> page = new Page<>();
        page.setSize(parkParm.getPageSize());
        page.setCurrent(parkParm.getCurrentPage());
        return this.baseMapper.getList(page,parkParm.getUserName(),parkParm.getParkName());
    }
}

```

###### 5、新建控制器

```js
package com.itmk.web.fee_park.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.fee_park.entity.FeePark;
import com.itmk.web.fee_park.entity.FeeParkParm;
import com.itmk.web.fee_park.service.FeeParkService;
import com.itmk.web.live_park.entity.LivePark;
import com.itmk.web.live_park.mapper.LiveParkMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * 停车费模块
 */
@RestController
@RequestMapping("/api/feePark")
public class FeeParkController {
    @Autowired
    private FeeParkService feeParkService;
    @Resource
    private LiveParkMapper liveParkMapper;

    /**
     * 新增：
     * 1.查询当前正在使用车位的用户
     * 2.入库
     */

    @PostMapping
    public ResultVo add(@RequestBody FeePark feePark){
        //1.查询当前正在使用车位的租户
        //构造查询条件
        QueryWrapper<LivePark> query = new QueryWrapper<>();
        query.lambda().eq(LivePark::getParkId,feePark.getParkId())
                .eq(LivePark::getLiveStatue,"0");
        LivePark livePark = liveParkMapper.selectOne(query);
        if(livePark == null){
            return ResultUtils.error("该车位暂无人员使用!");
        }
        feePark.setUserId(livePark.getUserId());
        //2.入库
        boolean save = feeParkService.save(feePark);
        if(save){
            return ResultUtils.success("新增停车费成功!");
        }
        return ResultUtils.error("新增停车费失败!");
    }

    /**
     * 编辑：1.查询当前正在使用的用户
     *       2.更新
     */
    @PutMapping
    public ResultVo edit(@RequestBody FeePark feePark){
        //1.查询当前正在使用车位的租户
        //构造查询条件
        QueryWrapper<LivePark> query = new QueryWrapper<>();
        query.lambda().eq(LivePark::getParkId,feePark.getParkId())
                .eq(LivePark::getLiveStatue,"0");
        LivePark livePark = liveParkMapper.selectOne(query);
        if(livePark == null){
            return ResultUtils.error("该车位暂无人员使用!");
        }
        feePark.setUserId(livePark.getUserId());
        //2.更新
        boolean b = feeParkService.updateById(feePark);
        if(b){
            return ResultUtils.success("编辑停车费成功!");
        }
        return ResultUtils.error("编辑停车费失败!");
    }

    /**
     * 删除： 1.判断是否已经缴费，如果缴费，不能删除
     *        2.删除
     */
    @DeleteMapping("/{parkFeeId}")
    public ResultVo delete(@PathVariable("parkFeeId") Long parkFeeId){
        //1.判断是否已经缴费，根据id查询缴费状态
        QueryWrapper<FeePark> query = new QueryWrapper<>();
        query.lambda().eq(FeePark::getPayParkStatus,"1")
        .eq(FeePark::getParkFeeId,parkFeeId);
        FeePark one = feeParkService.getOne(query);
        if(one != null){
            return ResultUtils.error("已缴费，不能删除该数据!");
        }
        boolean b = feeParkService.removeById(parkFeeId);
        if(b){
            return ResultUtils.success("删除停车费成功!");
        }
        return ResultUtils.error("删除停车费失败!");
    }

    /**
     * 缴费：
     *   把当前这条数据的 payParkStatus 设为1
     */
    @PostMapping("/pay")
    public ResultVo pay(@RequestBody FeePark feePark){
        //把状态设为1
        feePark.setPayParkStatus("1");
        boolean b = feeParkService.updateById(feePark);
        if(b){
            return ResultUtils.success("缴费成功!");
        }
        return ResultUtils.error("缴费失败!");
    }

    /**
     * 列表
     */
    @GetMapping("/list")
    public ResultVo getList(FeeParkParm feeParkParm){
        IPage<FeePark> list = feeParkService.getList(feeParkParm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第77讲 停车费管理列表页面制作与接口对接

###### 1、在src/api下新建feePark.js

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feePark/list",parm)
}
```

###### 2、feePark.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="车位名称">
        <el-input v-model="parms.parkName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" @click="addBtn" type="primary">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="车位" prop="parkName"></el-table-column>
      <el-table-column label="车位类型" prop="parkType">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
            >地上</el-tag
          >
          <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
            >地下</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="所属月份" prop="payParkMonth"></el-table-column>
      <el-table-column label="缴费金额" prop="payParkMoney"></el-table-column>
      <el-table-column label="缴费状态" prop="payParkStatus">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payParkStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payParkStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payParkStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/feePark";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格的数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        userName: "",
        parkName: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //缴费按钮
    payBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {
      this.parms.userName = "";
      this.parms.parkName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //查询列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //赋值给表格数据
        this.tableList = res.data.records;
        //分页总条数
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第78讲 新增停车费页面制作与接口对接

**功能分析**

```js
1、查询出车车位列表，用于选择
2、表单提交
```

###### 1、在src/api的feePark.js添加getParkListApi()和addApi()方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feePark/list",parm)
}
//查询车位列表
export async function getParkListApi(){
    return await http.get("/api/parkList/listNoPage",null)
}
//新增
export async function addApi(parm){
    return await http.post("/api/feePark",parm)
}
```

###### 2、feePark.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="车位名称">
        <el-input v-model="parms.parkName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" @click="addBtn" type="primary">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="车位" prop="parkName"></el-table-column>
      <el-table-column label="车位类型" prop="parkType">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
            >地上</el-tag
          >
          <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
            >地下</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="所属月份" prop="payParkMonth"></el-table-column>
      <el-table-column label="缴费金额" prop="payParkMoney"></el-table-column>
      <el-table-column label="缴费状态" prop="payParkStatus">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payParkStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payParkStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payParkStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="parkId" label="车位">
            <el-select v-model="addModel.parkId" clearable filterable>
              <el-option
                v-for="item in parkList"
                :key="item.parkId"
                :label="item.parkName"
                :value="item.parkId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payParkMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payParkMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payParkMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payParkMoney"></el-input>
          </el-form-item>
          <el-form-item prop="payParkStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payParkStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getParkListApi, addApi } from "@/api/feePark";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //表单数据域
      addModel: {
        parkFeeId: "",
        editType: "",
        parkId: "",
        payParkMonth: "",
        payParkMoney: "",
        payParkStatus: "",
      },
      //表单验证规则
      rules: {
        parkId: [
          {
            trigger: "change",
            required: true,
            message: "请选择车位",
          },
        ],
        payParkMonth: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费月份",
          },
        ],
        payParkMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        payParkStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      //车辆列表
      parkList: [],
      //表格高度
      tableHeight: 0,
      //表格的数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        userName: "",
        parkName: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getParkList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //获取车辆列表
    async getParkList() {
      let res = await getParkListApi();
      if (res && res.code == 200) {
        console.log("车辆");
        console.log(res);
        this.parkList = res.data;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //缴费按钮
    payBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增停车费";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.userName = "";
      this.parms.parkName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //查询列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //赋值给表格数据
        this.tableList = res.data.records;
        //分页总条数
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第79讲 编辑停车费接口对接

###### 1、在src/api下的feePark.js中添加editApi()、deleteApi()、payApi()方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/feePark/list",parm)
}
//查询车位列表
export async function getParkListApi(){
    return await http.get("/api/parkList/listNoPage",null)
}
//新增
export async function addApi(parm){
    return await http.post("/api/feePark",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/feePark",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/feePark",parm)
}
//缴费
export async function payApi(parm){
    return await http.post("/api/feePark/pay",parm)
}
```

###### 2、feePark.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="车位名称">
        <el-input v-model="parms.parkName"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" @click="addBtn" type="primary">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="姓名" prop="userName"></el-table-column>
      <el-table-column label="电话" prop="phone"></el-table-column>
      <el-table-column label="车位" prop="parkName"></el-table-column>
      <el-table-column label="车位类型" prop="parkType">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
            >地上</el-tag
          >
          <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
            >地下</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="所属月份" prop="payParkMonth"></el-table-column>
      <el-table-column label="缴费金额" prop="payParkMoney"></el-table-column>
      <el-table-column label="缴费状态" prop="payParkStatus">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.payParkStatus == '0'" type="danger" size="small"
            >未缴费</el-tag
          >
          <el-tag v-if="scope.row.payParkStatus == '1'" type="success" size="small"
            >已缴费</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column width="270" align="center" label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            v-if="scope.row.payParkStatus == '0'"
            icon="el-icon-delete"
            type="warning"
            size="small"
            @click="payBtn(scope.row)"
            >缴费</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="parkId" label="车位">
            <el-select v-model="addModel.parkId" clearable filterable>
              <el-option
                v-for="item in parkList"
                :key="item.parkId"
                :label="item.parkName"
                :value="item.parkId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="payParkMonth" label="所属月份">
            <el-date-picker
              format="yyyy-MM"
              value-format="yyyy-MM"
              v-model="addModel.payParkMonth"
              type="month"
              placeholder="选择月份"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item prop="payParkMoney" label="缴费金额" size="small">
            <el-input v-model="addModel.payParkMoney"></el-input>
          </el-form-item>
          <el-form-item prop="payParkStatus" label="缴费状态" size="small">
            <el-radio-group v-model="addModel.payParkStatus">
              <el-radio :label="'0'">未缴费</el-radio>
              <el-radio :label="'1'">已缴费</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, getParkListApi, addApi, editApi,deleteApi,payApi } from "@/api/feePark";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: { SysDialog },
  data() {
    return {
      //表单数据域
      addModel: {
        parkFeeId: "",
        editType: "",
        parkId: "",
        payParkMonth: "",
        payParkMoney: "",
        payParkStatus: "",
      },
      //表单验证规则
      rules: {
        parkId: [
          {
            trigger: "change",
            required: true,
            message: "请选择车位",
          },
        ],
        payParkMonth: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费月份",
          },
        ],
        payParkMoney: [
          {
            trigger: "change",
            required: true,
            message: "请填写缴费金额",
          },
        ],
        payParkStatus: [
          {
            trigger: "change",
            required: true,
            message: "请选择缴费状态",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      //车辆列表
      parkList: [],
      //表格高度
      tableHeight: 0,
      //表格的数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        userName: "",
        parkName: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
    this.getParkList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //获取车辆列表
    async getParkList() {
      let res = await getParkListApi();
      if (res && res.code == 200) {
        console.log("车辆");
        console.log(res);
        this.parkList = res.data;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //缴费按钮
    async payBtn(row) {
       console.log(row)
      //提示信息
      let confirm = await this.$myconfirm('确定缴费吗？');
      if(confirm){
        let res = await payApi({parkFeeId:row.parkFeeId})
        if(res && res.code == 200){
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg)
        }
      }
    },
    //删除按钮
    async deleteBtn(row) {
      console.log(row)
      //提示信息
      let confirm = await this.$myconfirm('确定删除该数据吗？');
      if(confirm){
        let res = await deleteApi({parkFeeId:row.parkFeeId})
        if(res && res.code == 200){
          //刷新列表
          this.getList();
          this.$message.success(res.msg)
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      console.log(row);
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑停车费";
      this.addDialog.visible = true;
      //把当前有编辑的数据赋值到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增停车费";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.userName = "";
      this.parms.parkName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //查询列表
    async getList() {
      let res = await getListApi(this.parms);
      console.log(res);
      if (res && res.code == 200) {
        //赋值给表格数据
        this.tableList = res.data.records;
        //分页总条数
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第80讲 退房、退车位接口对接

**功能分析**

```js
退房：
	1.查询电费、水费是否已经交清；
    2.更新租户和房屋关系表状态为解绑；
    3.更新房屋表的使用状态为未使用；
    
退车位：
	1.查询车位费是否已经交清；
    2.更新租户和车位的关系为解绑；
    3.更新车位的使用状态为未使用；

```

###### 1、在LiveUserService接口新增退房和退车位的方法

```js
 	//退房
    void returnHouse(AssignHouseParm parm);
    //退车位
    void returnPark(LivePark livePark);
```

```js
package com.itmk.web.live_user.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class AssignHouseParm implements Serializable {
    private Long userId;
    private Long houseId;
}

```

###### 2、实现上面的方法

```js
@Override
    @Transactional
    public void returnHouse(AssignHouseParm parm) {
        //更新租户和房屋关系表状态为解绑；
        LiveHouse liveHouse = new LiveHouse();
        liveHouse.setUseStatus("1");
        QueryWrapper<LiveHouse> queryWrapper = new QueryWrapper<>();
        queryWrapper.lambda().eq(LiveHouse::getHouseId,parm.getHouseId())
                .eq(LiveHouse::getUserId,parm.getUserId())
        .eq(LiveHouse::getUseStatus,"0");
        liveHouseMapper.update(liveHouse,queryWrapper);
        //更新房屋表的使用状态为未使用；
        HouseList houseList = new HouseList();
        houseList.setStatus("0");
        QueryWrapper<HouseList> query = new QueryWrapper<>();
        query.lambda().eq(HouseList::getHouseId,parm.getHouseId());
        houseListMapper.update(houseList,query);
    }

    @Override
    @Transactional
    public void returnPark(LivePark livePark) {
        //2.更新租户和车位的关系为解绑；
        QueryWrapper<LivePark> query = new QueryWrapper<>();
        query.lambda().eq(LivePark::getParkId,livePark.getParkId())
                .eq(LivePark::getUserId,livePark.getUserId())
        .eq(LivePark::getLiveStatue,"0");
        LivePark nLivepark = new LivePark();
        nLivepark.setLiveStatue("1");
        liveParkMapper.update(nLivepark,query);
       // 3.更新车位的使用状态为未使用；
        ParkList parkList = new ParkList();
        parkList.setParkStatus("0");
        parkList.setParkId(livePark.getParkId());
        parkListMapper.updateById(parkList);
    }
```



###### 3、控制器LiveUserController添加退房和退车位的方法

```js
/**
     * 退房：
     *      1.查询电费、水费是否已经交清；
     *     2.更新租户和房屋关系表状态为解绑；
     *     3.更新房屋表的使用状态为未使用；
     */
    @PostMapping("/returnHose")
    public ResultVo returnHose(@RequestBody AssignHouseParm parm){
        //1.查询电费、水费是否交清
        //构造查询条件
        QueryWrapper<FeeWater> queryWater = new QueryWrapper<>();
        queryWater.lambda().eq(FeeWater::getHouseId,parm.getHouseId())
                .eq(FeeWater::getUserId,parm.getUserId())
                .eq(FeeWater::getPayWaterStatus,"0");
        List<FeeWater> list = feeWaterService.list(queryWater);
        if(list != null && list.size() >0){
            return ResultUtils.error("请缴水费之后再退房!");
        }
        //查询电费
        QueryWrapper<FeePower> queryPower = new QueryWrapper<>();
        queryPower.lambda().eq(FeePower::getHouseId,parm.getHouseId())
                .eq(FeePower::getUserId,parm.getUserId())
                .eq(FeePower::getPayPowerStatus,"0");
        List<FeePower> list1 = feePowerService.list(queryPower);
        if(list1 != null && list1.size() >0){
            return ResultUtils.error("请缴电费之后再退房!");
        }
        liveUserService.returnHouse(parm);
        return ResultUtils.success("退房成功!");
    }

    /**
     * 退车位
     *      1.查询车位费是否已经交清；
     *     2.更新租户和车位的关系为解绑；
     *     3.更新车位的使用状态为未使用；
     *
     */

    @PostMapping("/returnPark")
    public ResultVo returnPark(@RequestBody LivePark livePark){
        // 1.查询车位费是否已经交清；
        QueryWrapper<FeePark> query = new QueryWrapper<>();
        query.lambda().eq(FeePark::getParkId,livePark.getParkId())
                .eq(FeePark::getUserId,livePark.getUserId())
                .eq(FeePark::getPayParkMonth,"0");
        List<FeePark> list = feeParkService.list(query);
        if(list != null && list.size() >0){
            return ResultUtils.error("请缴清停车费后再退车位!");
        }
        liveUserService.returnPark(livePark);
        return ResultUtils.success("退车位成功!");
    }
```

###### 4、前端src/api/liveUser.js添加如下方法

```js
//退房
export async function returnHouseApi(parm){
    return await http.post("/api/liveUser/returnHose",parm)
}
//退车位
export async function returnParkApi(parm){
    return await http.post("/api/liveUser/returnPark",parm)
}
```





###### 5、liveUser.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="姓名">
        <el-input v-model="parms.userName"></el-input>
      </el-form-item>
      <el-form-item label="电话">
        <el-input v-model="parms.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="userName" label="姓名"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag type="success" size="normal" v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag type="danger" size="normal" v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="name" label="栋数"></el-table-column>
      <el-table-column prop="unitName" label="单元"></el-table-column>
      <el-table-column prop="houseNum" label="房屋编号"></el-table-column>
      <el-table-column prop="houseArea" label="使用面积"></el-table-column>
      <el-table-column prop="parkName" label="车位"></el-table-column>
      <el-table-column align="center" width="480" label="操作">
        <template slot-scope="scope">
          <el-button type="success" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="primary" size="small" @click="assignHose(scope.row)"
            >分配房屋</el-button
          >
          <el-button type="success" size="small" @click="assignPark(scope.row)"
            >分配车位</el-button
          >
          <el-button type="danger" size="small" @click="leaveHose(scope.row)"
            >退房</el-button
          >
          <el-button type="warning" size="small" @click="leavePark(scope.row)"
            >退车位</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="userName" label="姓名">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item prop="sex" label="性别">
            <el-radio-group v-model="addModel.sex">
              <el-radio :label="'0'">男</el-radio>
              <el-radio :label="'1'">女</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item prop="phone" label="电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="roleId" label="角色">
            <el-select v-model="addModel.roleId">
              <el-option
                v-for="item in roleList"
                :key="item.roleId"
                :label="item.roleName"
                :value="item.roleId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="loginName" label="账户">
            <el-input v-model="addModel.loginName"></el-input>
          </el-form-item>
          <el-form-item v-if="addModel.editType != '1'" prop="password" label="密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
          <el-form-item prop="status" label="状态">
            <el-radio-group v-model="addModel.status">
              <el-radio :label="'0'">启用</el-radio>
              <el-radio :label="'1'">禁用</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
    <!-- 分配房屋 -->
    <sys-dialog
      :title="assignHouseDialog.title"
      :height="assignHouseDialog.height"
      :width="assignHouseDialog.width"
      :visible="assignHouseDialog.visible"
      @onClose="assignHoseClose"
      @onConfirm="assignHoseConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form
            :model="houseParms"
            ref="assignHoseForm"
            label-width="70px"
            :inline="true"
            size="small"
          >
            <el-form-item label="栋数名称">
              <el-input
                placeholder="请输入栋数名称"
                v-model="houseParms.buildNme"
              ></el-input>
            </el-form-item>
            <el-form-item label="单元名称">
              <el-input
                placeholder="请输入单元名称"
                v-model="houseParms.unitName"
              ></el-input>
            </el-form-item>
            <el-form-item label="房屋编号">
              <el-input
                placeholder="请输入房屋编号"
                v-model="houseParms.houseNum"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="assignHouseSearchBtn"
                >搜索</el-button
              >
              <el-button icon="el-icon-close" @click="assignHouseResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="assignTableHeight" :data="houseList" border stripe>
            <el-table-column width="50" align="center" label="选择">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignHoseParm.houseId"
                  :label="scope.row.houseId"
                  @change="getCurrentRow(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="name"
              label="栋数名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="unitName"
              label="单元名称"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseNum"
              label="房屋编号"
            ></el-table-column>
            <el-table-column
              align="center"
              prop="houseArea"
              label="使用面积"
            ></el-table-column>
            <el-table-column align="center" prop="status" label="分配状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
                  >未分配</el-tag
                >
                <el-tag v-if="scope.row.status == '1'" type="success" size="small"
                  >已分配</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignHouseSize"
            @current-change="assignHouseChange"
            :current-page.sync="houseParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="houseParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="houseParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
    <!-- 分配车位 -->
    <sys-dialog
      :title="parkDialog.title"
      :height="parkDialog.height"
      :width="parkDialog.width"
      :visible="parkDialog.visible"
      @onClose="parkOnClose"
      @onConfirm="parkOnConfirm"
    >
      <template slot="content">
        <el-main style="padding: 0px">
          <!-- 搜索框 -->
          <el-form :model="parkParms" label-width="80px" :inline="true" size="small">
            <el-form-item label="车位名称">
              <el-input v-model="parkParms.parkName"></el-input>
            </el-form-item>
            <el-form-item>
              <el-button icon="el-icon-search" @click="parkSearchBtn">查询</el-button>
              <el-button style="color: #ff7670" icon="el-icon-close" @click="parkResetBtn"
                >重置</el-button
              >
            </el-form-item>
          </el-form>
          <!-- 表格 -->
          <el-table :height="parkTableHeight" :data="parkList" border stripe>
            <el-table-column align="center" label="操作" width="50">
              <template slot-scope="scope">
                <el-radio
                  v-model="assignParkParm.parkId"
                  :label="scope.row.parkId"
                  @change="getAssignParkId(scope.row)"
                >
                  {{ "" }}
                </el-radio>
              </template>
            </el-table-column>
            <el-table-column
              align="center"
              prop="parkName"
              label="车位名称"
            ></el-table-column>
            <el-table-column align="center" prop="parkType" label="车位类型">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkType == '0'" type="danger" size="small"
                  >地上</el-tag
                >
                <el-tag v-if="scope.row.parkType == '1'" type="success" size="small"
                  >地下</el-tag
                >
              </template>
            </el-table-column>
            <el-table-column align="center" prop="parkName" label="使用状态">
              <template slot-scope="scope">
                <el-tag v-if="scope.row.parkStatus == '0'" type="danger" size="small"
                  >未使用</el-tag
                >
                <el-tag v-if="scope.row.parkStatus == '1'" type="success" size="small"
                  >已使用</el-tag
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页 -->
          <el-pagination
            @size-change="assignParkSizeChange"
            @current-change="assignParkCurrentChange"
            :current-page.sync="parkParms.currentPage"
            :page-sizes="[10, 20, 40, 80, 100]"
            :page-size="parkParms.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="parkParms.total"
            background
          >
          </el-pagination>
        </el-main>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/system/SysDialog.vue";
import {
  getRoleListApi,
  addApi,
  getListApi,
  getUserByIdApi,
  editApi,
  getHouseListApi,
  assignSaveApi,
  getParkListApi,
  assignParkSaveApi,
  returnHouseApi,
  returnParkApi,
} from "@/api/liveUser";
export default {
  components: { SysDialog },
  data() {
    return {
      //分配车位列表高度
      parkTableHeight: 0,
      //分配车位参数
      assignParkParm: {
        parkId: "",
        userId: "",
      },
      //车位弹框属性
      parkDialog: {
        title: "",
        height: 400,
        width: 900,
        visible: false,
      },
      //车位列表
      parkList: [],
      //车位查询参数
      parkParms: {
        currentPage: 1,
        pageSize: 10,
        parkName: "",
        parkStatus: "0", //0未使用 1 已使用
        parkType: "",
        total: 0,
      },
      //分配房屋列表高度
      assignTableHeight: 0,
      //分配房屋提交的数据
      assignHoseParm: {
        houseId: "",
        userId: "",
      },
      //分配房屋弹框属性
      assignHouseDialog: {
        title: "",
        height: 400,
        width: 1050,
        visible: false,
      },
      //房屋数据域
      houseList: [],
      //获取房屋列表的参数
      houseParms: {
        buildNme: "",
        status: "0",
        unitName: "",
        houseNum: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的高度
      tableHeight: 0,
      //业主列表
      tableList: [],
      //角色列表
      roleList: [],
      //表单绑定数据源
      addModel: {
        editType: "",
        userId: "",
        userName: "",
        phone: "",
        sex: "",
        loginName: "",
        password: "",
        status: "",
        roleId: "",
      },
      //表单验证规则
      rules: {
        userName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        loginName: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请填写登录密码",
          },
        ],
        status: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户状态",
          },
        ],
        roleId: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户角色",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 220,
        width: 620,
        visible: false,
      },
      //参数
      parms: {
        userName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getRoleList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
      this.assignTableHeight = window.innerHeight - 660;
      this.parkTableHeight = window.innerHeight - 660;
    });
  },
  methods: {
    //分配车位页数改变触发
    assignParkCurrentChange(val) {
      this.parkParms.currentPage = val;
      this.getAssignParkList();
    },
    //分配车位页容量改变触发
    assignParkSizeChange(val) {
      this.parkParms.pageSize = val;
      this.getAssignParkList();
    },
    //分配车位点击
    getAssignParkId(row) {
      this.assignParkParm.parkId = row.parkId;
      console.log(this.assignParkParm);
    },
    //分配车位弹框确认
    async parkOnConfirm() {
      //验证是否选择车位
      if (!this.assignParkParm.parkId) {
        this.$message.warning("请选择车位！");
        return;
      }
      let res = await assignParkSaveApi(this.assignParkParm);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.parkDialog.visible = false;
        //刷新列表
        this.getList();
      }
    },
    //分配车位弹框关闭
    parkOnClose() {
      this.parkDialog.visible = false;
    },
    //分配房屋列表页数改变
    assignHouseChange(val) {
      this.houseParms.currentPage = val;
      this.getAssignHoseList();
    },
    //分配房屋列表页容量改变事件
    assignHouseSize(val) {
      this.houseParms.pageSize = val;
      this.getAssignHoseList();
    },
    //分配房屋列表搜索事件
    assignHouseSearchBtn() {
      this.getAssignHoseList();
    },
    //分配房屋列表重置事件
    assignHouseResetBtn() {
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.getAssignHoseList();
    },
    //房屋选择事件
    getCurrentRow(row) {
      console.log(row);
      this.assignHoseParm.houseId = row.houseId;
      console.log(this.assignHoseParm);
    },
    // 分配房屋关闭事件
    assignHoseClose() {
      this.assignHouseDialog.visible = false;
    },
    //分配房屋确认事件
    async assignHoseConfirm() {
      if (!this.assignHoseParm.houseId) {
        this.$message.warning("请选择要分配的房屋!");
        return;
      }
      //数据提交
      let res = await assignSaveApi(this.assignHoseParm);
      if (res && res.code == 200) {
        //刷新列表
        this.getList();
        this.assignHouseDialog.visible = false;
        this.$message.success(res.msg);
      }
    },
    //编辑业主
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);

      //获取编辑的数据
      let res = await getUserByIdApi({ userId: row.userId });
      if (res && res.code == 200) {
        console.log(res);
        if (res.data) {
          this.$objCoppy(res.data, this.addModel);
        }
      }
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑业主";
      this.addDialog.visible = true;
      console.log(this.addModel);
    },
    //删除业主
    deleteBtn(row) {},
    //退车位
    async leavePark(row) {
       console.log(row);
      let confirm = await this.$myconfirm("确定退车位吗？");
      if (confirm) {
        let res = await returnParkApi({
          userId: row.userId,
          parkId: row.parkId,
        });
        if (res && res.code == 200) {
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg);
        }
      }
    },
    //退房
    async leaveHose(row) {
      console.log(row);
      let confirm = await this.$myconfirm("确定退房吗？");
      if (confirm) {
        let res = await returnHouseApi({
          userId: row.userId,
          houseId: row.houseId,
        });
        if (res && res.code == 200) {
          //刷新列表
          this.getList();
          //信息提示
          this.$message.success(res.msg);
        }
      }
    },
    //分配车位列表重置事件
    parkResetBtn() {
      this.parkParms.parkName = "";
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位查询按钮
    parkSearchBtn() {
      //获取车位列表
      this.getAssignParkList();
    },
    //分配车位
    async assignPark(row) {
      console.log(row);
      if (row.parkName) {
        this.$message.warning("已分配车位，不能重复分配!");
        return;
      }
      //清空数据
      this.assignParkParm.parkId = "";
      this.parkParms.parkName = "";
      this.assignParkParm.userId = row.userId;
      //获取车位列表
      this.getAssignParkList();
      //弹框属性设置
      this.parkDialog.title = "为【" + row.userName + "】分配车位";
      this.parkDialog.visible = true;
    },
    async getAssignParkList() {
      let res = await getParkListApi(this.parkParms);
      if (res && res.code == 200) {
        console.log(res);
        //把数据赋值给车位列表
        this.parkList = res.data.records;
        this.parkParms.total = res.data.total;
      }
    },
    //分配房屋
    async assignHose(row) {
      console.log(row);
      if (row.houseNum) {
        this.$message.warning("已经分配房屋，不能重复分配!");
        return;
      }
      //清空搜索框数据
      this.houseParms.buildNme = "";
      this.houseParms.unitName = "";
      this.houseParms.houseNum = "";
      this.assignHoseParm.houseId = "";
      this.assignHoseParm.userId = "";
      //获取未分配的房屋列表
      this.getAssignHoseList();
      //弹框属性设置
      this.assignHouseDialog.title = "为【" + row.userName + "】分配房屋";
      this.assignHouseDialog.visible = true;
      //设置分配人
      this.assignHoseParm.userId = row.userId;
    },
    async getAssignHoseList() {
      let res = await getHouseListApi(this.houseParms);
      if (res && res.code == 200) {
        //把返回的数据放到接收房屋的数据域里面
        console.log(res);
        this.houseList = res.data.records;
        this.houseParms.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //获取角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        console.log("角色列表");
        console.log(res);
        this.roleList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确认
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
            this.$message.success(res.msg);
          }
        }
      });
    },
    //获取业主列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
      console.log("业主列表");
      console.log(res);
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增业主";
      this.addDialog.visible = true;
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第81讲 退房、退车位功能优化



#### 第82讲 投诉管理数据库设计



#### 第83讲 投诉管理模块接口开发

###### 1、新建实体

```js
package com.itmk.web.user_complaint.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
@TableName("user_complaint")
public class UserComplaint implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long complaintId;
    //投诉人id
    private Long userId;
    //标题
    private String title;
    //投诉内容
    private String complaintContent;
    //投诉时间
    private Date createTime;
    //处理状态 0：未处理 1：已处理
    private String status;
}
```

```js
package com.itmk.web.user_complaint.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class UserComplaintParm implements Serializable {
    //当前页
    private Long currentPage;
    //页容量
    private Long pageSize;
    //标题
    private String title;
    //内容
    private String complaintContent;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.user_complaint.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.user_complaint.entity.UserComplaint;

public interface UserComplaintMapper extends BaseMapper<UserComplaint> {
}

```

**新建映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.user_complaint.mapper.UserComplaintMapper">

</mapper>
```



###### 3、新建service层

```js
package com.itmk.web.user_complaint.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.user_complaint.entity.UserComplaint;

public interface UserComplaintService extends IService<UserComplaint> {
}

```

**实现类**

```js
package com.itmk.web.user_complaint.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.user_complaint.entity.UserComplaint;
import com.itmk.web.user_complaint.mapper.UserComplaintMapper;
import com.itmk.web.user_complaint.service.UserComplaintService;
import org.springframework.stereotype.Service;

@Service
public class UserComplaintServiceImpl extends ServiceImpl<UserComplaintMapper, UserComplaint> implements UserComplaintService {
}
```

###### 4、新建控制器

```js
package com.itmk.web.user_complaint.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.user_complaint.entity.UserComplaint;
import com.itmk.web.user_complaint.entity.UserComplaintParm;
import com.itmk.web.user_complaint.service.UserComplaintService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * 投诉管理模块
 */
@RestController
@RequestMapping("/api/userComplaint")
public class UserComplaintController {
    @Autowired
    private UserComplaintService userComplaintService;

    /**
     * 投诉列表
     */

    @GetMapping("/list")
    public ResultVo getList(UserComplaintParm parm){
        //构造查询条件
        QueryWrapper<UserComplaint> query = new QueryWrapper<>();
        query.lambda().like(UserComplaint::getTitle,parm.getTitle())
                .like(UserComplaint::getComplaintContent,parm.getComplaintContent());
        //构造分页对象
        IPage<UserComplaint> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        IPage<UserComplaint> list = userComplaintService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增投诉
     */
    @PostMapping
    public ResultVo add(@RequestBody UserComplaint userComplaint){
        //设置投诉状态
        userComplaint.setStatus("0");
        //设置投诉时间
        userComplaint.setCreateTime(new Date());
        //入库保存
        boolean save = userComplaintService.save(userComplaint);
        if(save){
            return ResultUtils.success("投诉成功!");
        }
        return ResultUtils.error("投诉失败!");
    }

    /**
     * 编辑投诉
     */
    @PutMapping
    public ResultVo edit(@RequestBody UserComplaint userComplaint){
        //编辑保存
        boolean save = userComplaintService.updateById(userComplaint);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    /**
     * 删除
     * @param complaintId
     * @return
     */
    @DeleteMapping("/{complaintId}")
    public ResultVo delete(@PathVariable("complaintId") Long complaintId){
        boolean save = userComplaintService.removeById(complaintId);
        if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }
}

```



#### 第84讲 投诉管理列表页面制作与接口对接

###### 1、在src/router的index.js添加路由

```js
{
    path: '/userComplaint',
    component: Layout,
    alwaysShow: true,
    name: 'userComplaint',
    meta: { title: '投诉管理', icon: 'el-icon-date' },
    children: [
      {
        path: '/userComplaintList',
        name: 'userComplaintList',
        component: () => import('@/views/userComplaint/userComplaint'),
        meta: { title: '投诉列表', icon: 'el-icon-edit-outline' }
      }
    ]
  },
```

###### 2、views下新建userComplaint文件夹，然后新建userComplaint.vue页面

###### 3、src/api下新建userComplaint.js文件

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/userComplaint/list",parm)
}
```

###### 4、userComplaint.vue完整页面

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item label="内容">
        <el-input v-model="parms.complaintContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="complaintContent"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/userComplaint";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        complaintContent: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.parms.complaintContent = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回的数据放到表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第85讲 投诉管理新增、编辑接口对接

###### 1、在src/api下新增如下方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/userComplaint/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/userComplaint",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/userComplaint",parm)
}
```

###### 2、userComplaint.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item label="内容">
        <el-input v-model="parms.complaintContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="complaintContent"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="title" label="标题">
            <el-input v-model="addModel.title"></el-input>
          </el-form-item>
          <el-form-item prop="complaintContent" label="投诉内容">
            <el-input type="textarea" v-model="addModel.complaintContent"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi, editApi } from "@/api/userComplaint";
import { getUserId } from "@/utils/auth";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        title: [
          {
            trigger: "change",
            required: true,
            message: "请填写标题",
          },
        ],
        complaintContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写投诉内容",
          },
        ],
      },
      //新增投诉绑定对象
      addModel: {
        complaintId: "",
        userId: "",
        editType: "",
        title: "",
        complaintContent: "",
      },
      //定义弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        complaintContent: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          this.addModel.userId =getUserId()
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增投诉";
      this.addDialog.visible = true;
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑投诉";
      this.addDialog.visible = true;
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
    },
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.parms.complaintContent = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },

    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回的数据放到表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第86讲 删除、投诉处理接口对接

###### 1、UserComplaintController添加我的投诉列表方法

```js
 /**
     * 我的投诉
     * @param parm
     * @return
     */
    @GetMapping("/myList")
    public ResultVo getMyList(UserComplaintParm parm){
        //构造查询条件
        QueryWrapper<UserComplaint> query = new QueryWrapper<>();
        query.lambda().like(UserComplaint::getTitle,parm.getTitle())
                .like(UserComplaint::getComplaintContent,parm.getComplaintContent())
        .eq(UserComplaint::getUserId,parm.getUserId());
        //构造分页对象
        IPage<UserComplaint> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        IPage<UserComplaint> list = userComplaintService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
```

**实体类UserComplaintParm添加用户id**

```js
package com.itmk.web.user_complaint.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class UserComplaintParm implements Serializable {
    //当前页
    private Long currentPage;
    //页容量
    private Long pageSize;
    //投诉人id
    private Long userId;
    //标题
    private String title;
    //内容
    private String complaintContent;
}
```

###### 2、前端src/api下的userComplaint.js添加我的投诉查询列表

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/userComplaint/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/userComplaint",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/userComplaint",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/userComplaint",parm)
}
//获取我的投诉列表
export async function getMyListApi(parm){
    return await http.get("/api/userComplaint/myList",parm)
}
```

###### 3、投诉列表userComplaint.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item label="内容">
        <el-input v-model="parms.complaintContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="complaintContent"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="120" label="操作">
        <template slot-scope="scope">
          <el-button
            type="success"
            icon="el-icon-delete"
            size="small"
            @click="doBtn(scope.row)"
            >处理</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="title" label="标题">
            <el-input v-model="addModel.title"></el-input>
          </el-form-item>
          <el-form-item prop="complaintContent" label="投诉内容">
            <el-input type="textarea" v-model="addModel.complaintContent"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi, editApi, deleteApi } from "@/api/userComplaint";
import { getUserId } from "@/utils/auth";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        title: [
          {
            trigger: "change",
            required: true,
            message: "请填写标题",
          },
        ],
        complaintContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写投诉内容",
          },
        ],
      },
      //新增投诉绑定对象
      addModel: {
        complaintId: "",
        userId: "",
        editType: "",
        title: "",
        complaintContent: "",
      },
      //定义弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        complaintContent: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          this.addModel.userId = getUserId();
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //处理按钮
    async doBtn(row){
      if(row.status == '1'){
        this.$message.warning('该投诉已经处理，无需重复处理！')
        return;
      }
      let parm = {
        complaintId: row.complaintId,
        status:'1'
      };
      const confirm = await this.$myconfirm("确定处理该投诉吗?");
      if (confirm) {
        let res = await editApi(parm);
        if (res && res.code == 200) {
          //刷新表格
          this.getList();
          this.$message.success(res.msg);
        }
      }
    },
   
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.parms.complaintContent = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },

    //获取列表
    async getList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回的数据放到表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

###### 4、我的投诉页面myUserComplaint.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item label="内容">
        <el-input v-model="parms.complaintContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="complaintContent"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="280" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="title" label="标题">
            <el-input v-model="addModel.title"></el-input>
          </el-form-item>
          <el-form-item prop="complaintContent" label="投诉内容">
            <el-input type="textarea" v-model="addModel.complaintContent"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMyListApi, addApi, editApi, deleteApi } from "@/api/userComplaint";
import { getUserId } from "@/utils/auth";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        title: [
          {
            trigger: "change",
            required: true,
            message: "请填写标题",
          },
        ],
        complaintContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写投诉内容",
          },
        ],
      },
      //新增投诉绑定对象
      addModel: {
        complaintId: "",
        userId: "",
        editType: "",
        title: "",
        complaintContent: "",
      },
      //定义弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //列表查询参数
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        complaintContent: "",
        total: 0,
        userId:''
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          this.addModel.userId = getUserId();
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //处理按钮
    async doBtn(row){
      let parm = {
        complaintId: row.complaintId,
        status:'1'
      };
      const confirm = await this.$myconfirm("确定处理该投诉吗?");
      if (confirm) {
        let res = await editApi(parm);
        if (res && res.code == 200) {
          //刷新表格
          this.getList();
          this.$message.success(res.msg);
        }
      }
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增投诉";
      this.addDialog.visible = true;
    },
    //删除按钮
    async deleteBtn(row) {
      let parm = {
        complaintId: row.complaintId,
      };
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi(parm);
        if (res && res.code == 200) {
          //刷新表格
          this.getList();
          this.$message.success(res.msg);
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑投诉";
      this.addDialog.visible = true;
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
    },
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.parms.complaintContent = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getList();
    },

    //获取列表
    async getList() {
      this.parms.userId = getUserId();
      let res = await getMyListApi(this.parms);
      if (res && res.code == 200) {
        console.log(res);
        //把返回的数据放到表格
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第87讲 维修管理模块数据库设计



#### 第88讲 维修管理模块接口开发

###### 1、新建实体类

```js
package com.itmk.web.user_repair.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
@TableName("user_repair")
public class UserRepair implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long repairId;
    //报修人id
    private Long userId;
    //联系电话
    private String phone;
    //维修地址
    private String repairAddress;
    //维修内容
    private String repairContent;
    //报修时间
    private Date commitTime;
    //维修状态 0：未维修 1：已维修
    private String status;
}

```

```js
package com.itmk.web.user_repair.entity;

import lombok.Data;

import java.io.Serializable;
@Data
public class UserRepairParm implements Serializable {
    //当前页
    private Long currentPage;
    //页容量
    private Long pageSize;
    //投诉人id
    private Long userId;
    //维修内容
    private String repairContent;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.user_repair.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.user_repair.entity.UserRepair;

public interface UserRepairMapper extends BaseMapper<UserRepair> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.user_repair.mapper.UserRepairMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.user_repair.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.user_repair.entity.UserRepair;

public interface UserRepairService extends IService<UserRepair> {
}

```

**实现类**

```js
package com.itmk.web.user_repair.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.user_repair.entity.UserRepair;
import com.itmk.web.user_repair.mapper.UserRepairMapper;
import com.itmk.web.user_repair.service.UserRepairService;
import org.springframework.stereotype.Service;

@Service
public class UserRepairServiceImpl extends ServiceImpl<UserRepairMapper, UserRepair> implements UserRepairService {
}

```

###### 4、新建控制器

```js
package com.itmk.web.user_repair.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.user_repair.entity.UserRepair;
import com.itmk.web.user_repair.entity.UserRepairParm;
import com.itmk.web.user_repair.service.UserRepairService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * 维修管理模块
 */
@RestController
@RequestMapping("/api/userRepair")
public class UserRepairController {
    @Autowired
    private UserRepairService userRepairService;

    /**
     * 我的报修列表
     */
    @GetMapping("/myList")
    public ResultVo getMyList(UserRepairParm userRepairParm){
        //构造查询条件
        QueryWrapper<UserRepair> query = new QueryWrapper<>();
        query.lambda().eq(UserRepair::getUserId,userRepairParm.getUserId())
                .like(UserRepair::getRepairContent,userRepairParm.getRepairContent())
                .orderByDesc(UserRepair::getCommitTime);
        //构造分页对象
        IPage<UserRepair> page = new Page<>();
        page.setSize(userRepairParm.getPageSize());
        page.setCurrent(userRepairParm.getCurrentPage());
        IPage<UserRepair> list = userRepairService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 报修列表(物业管理部人员)
     */
    @GetMapping("/list")
    public ResultVo getList(UserRepairParm userRepairParm){
        //构造查询条件
        QueryWrapper<UserRepair> query = new QueryWrapper<>();
        query.lambda().like(UserRepair::getRepairContent,userRepairParm.getRepairContent())
                .orderByDesc(UserRepair::getCommitTime);
        //构造分页对象
        IPage<UserRepair> page = new Page<>();
        page.setSize(userRepairParm.getPageSize());
        page.setCurrent(userRepairParm.getCurrentPage());
        IPage<UserRepair> list = userRepairService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody UserRepair userRepair){
        userRepair.setCommitTime(new Date());
        userRepair.setStatus("0");
        boolean b = userRepairService.save(userRepair);
        if(b){
            return ResultUtils.success("报修成功!");
        }
        return ResultUtils.error("报修失败!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody UserRepair userRepair){
        boolean b = userRepairService.updateById(userRepair);
        if(b){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{repairId}")
    public ResultVo delete(@PathVariable("repairId") Long repairId){
        boolean b = userRepairService.removeById(repairId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }
}

```



#### 第89讲 我的维修列表页面制作与接口对接

###### 1、src/router的index.js添加路由

```js
{
    path: '/repairModel',
    component: Layout,
    alwaysShow: true,
    name: 'repairModel',
    meta: { title: '维修管理', icon: 'el-icon-picture-outline' },
    children: [
      {
        path: '/repairList',
        name: 'repairList',
        component: () => import('@/views/repair/repairList'),
        meta: { title: '维修列表', icon: 'el-icon-s-marketing' }
      },
      {
        path: '/myRepair',
        name: 'myRepair',
        component: () => import('@/views/repair/myRepair'),
        meta: { title: '我的维修', icon: 'el-icon-picture-outline' }
      }
    ]
  },
```

###### 2、新建repairList.vue和myRepair.vue页面



###### 3、src/api下新建repair.js

```js
import http from '@/utils/http'
//获取我的列表
export async function getMyListApi(parm){
    return await http.get("/api/userRepair/myList",parm)
}
```

###### 4、myRepair.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="报修内容">
        <el-input v-model="parms.repairContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="报修内容" prop="repairContent"></el-table-column>
      <el-table-column label="报修地址" prop="repairAddress"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="280" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getMyListApi } from "@/api/repair";
import { getUserId } from "@/utils/auth";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userId: "",
        repairContent: "",
      },
    };
  },
  created() {
    this.getMyList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getMyList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getMyList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {
      this.parms.repairContent = "";
      this.getMyList();
    },
    //搜索按钮
    searchBtn() {
      this.getMyList();
    },
    //获取列表
    async getMyList() {
      this.parms.userId = getUserId();
      let res = await getMyListApi(this.parms);
      if (res && res.code == 200) {
        //表格数据赋值
        console.log(res);
        this.tableList = res.data.records;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

#### 第90讲 新增维修页面制作与接口对接

###### 1、在src/api下的repair.js添加新增方法

```js
import http from '@/utils/http'
//获取我的列表
export async function getMyListApi(parm){
    return await http.get("/api/userRepair/myList",parm)
}
//获取维修列表
export async function getListApi(parm){
    return await http.get("/api/userRepair/list",parm)
}
//新增维修
export async function addApi(parm){
    return await http.post("/api/userRepair",parm)
}
```

###### 2、myRepair.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="报修内容">
        <el-input v-model="parms.repairContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="报修内容" prop="repairContent"></el-table-column>
      <el-table-column label="报修地址" prop="repairAddress"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="280" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="repairContent" label="维修内容">
            <el-input type="textarea" v-model="addModel.repairContent"></el-input>
          </el-form-item>
          <el-form-item prop="repairAddress" label="维修地点">
            <el-input v-model="addModel.repairAddress"></el-input>
          </el-form-item>
          <el-form-item prop="phone" label="联系电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMyListApi,addApi } from "@/api/repair";
import { getUserId } from "@/utils/auth";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        repairContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写维修内容",
          },
        ],
        repairAddress: [
          {
            trigger: "change",
            required: true,
            message: "请填写维修地址",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写联系电话",
          },
        ],
      },
      //表单数据域
      addModel: {
        editType: "",
        repairId: "",
        userId: "",
        phone: "",
        repairAddress: "",
        repairContent: "",
      },
      //弹框属性定义
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userId: "",
        repairContent: "",
      },
    };
  },
  created() {
    this.getMyList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async(valid) => {
        if (valid) {
          //设置用户id
          this.addModel.userId = getUserId();
          let res = null;
          if(this.addModel.editType == '0'){
            res = await addApi(this.addModel)
          }
          if(res && res.code == 200){
            //刷新表格
            this.getMyList();
            //信息提示
            this.$message.success(res.msg)
             this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getMyList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getMyList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm('addForm',this.addModel)
      //设置编辑属性
      this.addModel.editType = '0'
      //设置弹框属性
      this.addDialog.title = "新增维修";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.repairContent = "";
      this.getMyList();
    },
    //搜索按钮
    searchBtn() {
      this.getMyList();
    },
    //获取列表
    async getMyList() {
      this.parms.userId = getUserId();
      let res = await getMyListApi(this.parms);
      if (res && res.code == 200) {
        //表格数据赋值
        console.log(res);
        this.tableList = res.data.records;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第91讲 编辑、删除、处理接口对接

###### 1、在src/api下的repair.js添加新增editApi()和deleteApi()方法

```js
import http from '@/utils/http'
//获取我的列表
export async function getMyListApi(parm){
    return await http.get("/api/userRepair/myList",parm)
}
//获取维修列表
export async function getListApi(parm){
    return await http.get("/api/userRepair/list",parm)
}
//新增维修
export async function addApi(parm){
    return await http.post("/api/userRepair",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/userRepair",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/userRepair",parm)
}
```



###### 2、myRepair.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="报修内容">
        <el-input v-model="parms.repairContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="报修内容" prop="repairContent"></el-table-column>
      <el-table-column label="报修地址" prop="repairAddress"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="280" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="repairContent" label="维修内容">
            <el-input type="textarea" v-model="addModel.repairContent"></el-input>
          </el-form-item>
          <el-form-item prop="repairAddress" label="维修地点">
            <el-input v-model="addModel.repairAddress"></el-input>
          </el-form-item>
          <el-form-item prop="phone" label="联系电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMyListApi, addApi, editApi, deleteApi } from "@/api/repair";
import { getUserId } from "@/utils/auth";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        repairContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写维修内容",
          },
        ],
        repairAddress: [
          {
            trigger: "change",
            required: true,
            message: "请填写维修地址",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写联系电话",
          },
        ],
      },
      //表单数据域
      addModel: {
        editType: "",
        repairId: "",
        userId: "",
        phone: "",
        repairAddress: "",
        repairContent: "",
      },
      //弹框属性定义
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userId: "",
        repairContent: "",
      },
    };
  },
  created() {
    this.getMyList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确认事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          //设置用户id
          this.addModel.userId = getUserId();
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表格
            this.getMyList();
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getMyList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getMyList();
    },
    //删除按钮
    async deleteBtn(row) {
      //信息提示
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({ repairId: row.repairId });
        if (res && res.code == 200) {
          //刷新列表
          this.getMyList();
          this.$message.success(res.msg);
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑维修";
      this.addDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增维修";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.repairContent = "";
      this.getMyList();
    },
    //搜索按钮
    searchBtn() {
      this.getMyList();
    },
    //获取列表
    async getMyList() {
      this.parms.userId = getUserId();
      let res = await getMyListApi(this.parms);
      if (res && res.code == 200) {
        //表格数据赋值
        console.log(res);
        this.tableList = res.data.records;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```

###### 3、repairList.vue完整源码

```js
<template>
  <el-main>
    <!-- 搜索 -->
    <el-form
      :model="parms"
      ref="searchParm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="报修内容">
        <el-input v-model="parms.repairContent"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="报修内容" prop="repairContent"></el-table-column>
      <el-table-column label="报修地址" prop="repairAddress"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="处理状态" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column align="center" width="120" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="doBtn(scope.row)"
            >处理</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi, editApi } from "@/api/repair";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        userId: "",
        repairContent: "",
      },
    };
  },
  created() {
    this.getMyList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getMyList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getMyList();
    },
    //处理
    async doBtn(row) {
      console.log(row);
      if(row.status =='1'){
         this.$message.warning('该维修已经处理，不要重复处理!')
         return;
      }
      let confirm = await this.$myconfirm("确定处理该数据吗?");
      if (confirm) {
        let parm = {
          repairId: row.repairId,
          status: "1",
        };
        let res = await editApi(parm);
        if (res && res.code == 200) {
          //刷新列表
          this.getMyList();
          this.$message.success('处理成功!');
        }
      }
    },
    //重置按钮
    resetBtn() {
      this.parms.repairContent = "";
      this.getMyList();
    },
    //搜索按钮
    searchBtn() {
      this.getMyList();
    },
    //获取列表
    async getMyList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        //表格数据赋值
        console.log(res);
        this.tableList = res.data.records;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第92讲 公告管理模块数据库设计

#### 第93讲 公告管理模块接口开发

###### 1、新建实体类

```js
package com.itmk.web.sys_notice.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
@TableName("sys_notice")
public class SysNotice implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long noticeId;
    private Long userId;
    //标题
    private String title;
    //内容
    private String noticeContent;
    private Date createTime;
}

```

```js
package com.itmk.web.sys_notice.entity;

import lombok.Data;

import java.io.Serializable;
@Data
public class SysNoticeParm implements Serializable {
    //当前页
    private Long currentPage;
    //页容量
    private Long pageSize;
    private String title;
}

```

###### 2、新建mapper层

```js
package com.itmk.web.sys_notice.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_notice.entity.SysNotice;

public interface SysNoticeMapper extends BaseMapper<SysNotice> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_notice.mapper.SysNoticeMapper">

</mapper>
```

###### 3、新建service层

```js
package com.itmk.web.sys_notice.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_notice.entity.SysNotice;

public interface SysNoticeService extends IService<SysNotice> {
}

```

**实现类**

```js
package com.itmk.web.sys_notice.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.mapper.SysNoticeMapper;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.springframework.stereotype.Service;

@Service
public class SysNoticeServiceImpl extends ServiceImpl<SysNoticeMapper, SysNotice> implements SysNoticeService {
}

```

###### 4、新建控制器

```js
package com.itmk.web.sys_notice.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.entity.SysNoticeParm;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * 公告管理模块
 */
@RestController
@RequestMapping("/api/sysNotice")
public class SysNoticeController {
    @Autowired
    private SysNoticeService sysNoticeService;

    /**
     * 查询列表
     */
    public ResultVo getList(SysNoticeParm parm){
        //构造查询条件
        QueryWrapper<SysNotice> query = new QueryWrapper<>();
        query.lambda().like(SysNotice::getTitle,parm.getTitle())
                .orderByDesc(SysNotice::getCreateTime);
        //构造分页对象
        IPage<SysNotice> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        IPage<SysNotice> list = sysNoticeService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }

    /**
     * 新增
     */
    @PostMapping
    public ResultVo add(@RequestBody SysNotice sysNotice){
        sysNotice.setCreateTime(new Date());
        boolean b = sysNoticeService.save(sysNotice);
        if(b){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    /**
     * 编辑
     */
    @PutMapping
    public ResultVo edit(@RequestBody SysNotice sysNotice){
        boolean b = sysNoticeService.updateById(sysNotice);
        if(b){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    /**
     * 删除
     */
    @DeleteMapping("/{noticeId}")
    public ResultVo delete(@PathVariable("noticeId") Long noticeId){
        boolean b = sysNoticeService.removeById(noticeId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }
}

```



#### 第94讲 公告管理页面制作与接口对接

###### 1、在src/router下的index.js添加路由页面

```js
{
    path: '/notice',
    component: Layout,
    alwaysShow: true,
    name: 'notice',
    meta: { title: '公告管理', icon: 'el-icon-document-copy' },
    children: [
      {
        path: '/noticeList',
        name: 'noticeList',
        component: () => import('@/views/notice/noticeList'),
        meta: { title: '公告列表', icon: 'el-icon-s-marketing' }
      }
    ]
  },
```

###### 2、views下新建notice文件夹，并新建noticeList.vue页面



###### 3、在src/api下新建 notice.js

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/sysNotice/list",parm)
}
```

###### 4、noticeList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="noticeContent"></el-table-column>
      <el-table-column label="时间" prop="createTime"></el-table-column>
      <el-table-column align="center" width="280" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/notice";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        total: 0,
      },
    };
  },
  created() {
    this.getlList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getlList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getlList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.getlList();
    },
    //查询按钮
    searchBtn() {
      this.getlList();
    },
    //获取列表
    async getlList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        //给表格赋值
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第95讲 公告新增、编辑、删除接口对接

###### 1、在src/api下的notice.js添加如下方法

```js
import http from '@/utils/http'
//获取列表
export async function getListApi(parm){
    return await http.get("/api/sysNotice/list",parm)
}
//新增
export async function addApi(parm){
    return await http.post("/api/sysNotice",parm)
}
//编辑
export async function editApi(parm){
    return await http.put("/api/sysNotice",parm)
}
//删除
export async function deleteApi(parm){
    return await http.delete("/api/sysNotice",parm)
}
```



###### 2、noticeList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索框 -->
    <el-form
      :model="parms"
      ref="searchForm"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item label="标题">
        <el-input v-model="parms.title"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" @click="resetBtn" icon="el-icon-close"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="标题" prop="title"></el-table-column>
      <el-table-column label="内容" prop="noticeContent"></el-table-column>
      <el-table-column label="时间" prop="createTime"></el-table-column>
      <el-table-column align="center" width="180" label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="parms.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="parms.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="parms.total"
      background
    >
    </el-pagination>
    <!-- 弹框定义 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="title" label="标题">
            <el-input v-model="addModel.title"></el-input>
          </el-form-item>
          <el-form-item prop="noticeContent" label="内容">
            <el-input type="textarea" v-model="addModel.noticeContent"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addApi, editApi, deleteApi } from "@/api/notice";
import SysDialog from "@/components/system/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        title: [
          {
            trigger: "change",
            required: true,
            message: "请填标题",
          },
        ],
        noticeContent: [
          {
            trigger: "change",
            required: true,
            message: "请填写公告内容",
          },
        ],
      },
      //表单绑定的数据域
      addModel: {
        editType: "",
        noticeId: "",
        userId: "",
        title: "",
        noticeContent: "",
      },
      //设置弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 620,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      parms: {
        currentPage: 1,
        pageSize: 10,
        title: "",
        total: 0,
      },
    };
  },
  created() {
    this.getlList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 210;
    });
  },
  methods: {
    //弹框确定事件
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新列表
            this.getlList();
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.parms.currentPage = val;
      this.getlList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.parms.pageSize = val;
      this.getlList();
    },
    //删除按钮
    async deleteBtn(row) {
      //信息提示
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({ noticeId: row.noticeId });
        if (res && res.code == 200) {
          //刷新列表
          this.getlList();
          this.$message.success(res.msg);
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.editType = "1";
      //设置弹框属性
      this.addDialog.title = "编辑公告";
      this.addDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置编辑属性
      this.addModel.editType = "0";
      //设置弹框属性
      this.addDialog.title = "新增公告";
      this.addDialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.parms.title = "";
      this.getlList();
    },
    //查询按钮
    searchBtn() {
      this.getlList();
    },
    //获取列表
    async getlList() {
      let res = await getListApi(this.parms);
      if (res && res.code == 200) {
        //给表格赋值
        console.log(res);
        this.tableList = res.data.records;
        this.parms.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped></style>

```



#### 第96讲 解决刷新页面tabs数据丢失的问题

###### 1、添加beforeUnload()方法

找到src/layout/components下的TagsView的index.vue，然后在methods中添加beforeUnload()方法，如下所示

```js
	//解决页面刷新，tags丢失的问题
    beforeUnload() {
      // 监听页面刷新
      window.addEventListener("beforeunload", () => {
        // visitedViews数据结构太复杂无法直接JSON.stringify处理，先转换需要的数据
        let tabViews = this.visitedViews.map((item) => {
          return {
            fullPath: item.fullPath,
            hash: item.hash,
            meta: { ...item.meta },
            name: item.name,
            params: { ...item.params },
            path: item.path,
            query: { ...item.query },
            title: item.title,
          };
        });
        sessionStorage.setItem("tabViews", JSON.stringify(tabViews));
      });
      // 页面初始化加载判断缓存中是否有数据
      let oldViews = JSON.parse(sessionStorage.getItem("tabViews")) || [];
      if (oldViews.length > 0) {
        this.$store.state.tagsView.visitedViews = oldViews;
      }
    },
```

###### 2、在mounted()生命周期函数中加入上面方法

```js
 mounted() {
    this.initTags();
    this.addTags();
    this.beforeUnload();
  },
```



#### 第97讲  整合 Spring Security

###### **1、Spring Security简介**

​	1、什么是Spring Security

​	Spring Security是Spring提供的一个安全框架，提供认证(（Authentication)和授权(Authorization)功能，核心技术使用了servlet、Ioc和Aop。

​	2、什么是认证

​	认证简单的说就是登录，当用户访问系统时，需要到数据库查看，有没有这个用户，有用户了才允许进入系统。

​	3、什么是授权

​	授权指的就是用户拥有哪些权限，如用户可以操作的菜单、按钮、数据等权限。

###### **2、Spring Security和Shiro选择**

​	1.2.1、shiro特点

​	1、Apache的强大灵活的开源安全框架，简单易用。

​	2、可以提供认证、授权、企业会话管理、安全加密、缓存管理等功能，可以非常快的完成项目中权限管理模块的开发。

​	3、简单灵活，可以脱离Spirng,权限控制粒度较粗;

​	1.2.2、Spring Security特点

​	1、Spring Security上手比shiro复杂，但是功能比Shiro更强大。

​	2、Spring Security是Spring家族，整合更加方便。如果是spring boot项目，推荐使用Spring Security。

​	3、Spring Security 社区资源相对比 Shiro 更加丰富；

​	4、Spring Security对Oauth、OpenID也有支持,Shiro则需要自己手动实现。而且Spring Security的权限细粒度更高。

###### 3、在itmk-base-web pom.xml添加如下依赖

```
		<!-- spring security 启动器-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
```

###### 4、新建spring security配置类SpringSecurityConfig

```js
package com.itmk.config.security;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
}

```

###### 5、启动项目，登录，报如下错误

![](D:\项目实战\物业管理系统\资料\images\登录跨域错误.png)

**解决方法，在spring security配置类重写configure()方法，并配置跨域**

```js
package com.itmk.config.security;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //解决跨域问题
        http.cors().disable();
    }
}

```

###### 6、登录返回403错误

![](D:\项目实战\物业管理系统\资料\images\登录403错误.png)

返回403是因为登录请求被spring security拦截，需要在spring security配置类configure()方法放行登录请求

```js
package com.itmk.config.security;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //解决跨域
        http.cors().disable();
        http.authorizeRequests()
                //放行登录请求,其他的所有请求都要认证
                .antMatchers("/api/user/login").permitAll()
                .anyRequest().authenticated();
    }
}

```

###### 7、请求登录，返回如下错误

![](D:\项目实战\物业管理系统\资料\images\登录header报错.png)

**跨域配置后面需要配置  http.cors().and().headers().frameOptions().disable();** 如下所示

```js
package com.itmk.config.security;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
       //解决跨域
        http.cors().and().headers().frameOptions().disable();
        http.authorizeRequests()
                //放行登录请求,其他的所有请求都要认证
                .antMatchers("/api/user/login").permitAll()
                .anyRequest().authenticated();
    }
}

```

###### 8、配置第5步后，点击登录无反应或者403

需要配置csrf().disable()关闭跨域请求伪造

```js
package com.itmk.config.security;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //解决跨域
        http.cors().and().headers().frameOptions().disable();
        //关闭跨域请求伪造
        http.csrf().disable()
                .authorizeRequests()
                //放行登录请求,其他的所有请求都要认证
                .antMatchers("/api/user/login").permitAll()
                .anyRequest().authenticated();
    }
}

```



#### 第98讲 用户认证讲解1

###### 1、什么是认证

```js
认证简单说就是登录，查询数据库看看登录的用户在数据库存不存在
```



###### 2、Spring Security认证原理

​	1.2.1、Spring Security登录认证主要涉及两个重要的接口  UserDetailService和UserDetails接口

​	1.2.2、UserDetailService接口主要定义了一个方法 loadUserByUsername(String username)用于完成用户信息的查询，其中username就是登录时的登录名称，登录认证时，需要自定义一个实现类实现UserDetailService接口，完成数据库查询，该接口返回UserDetail。

​	1.2.3、UserDetail主要用于封装认证成功时的用户信息，即UserDetailService返回的用户信息，可以用Spring自己的User对象，但是最好是实现UserDetail接口，自定义用户对象。

  **Spring Security认证步骤:**

```java
		1.1、自定义UserDetails

​				当实体对象字段不满足时需要自定义UserDetails，实际开发中一般都要自定义UserDetails

​		1.2、自定义UserDetailsService

​				主要用于从数据库查询用户信息

​		1.3、用户认证失败的处理器

​				认证失败需要返回JSON数据，给前端判断

​		1.4、用户无权限访问的处理器

​				无权限访问需要返回JSON数据，给前端判断

​		1.5、自定义异常处理器

​				发生异常的处理

​		1.6、配置Spring Security配置类

​				把上面自定义的处理器交给Spring Security
```



###### 3、Spring Security认证实现

​	**3.1、自定义UserDetails**

```js
1、UserDetails属于spring security自己的用户实体对象，但是他里面的属性字段很少，不符合实际开发需求,因此实际开发中需要扩展该实体；

2、实际开发中，我们自己的用户对象，实现UserDetails即可；

3、UserDetails里面包含如下字段：
	//下面的字段，属于spring security的UserDetails的字段
	//登录账户
    private String username;
	//登录密码
    private String password;
    //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    //用户权限字段的集合
    Collection<? extends GrantedAuthority> authorities;
```

​	***项目实体对象改进****

​		在项目数据库的业主表和物主表中分别添加上面的字段

​		**物主表**

​			<span style="color:#FF7670;">注意事项：user_name需要改为 username</span>

​	字段

```js
username                          varchar                   登录账户
is_account_non_expired	          int		                帐户是否过期(1 未过期，0已过期)				
is_account_non_locked	          int		                帐户是否被锁定(1 未过期，0已过期)					
is_credentials_non_expired	      int			            密码是否过期(1 未过期，0已过期)				
is_enabled	                      int		                帐户是否可用(1 可用，0 删除用户)				

```



![](D:\项目实战\物业管理系统\资料\images\物主表扩展.png)

​		**改进后的物主实体类**

```js
package com.itmk.web.user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.io.Serializable;
import java.util.Collection;

/**
 * 员工表
 */
@Data  //自动生成get 和 set方法
@TableName("sys_user")  //指明User对应的数据库表是 sys_user表
public class User implements UserDetails,Serializable {
    //设置主键自增
    @TableId(type= IdType.AUTO)
    private Long userId;
    //登录名
    private String loginName;
    //登录密码
    private String password;
    //姓名
    private String username;
    //电话
    private String phone;
    //性别 0：女 1：男
    private String sex;
    //身份证
    private String idCard;
    //是否是管理员 0：不是 1：是
    private String isAdmin;
    //0：在职  1：离职
    private String status;
    //0：启用 1：禁用
    private String isUsed;

    //下面的字段，属于spring security的UserDetails的字段
    //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    //由于authorities不是数据库里面的字段，所以要排除他，不然mybatis-plus找不到该字段会报错
    @TableField(exist = false)
    Collection<? extends GrantedAuthority> authorities;
}
```

​	

​	**业主表**

​		<span style="color:#FF7670;">注意事项：user_name需要改为 username</span>

​		字段

```js
username                          varchar                   登录账户
is_account_non_expired	          int		                帐户是否过期(1 未过期，0已过期)				
is_account_non_locked	          int		                帐户是否被锁定(1 未过期，0已过期)					
is_credentials_non_expired	      int			            密码是否过期(1 未过期，0已过期)				
is_enabled	                      int		                帐户是否可用(1 可用，0 删除用户)				
```



![](D:\项目实战\物业管理系统\资料\images\业主表扩展.png)

​	**业主实体类**

```js
package com.itmk.web.live_user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.io.Serializable;
import java.util.Collection;

/**
 * 业主表实体映射
 */
@Data
@TableName("live_user")
public class LiveUser implements Serializable, UserDetails {
    @TableId(type = IdType.AUTO)
    private Long userId;
    //登录账户
    private String username;
    //联系电话
    private String phone;
    //性别
    private String sex;
    //姓名
    private String loginName;
    //登录密码
    private String password;
    //状态 0:启用 1：禁用
    private String status;
    //角色id不属于业主表，需要排除
    @TableField(exist =  false)
    private Long roleId;
    //不属于业主表，所以需要排除
    @TableField(exist = false)
    private String houseNum;
    //不属于业主表，所以需要排除
    @TableField(exist = false)
    private String houseArea;
    //不属于业主表，所以需要排除
    @TableField(exist = false)
    private String unitName;
    //不属于业主表，所以需要排除
    @TableField(exist = false)
    private String name;
    //不属于业主表，所以需要排除
    @TableField(exist = false)
    private String parkName;
    @TableField(exist = false)
    private Long houseId;
    @TableField(exist = false)
    private Long parkId;
    @TableField(exist = false)
    private String useStatus;
    @TableField(exist = false)
    private String liveStatue;

    //下面的字段，属于spring security的UserDetails的字段
    //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    //由于authorities不是数据库里面的字段，所以要排除他，不然mybatis-plus找不到该字段会报错
    @TableField(exist = false)
    Collection<? extends GrantedAuthority> authorities;
}

```



**3.2、自定义UserDetailsService**

```js
自定义UserDetailsService的目的：
	让spring security从我们自己的数据库查询用户信息进行认证；
```

**3.2.1、物主和业主的service层添加根据username查询用户信息的方法**

a、UserService接口新增如下方法

```js
	//根据用户名查询用户信息
    User loadUser(String username);
```

b、UserService的实现类实现上面的方法

```js
	@Override
    public User loadUser(String username) {
        QueryWrapper<User> query = new QueryWrapper<>();
        query.lambda().eq(User::getUsername, username);
        return this.baseMapper.selectOne(query);
    }
```

c、LiveUserService接口新增如下方法

```js
	//根据用户名查用户
    LiveUser loadUser(String username);
```

d、LiveUserService的实现类实现上面的方法

```js
	@Override
    public LiveUser loadUser(String username) {
        //认证
        QueryWrapper<LiveUser> query = new QueryWrapper<>();
        query.lambda().eq(LiveUser::getUsername,username);
        return this.baseMapper.selectOne(query);
    }
```

**3.2.2、自定义定义UserDetailsService****

目的：登录，也就是用户认证的时候调用，告诉spring security到哪里查询用户信息

```js
package com.itmk.config.security.detailservice;

import com.itmk.web.live_user.service.LiveUserService;
import com.itmk.web.user.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

@Component("custometUserDetailService")
public class CustometUserDetailService implements UserDetailsService {
    @Autowired
    private UserService userService;
    @Autowired
    private LiveUserService liveUserService;
    @Override
    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {
        //认证
        int index = s.indexOf(":");
        String username = s.substring(0, index);
        String userType = s.substring(index+1,s.length());
        UserDetails user = null;
        if(userType.equals("0")){ //业主
            user = liveUserService.loadUser(username);
        }else if(userType.equals("1")) { //物主
            user =  userService.loadUser(username);
        }else{
            throw new UsernameNotFoundException("用户类型不存在!");
        }
        if(user == null){
            throw new UsernameNotFoundException("用户名或密码错误!");
        }
        //授权
        return user;
    }
}

```

**3.3.1用户认证失败的处理器**

目的：返回json数据

```js
package com.itmk.config.security.handler;

import com.alibaba.fastjson.JSONObject;
import com.alibaba.fastjson.serializer.SerializerFeature;
import com.itmk.config.security.exception.CustomerAuthenionException;
import com.itmk.utils.ResultVo;
import org.springframework.security.authentication.*;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Component("loginFailureHandler")
public class LoginFailureHandler implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e) throws IOException, ServletException {
        int code = 500;
        String str = "";
        if(e instanceof AccountExpiredException){
            str = "账户过期，登录失败!";
        }else if(e instanceof BadCredentialsException){
            str = "用户名或密码错误，登录失败!";
        }else if(e instanceof CredentialsExpiredException){
            str = "密码过期，登录失败!";
        }else if(e instanceof DisabledException){
            str = "账户被禁用，登录失败!";
        }else if(e instanceof LockedException){
            str = "账户被锁，登录失败!";
        }else if(e instanceof InternalAuthenticationServiceException){
            str = "账户不存在，登录失败!";
        }else if(e instanceof CustomerAuthenionException){
            code = 600;
            str = e.getMessage();
        }else if(e instanceof InsufficientAuthenticationException){
            str = "无权限访问资源!";
        }
        else{
            str = "登录失败!";
        }
        String res =  JSONObject.toJSONString(new ResultVo(str,code,null), SerializerFeature.DisableCircularReferenceDetect);
        //设置返回格式
        httpServletResponse.setContentType("application/json;charset=UTF-8");
        ServletOutputStream out = httpServletResponse.getOutputStream();
        out.write(res.getBytes("UTF-8"));
        out.flush();
        out.close();
    }
}
```

**3.3.2用户无权限访问的处理器**

```js
package com.itmk.config.security.handler;

import com.alibaba.fastjson.JSONObject;
import com.alibaba.fastjson.serializer.SerializerFeature;
import com.itmk.utils.ResultVo;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.stereotype.Component;

import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * 无权限访问
 */
@Component("customAccessDeineHandler")
public class CustomAccessDeineHandler implements AccessDeniedHandler {
    @Override
    public void handle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e) throws IOException, ServletException {
        String res =  JSONObject.toJSONString(new ResultVo("无权限访问,请联系管理员!",600,null), SerializerFeature.DisableCircularReferenceDetect);
        //设置返回格式
        httpServletResponse.setContentType("application/json;charset=UTF-8");
        ServletOutputStream out = httpServletResponse.getOutputStream();
        out.write(res.getBytes("UTF-8"));
        out.flush();
        out.close();
    }
}
```



**3.3.3自定义异常处理器**

```js
package com.itmk.config.security.exception;


import org.springframework.security.core.AuthenticationException;

/**
 * token异常
 */
public class CustomerAuthenionException extends AuthenticationException {
    public CustomerAuthenionException(String msg) {
        super(msg);
    }
}
```



**3.3.4配置Spring Security配置类**

```js
package com.itmk.config.security;

import com.itmk.config.security.detailservice.CustometUserDetailService;
import com.itmk.config.security.filter.CheckTokenFilter;
import com.itmk.config.security.handler.CustomAccessDeineHandler;
import com.itmk.config.security.handler.LoginFailureHandler;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private CustometUserDetailService custometUserDetailService;
    @Autowired
    private CustomAccessDeineHandler customAccessDeineHandler;
    @Autowired
    private LoginFailureHandler loginFailureHandler;
    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //解决跨域
        http.cors().and().headers().frameOptions().disable();
        //关闭跨域请求伪
        http.csrf().disable()
                //基于token，所以不需要session
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                .authorizeRequests()
                //放行登录请求,其他的所有请求都要认证
                .antMatchers("/api/user/login").permitAll()
                .anyRequest().authenticated()
                .and()
                .exceptionHandling()
                .authenticationEntryPoint(loginFailureHandler)
                .accessDeniedHandler(customAccessDeineHandler);
    }



    //注入AuthenticationManager
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(custometUserDetailService);
    }
}
```



#### 第99讲 用户认证讲解2

###### 1、把定义好的处理器讲给spring security进行管理

```js
package com.itmk.config.security;

import com.itmk.config.security.detailservice.CustometUserDetailService;
import com.itmk.config.security.filter.CheckTokenFilter;
import com.itmk.config.security.handler.CustomAccessDeineHandler;
import com.itmk.config.security.handler.LoginFailureHandler;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * spring security配置类
 * @Configuration：表明该类是一个配置类
 * @EnableWebSecurity:启用spring security
 * @EnableGlobalMethodSecurity: 启用spring security注解
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private CustometUserDetailService custometUserDetailService;
    @Autowired
    private CustomAccessDeineHandler customAccessDeineHandler;
    @Autowired
    private LoginFailureHandler loginFailureHandler;
    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //解决跨域
        http.cors().and().headers().frameOptions().disable();
        //关闭跨域请求伪
        http.csrf().disable()
                //基于token，所以不需要session
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                .authorizeRequests()
                //放行登录请求,其他的所有请求都要认证
                .antMatchers("/api/user/login").permitAll()
                .anyRequest().authenticated()
                .and()
                .exceptionHandling()
                .authenticationEntryPoint(loginFailureHandler)
                .accessDeniedHandler(customAccessDeineHandler);
    }



    //注入AuthenticationManager
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(custometUserDetailService);
    }
}
```

###### 2、登录方法改进

```js
/**
     * 用户登录
     */

    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm)
    {
        if(StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())){
            return ResultUtils.error("用户名、密码或用户类型不能为空!");
        }
        String encode = passwordEncoder.encode(parm.getPassword());
        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(parm.getUsername()+":"+parm.getUserType(),parm.getPassword());
        Authentication authenticate = authenticationManager.authenticate(usernamePasswordAuthenticationToken);
        SecurityContextHolder.getContext().setAuthentication(authenticate);
        //用户信息
        if(parm.getUserType().equals("0")){ //业主
            LiveUser liveUser = (LiveUser) authenticate.getPrincipal();
            //生成token返回给前端
            String liveToken = jwtUtils.generateToken(liveUser.getUsername(),parm.getUserType());
            //获取token过期的时间
            Long time = jwtUtils.getExpireTime(liveToken);
            LoginResult result = new LoginResult();
            result.setUserId(liveUser.getUserId());
            result.setToken(liveToken);
            result.setExpireTime(time);
            return ResultUtils.success("登录成功",result);
        }else if(parm.getUserType().equals("1")){ //物主
            User user = (User) authenticate.getPrincipal();
            //生成token返回给前端
            String token = jwtUtils.generateToken(user.getUsername(),parm.getUserType());
            //获取token过期的时间
            Long time = jwtUtils.getExpireTime(token);
            LoginResult result = new LoginResult();
            result.setUserId(user.getUserId());
            result.setToken(token);
            result.setExpireTime(time);
            return ResultUtils.success("登录成功",result);
        }else{
            return ResultUtils.error("您选择的用户类型不存在!");
        }
    }
```

###### 3、生成token方法的改进

```js
/**
     * 生成令牌
     *
     * @param username 用户
     * @return 令牌
     */
    public String generateToken(String username,String userType) {
        Map<String, Object> claims = new HashMap<>(2);
        claims.put(Claims.SUBJECT,username);
        claims.put(Claims.ISSUED_AT, new Date());
        claims.put("userType",userType);
        return generateToken(claims);
    }
```



#### 第100讲 token验证讲解 

###### 1、什么是token

​	Token是服务端生成的一串字符串，以作客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。

###### 2、token认证流程图

![](D:\项目实战\物业管理系统\资料\images\token验证流程图.png)

###### 3、编写token过滤器

```js
package com.itmk.config.security.filter;


import com.itmk.config.jwt.JwtUtils;
import com.itmk.config.security.detailservice.CustometUserDetailService;
import com.itmk.config.security.exception.CustomerAuthenionException;
import com.itmk.config.security.handler.LoginFailureHandler;
import io.jsonwebtoken.Claims;
import lombok.Data;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * token验证过滤器
 */
@Data
@Component("checkTokenFilter")
public class CheckTokenFilter extends OncePerRequestFilter {
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private CustometUserDetailService custometUserDetailService;
    @Autowired
    private LoginFailureHandler loginFailureHandler;

    @Value("${itmk.loginUrl}")
    private String loginUrl;

    @Override
    protected void doFilterInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain) throws ServletException, IOException {
        try {
            //获取请求url
            String url = httpServletRequest.getRequestURI();
            //token验证，登录请求、验证码请求不做token验证
            if(!url.equals(loginUrl)){
                //验证码不需要token验证
                validateToken(httpServletRequest);
            }
        }catch (AuthenticationException e){
            loginFailureHandler.commence(httpServletRequest,httpServletResponse,e);
            return;
        }
        filterChain.doFilter(httpServletRequest,httpServletResponse);
    }

    //token验证
    private void validateToken(HttpServletRequest request){
        //从头部获取token
        String token = request.getHeader("token");
        //如果从头部获取token失败，那么从参数获取
        if(StringUtils.isEmpty(token)){
            token = request.getParameter("token");
        }
        //如果没有获取到token
        if(StringUtils.isEmpty(token)){
            throw new CustomerAuthenionException("token获取失败！");
        }
        //解析token
        String username = jwtUtils.getUsernameFromToken(token);
        if(StringUtils.isEmpty(username)){
            throw new CustomerAuthenionException("token解析失败！");
        }
        Claims claimsFromToken = jwtUtils.getClaimsFromToken(token);

        //获取用户信息
        UserDetails details = custometUserDetailService.loadUserByUsername(username+":"+claimsFromToken.get("userType"));
        if(details == null){
            throw new CustomerAuthenionException("token解析失败！");
        }
        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(details,null,details.getAuthorities());
        authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
        //设置到spring security上下文
        SecurityContextHolder.getContext().setAuthentication(authenticationToken);
    }
}

```

###### 4、配置文件application-test.yml添加如下内容

```js
#配置登录请求url
itmk:
  loginUrl: /api/user/login
```

###### 5、把token验证过滤器交给spring security

在spring security配置类添加如下代码

```js
 http.addFilterBefore(checkTokenFilter, UsernamePasswordAuthenticationFilter.class);
```



#### 第101讲  系统bug优化



#### 第102讲 用户权限信息查询

###### 1、在menu的mapper层新增getMenuByUserIdForLiveUser()方法

该方法主要用于查询业主的菜单列表

```js
	//根据业主的id查询菜单
    List<Menu> getMenuByUserIdForLiveUser(@Param("userId") Long userId);
```

###### 2、MenuMapper.xml编写对应的映射文件

```js
	<select id="getMenuByUserIdForLiveUser" parameterType="long" resultType="com.itmk.web.menu.entity.Menu">
         SELECT m.* FROM  live_role as ur
        left join sys_role as r on ur.role_id =  r.role_id
        left join sys_role_menu as rm  on r.role_id = rm.role_id
        left join sys_menu m  on rm.menu_id = m.menu_id
        where ur.user_id =#{userId}
        order by m.order_num asc
    </select>
```

###### 3、在menu的service层添加getMenuByUserIdForLiveUser()方法

```js
	//根据业主的id查询菜单
    List<Menu> getMenuByUserIdForLiveUser(Long userId);
```

**实现类**

```js
@Override
    public List<Menu> getMenuByUserIdForLiveUser(Long userId) {
        return this.baseMapper.getMenuByUserIdForLiveUser(userId);
    }
```

###### 4、修改自定义CustometUserDetailService为如下所示代码

```js
package com.itmk.config.security.customerdetailservice;

import com.itmk.web.live_user.entity.LiveUser;
import com.itmk.web.live_user.service.LiveUserService;
import com.itmk.web.menu.entity.Menu;
import com.itmk.web.menu.service.MenuService;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 自定义UserDetailsService
 * 目的：告诉spring security如何查询用户信息
 */
@Component("custometUserDetailService") //把该类交给spring进行管理
public class CustometUserDetailService implements UserDetailsService {
    @Autowired
    private UserService userService;
    @Autowired
    private LiveUserService liveUserService;
    @Autowired
    private MenuService menuService;
    @Override
    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {
        //获取用户类型  //0：业主  1： 物主
        //  s = "admin:1"
        int index = s.indexOf(":");
        //账户
        String username = s.substring(0,index);
        //用户类型
        String userType = s.substring(index+1,s.length());
//        UserDetails user = null;
        if(userType.equals("0")){ //业主
          LiveUser liveUser = liveUserService.loadUser(username);
            if(liveUser == null){
                throw new UsernameNotFoundException("用户账户不存在！");
            }
            //查询业主的权限信息
            List<Menu> menuList = menuService.getMenuByUserIdForLiveUser(liveUser.getUserId());
            //获取权限字段
            List<String> collect = menuList.stream().filter(item -> item != null).map(item -> item.getMenuCode()).filter(item -> item != null).collect(Collectors.toList());
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            List<GrantedAuthority> authorityList = AuthorityUtils.createAuthorityList(strings);
            //设置用户的权限
            liveUser.setAuthorities(authorityList);
            return liveUser;
        }else if(userType.equals("1")){ //物主
           User user = userService.loadUser(username);
            if(user == null){
                throw new UsernameNotFoundException("用户账户不存在！");
            }
            //查询用户权限信息
            List<Menu> menuList = menuService.getMenuByUserId(user.getUserId());
            //获取权限字段
            List<String> collect = menuList.stream().filter(item -> item != null).map(item -> item.getMenuCode()).filter(item -> item != null).collect(Collectors.toList());
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            List<GrantedAuthority> authorityList = AuthorityUtils.createAuthorityList(strings);
            //设置用户的权限
            user.setAuthorities(authorityList);
            return user;
        }else{
            throw new UsernameNotFoundException("用户类型不存在");
        }
    }
}

```

###### 5、修改UserController控制器里面的getInfo()方法如下所示

```js
 /**
     * 根据用户id
     * 获取用户信息
     *
     */

    @GetMapping("/getInfo")
    public ResultVo getInfo(User user, HttpServletRequest request){
        //从头部获取token
        String token = request.getHeader("token");
        Claims claims = jwtUtils.getClaimsFromToken(token);
        Object userType = claims.get("userType");
        if(userType.equals("0")){ //0：业主
            LiveUser liveUser = liveUserService.getById(user.getUserId());
            UserInfo userInfo = new UserInfo();
            userInfo.setId(liveUser.getUserId());
            userInfo.setName(liveUser.getUsername());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //查询业主的权限信息
            List<Menu> menuList = menuService.getMenuByUserIdForLiveUser(liveUser.getUserId());
            //获取权限字段
            List<String> collect = menuList.stream().filter(item -> item != null).map(item -> item.getMenuCode()).filter(item -> item != null).collect(Collectors.toList());
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(strings);
            return ResultUtils.success("获取用户信息成功",userInfo);
        }else{ //物主
            //根据用户id查询,区分查的是哪一个
            User user1 = userService.getById(user.getUserId());
            UserInfo userInfo = new UserInfo();
            userInfo.setId(user1.getUserId());
            userInfo.setName(user1.getUsername());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //根据用户id查询权限字段
            //查询用户权限信息
            List<Menu> menuList = menuService.getMenuByUserId(user.getUserId());
            //获取权限字段
            List<String> collect = menuList.stream().filter(item -> item != null).map(item -> item.getMenuCode()).filter(item -> item != null).collect(Collectors.toList());
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(strings);
            return ResultUtils.success("获取用户信息成功",userInfo);
        }
    }
```



#### 第103讲 菜单数据的新增

###### 1、权限注解的添加

```js
 @PreAuthorize("hasAuthority('sys:addDepartment')")
```



#### 第104讲  动态菜单、路由接口开发

**注意事项：所有的菜单数据，除了按钮外，都需要path属性**

###### 1、路由的格式

```js
{
    path: '/system',
    component: Layout,
    name: 'system',
    alwaysShow: true,
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '员工管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '权限管理', icon: 'tree' }
      }
    ]
  },
```

###### 2、修改views/system下的sysMenuList.vue中的path

把新增权限中的path项目，除了按钮外，设为必填项

```js
 v-if="addModel.type != '2'"
```

###### 3、新建RouterVO类

```js
package com.itmk.web.menu.entity;



import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
@JsonInclude(JsonInclude.Include.NON_EMPTY)
public class RouterVO {

    private String path;

    private String component;

    private boolean alwaysShow;

    private String name;

    private Meta meta;

    @Data
    @AllArgsConstructor
    public class Meta {
        private String title;
        private String icon;
        private Object[] roles;
    }
    private List<RouterVO> children =new ArrayList<>();

}
```



###### 4、在MakeMenuTree中添加如下方法

```js
public static List<RouterVO> makeRouter(List<Menu> menuList, Long pid){
        List<RouterVO> list = new ArrayList<>();
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item -> item != null && item.getParentId() == pid)
                .forEach(item -> {
                    RouterVO router = new RouterVO();
                    router.setName(item.getName());
                    router.setPath(item.getPath());
                    if(item.getParentId() == 0L){
                        router.setComponent("Layout");
                        router.setAlwaysShow(true);
                    }else{
                        router.setComponent(item.getUrl());
                        router.setAlwaysShow(false);
                    }
                    //设置meta
                    router.setMeta(router.new Meta(
                            item.getMenuLabel(),
                            item.getIcon(),
                            item.getMenuCode().split(",")
                    ));
                    //设置children,每一项的下级
                    List<RouterVO> children = makeRouter(menuList, item.getMenuId());
                    router.setChildren(children);
                    list.add(router);
                });
        return list;
    }
```

###### 4、在UserController控制器中添加获取路由的方法

```js
@GetMapping("/getMenuList")
    public ResultVo getMenuList(HttpServletRequest request){
        //从头部获取token
        String token = request.getHeader("token");
        Claims claims = jwtUtils.getClaimsFromToken(token);
        String username = jwtUtils.getUsernameFromToken(token);
        Object userType = claims.get("userType");
        if(userType.equals("0")) { //0：业主
            //查询业主的权限信息
            LiveUser liveUser = liveUserService.loadUser(username);
            List<Menu> permissionList = menuService.getMenuByUserIdForLiveUser(liveUser.getUserId());
            //只需要获取目录和菜单
            List<Menu> collect = permissionList.stream().filter(item -> item != null && !item.getType().equals("2")).collect(Collectors.toList());
            List<RouterVO> routerVOList = MakeMenuTree.makeRouter(collect, 0L);
            return ResultUtils.success("获取成功",routerVOList);
        }else{
            User user = userService.loadUser(username);
            List<Menu> permissionList = menuService.getMenuByUserId(user.getUserId());
            //只需要获取目录和菜单
            List<Menu> collect = permissionList.stream().filter(item -> item != null && !item.getType().equals("2")).collect(Collectors.toList());
            List<RouterVO> routerVOList = MakeMenuTree.makeRouter(collect, 0L);
            return ResultUtils.success("获取成功",routerVOList);
        }
    }
```



#### 第105讲 动态菜单、动态路由生成讲解

![](D:\项目实战\物业管理系统\资料\images\权限验证流程图.png)

###### 1、store/modules下的user.js中的getDefaultState()添加roles数组

```js
const getDefaultState = () => {
  return {
    token: getToken(),
    name: '',
    avatar: '',
    roles: [],
  }
}
```

###### 2、mutations添加设置roles的方法

```js
const mutations = {
  RESET_STATE: (state) => {
    Object.assign(state, getDefaultState())
  },
  SET_TOKEN: (state, token) => {
    state.token = token
  },
  SET_NAME: (state, name) => {
    state.name = name
  },
  SET_AVATAR: (state, avatar) => {
    state.avatar = avatar
  },
  SET_ROLES: (state, roles) => {
    state.roles = roles
  }
}
```

###### 3、getInfo()方法改为如下所示

```js
getInfo({ commit, state }) {
    return new Promise((resolve, reject) => {
      //调用api/user.js里面的getInfo
      getInfo(state.token).then(response => {
        const { data } = response

        if (!data) {
          return reject('Verification failed, please Login again.')
        }

        const { name, avatar,roles } = data
        if (!roles || roles.length <= 0) {
          reject('getInfo: 用户的权限信息必须是一个数组!')
        }
        //把权限字段放到sessionStorage里面
        sessionStorage.setItem('codeList',JSON.stringify(roles))
        //把roles存到store里面
        commit('SET_ROLES', roles)
        commit('SET_NAME', name)
        commit('SET_AVATAR', avatar)
        resolve(data)
      }).catch(error => {
        reject(error)
      })
    })
  },
```





###### 4、把vue-element-admin的store/modules下的permission.js里面的内容复制到项目的store/modules里面

```js
import { asyncRoutes, constantRoutes } from '@/router'

/**
 * Use meta.role to determine if the current user has permission
 * @param roles
 * @param route
 */
function hasPermission(roles, route) {
  if (route.meta && route.meta.roles) {
    return roles.some(role => route.meta.roles.includes(role))
  } else {
    return true
  }
}

/**
 * Filter asynchronous routing tables by recursion
 * @param routes asyncRoutes
 * @param roles
 */
export function filterAsyncRoutes(routes, roles) {
  const res = []

  routes.forEach(route => {
    const tmp = { ...route }
    if (hasPermission(roles, tmp)) {
      if (tmp.children) {
        tmp.children = filterAsyncRoutes(tmp.children, roles)
      }
      res.push(tmp)
    }
  })

  return res
}

const state = {
  routes: [],
  addRoutes: []
}

const mutations = {
  SET_ROUTES: (state, routes) => {
    state.addRoutes = routes
    state.routes = constantRoutes.concat(routes)
  }
}

const actions = {
  generateRoutes({ commit }, roles) {
    return new Promise(resolve => {
      let accessedRoutes
      if (roles.includes('admin')) {
        accessedRoutes = asyncRoutes || []
      } else {
        accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)
      }
      commit('SET_ROUTES', accessedRoutes)
      resolve(accessedRoutes)
    })
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}

```

###### 5、在store/index.js引入上面的permission

```JS
import Vue from 'vue'
import Vuex from 'vuex'
import getters from './getters'
import app from './modules/app'
import settings from './modules/settings'
import user from './modules/user'
import tagsView from './modules/tagsView'
import permission from './modules/permission'
Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    app,
    settings,
    user,
    tagsView,
    permission
  },
  getters
})

export default store

```

###### 6、在api/user下新增获取菜单数据的方法

```js
export async function getMenuList(){
  return await http.get("/api/user/getMenuList")
}
```



###### 7、把复制过来的改为如下所示代码

```js
import { constantRoutes } from '@/router'
import { getMenuList } from '@/api/user'
import Layout from '@/layout'

/**
 * Use meta.role to determine if the current user has permission
 * @param roles
 * @param route
 */
function hasPermission(roles, route) {
  if (route.meta && route.meta.roles) {
    return roles.some(role => route.meta.roles.includes(role))
  } else {
    return true
  }
}

/**
 * Filter asynchronous routing tables by recursion
 * @param routes asyncRoutes
 * @param roles
 */
export function filterAsyncRoutes(routes, roles) {
  const res = []
  //循环每一个路由
  routes.forEach(route => {
    // console.log(route)
    const tmp = { ...route }
    // console.log(tmp)
    //判断是否有权限
    if (hasPermission(roles, tmp)) {
      console.log('循环')
      const component = tmp.component;
      if(route.component){
        if(component == 'Layout'){
          tmp.component = Layout;
        }else{
          tmp.component = (resolve) => require([`@/views${component}`],resolve)
        }
      }
      //判断是否有下级
      if (tmp.children) {
        tmp.children = filterAsyncRoutes(tmp.children, roles)
      }
      res.push(tmp)
    }
  })

  return res
}

const state = {
  routes: [],
  addRoutes: []
}

const mutations = {
  SET_ROUTES: (state, routes) => {
    state.addRoutes = routes
    //把过滤出来有权限的路由添加到不需要权限的路由里面去
    state.routes = constantRoutes.concat(routes)
  }
}

const actions = {
  generateRoutes({ commit }, roles) {
    return new Promise((resolve,reject)=>{
      //存的是有权限的路由，是一个数组
      getMenuList().then(res => {
        console.log('返回菜单')
        console.log(res)
        let accessedRoutes;
        if(res.code == 200){
          accessedRoutes = filterAsyncRoutes(res.data, roles)
        }
        commit('SET_ROUTES', accessedRoutes)
        resolve(accessedRoutes)
      }).catch(error=>{
        reject(error)
      })
    })
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}

```

###### 8、在store/getters.js添加如下代码

```js
//动态路由
  permission_routes: state => state.permission.routes,
```

###### 9、修改src/layout/components下的Sidebar的index.vue

```js
...mapGetters([
      'sidebar',
      'permission_routes'
    ]),
```

```js
 <sidebar-item v-for="route in permission_routes" :key="route.path" :item="route" :base-path="route.path" />
```

###### 10、src/permission.js如下所示

```js
import router from './router'
import store from './store'
import { Message } from 'element-ui'
import NProgress from 'nprogress' // progress bar
import 'nprogress/nprogress.css' // progress bar style
import { getToken } from '@/utils/auth' // get token from cookie
import getPageTitle from '@/utils/get-page-title'

NProgress.configure({ showSpinner: false }) // NProgress Configuration

const whiteList = ['/login'] // no redirect whitelist

router.beforeEach(async (to, from, next) => {
  // start progress bar
  NProgress.start()

  // set page title
  //设置页面标题
  document.title = getPageTitle(to.meta.title)

  // determine whether the user has logged in
  ///获取token
  const hasToken = getToken()

  //判断是否存在token
  if (hasToken) {
    //是否是从登录来的请求
    if (to.path === '/login') {
      // if is logged in, redirect to the home page
      //跳转到首页
      next({ path: '/' })
      NProgress.done()
    } else {
      //从store里面获取用户信息
      // const hasGetUserInfo = store.getters.name
      const hasRoles = store.getters.roles && store.getters.roles.length > 0
      if (hasRoles) {
        next()
      } else {
        try {
          // get user info
          //如果用户信息不存在，那么会从服务器获取用户信息
          const { roles } = await store.dispatch('user/getInfo')

          //生成路由数据，是一个数组
          const accessRoutes = await store.dispatch('permission/generateRoutes', roles)
          let obj =  { path: '*', redirect: '/404', hidden: true };
          accessRoutes.push(obj)
          router.addRoutes(accessRoutes)
          console.log(router.options.routes)
          // hack method to ensure that addRoutes is complete
          // set the replace: true, so the navigation will not leave a history record
          next({ ...to, replace: true })
        } catch (error) {
          console.log('进入异常')
          // remove token and go to login page to re-login
          await store.dispatch('user/resetToken')
          Message.error(error || 'Has Error')
          next(`/login?redirect=${to.path}`)
          NProgress.done()
        }
      }
    }
  } else {
    /* has no token*/

    if (whiteList.indexOf(to.path) !== -1) {
      // in the free login whitelist, go directly
      next()
    } else {
      // other pages that do not have permission to access are redirected to the login page.
      next(`/login?redirect=${to.path}`)
      NProgress.done()
    }
  }
})

router.afterEach(() => {
  // finish progress bar
  NProgress.done()
})

```



#### 第106讲 动态菜单测试

![](D:\项目实战\物业管理系统\资料\images\权限验证流程图.png)





#### 第107讲 退出登录讲解

###### 1、新建后端api接口方法

找到后端项目UserController控制器，新增loginOut()方法

```js
@PostMapping("/loginOut")
    public ResultVo loginOut(HttpServletRequest request, HttpServletResponse response){
        //获取用户相关信息
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if(authentication != null){
            //清空用户信息
            new SecurityContextLogoutHandler().logout(request,response,authentication);

        }
        return ResultUtils.success("退出登录成功!");
    }
```

###### 2、在前端项目api/user.js中新增loginOutApi()方法

```js
//退出登录
export async function loginOutApi(){
  return await http.post("/api/user/loginOut",null)
}
```

###### 3、找到src/layout/components下的Navbar.vue页面，添加退出登录的点击事件

```js
async logout() {
      let confirm = await this.$myconfirm("确定退出登录吗?");
      if (confirm) {
        await this.$store.dispatch("user/logout");
        this.$router.push(`/login?redirect=${this.$route.fullPath}`);
      }
    },
```

###### 4、由于3中调用的是store下的user，找到store中的user下的logout方法

导入loginOutApi从api/user中，由于用户id，token等存在缓存中，需要清空；同时清空sessionStorage中的所有数据；当用户退出的时候，再次登录，TagsView选项卡还会存在上次的数据，所以需要清空选项卡的数据；



在src/utils下的auth.js添加清空sessionStorage的方法

```js
//清空sessionStorage
export function clearSession(){
  return sessionStorage.clear();
}
```



```js
logout({ commit,dispatch, state }) {
    return new Promise((resolve, reject) => {
      loginOutApi(state.token).then(() => {
        removeToken() // must remove  token  first
        removeUserId();
        clearSession();
        resetRouter()
        commit('RESET_STATE')
        console.log('推出登录')
        dispatch('tagsView/delAllViews',{}, {root: true})
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```

```js
 dispatch('tagsView/delAllViews',{}, {root: true})主要用于解决TagsView选项卡存在上一次数据的问题
```

###### 5、在后端UserController控制器添加修改密码的方法

```js
 /**
     * 重置密码
     */
    @PostMapping("/resetPassword")
    public ResultVo resetPassword(@RequestBody ChangePassword user,HttpServletRequest request){
        //获取token
        String token = request.getHeader("token");
        Claims claims = jwtUtils.getClaimsFromToken(token);
        //判断用户类型
        Object userType = claims.get("userType");
        if(userType.equals("0")){//0：业主
            LiveUser liveUser = liveUserService.getById(user.getUserId());
            //原来的密码
            String dataOldPassword = liveUser.getPassword();
            boolean encode = passwordEncoder.matches(user.getOldPassword(),dataOldPassword);
            if(!encode){
                return ResultUtils.error("旧密码错误!");
            }
            LiveUser liveUser1 = new LiveUser();
            liveUser1.setUserId(user.getUserId());
            liveUser1.setPassword(passwordEncoder.encode(user.getNewPassword()));
            boolean b = liveUserService.updateById(liveUser1);
            if(b){
                return ResultUtils.success("密码修改成功!");
            }
            return ResultUtils.error("密码修改失败!");
        }else{
            User liveUser = userService.getById(user.getUserId());
            //原来的密码
            String dataOldPassword = liveUser.getPassword();
            boolean encode = passwordEncoder.matches(user.getOldPassword(),dataOldPassword);
            if(!encode){
                return ResultUtils.error("旧密码错误!");
            }
            User liveUser1 = new User();
            liveUser1.setUserId(user.getUserId());
            liveUser1.setPassword(passwordEncoder.encode(user.getNewPassword()));
            boolean b = userService.updateById(liveUser1);
            if(b){
                return ResultUtils.success("密码修改成功!");
            }
            return ResultUtils.error("密码修改失败!");
        }
    }
```

###### 6、前端src/api/user.js添加请求数据的方法

```js
//修改密码
export async function resetPasswordApi(parm){
  return await http.post("/api/user/resetPassword",parm)
}
```

###### 7、src/layout/components/Navbar.vue添加修改密码的方法

```js
//重置密码
    async resetPassword() {
      //信息提示
      let confirm = await this.$myconfirm("确定重置密吗？");
      if (confirm) {
        this.dialog.visible = true;
      }
    },
```

###### 8、修改密码弹框

```js
<!-- 修改密码的弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <template slot="content">
        <el-form
          :model="parms"
          ref="changeForm"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="oldPassword" label="旧密码">
            <el-input v-model="parms.oldPassword"></el-input>
          </el-form-item>
          <el-form-item prop="newPassword" label="新密码">
            <el-input v-model="parms.newPassword"></el-input>
          </el-form-item>
        </el-form>
      </template>
    </sys-dialog>
```

###### 9、修改密码提交

```js
onConfirm() {
      this.$refs.changeForm.validate(async (valid) => {
        if (valid) {
          let res = await resetPasswordApi(this.parms);
          if (res && res.code == 200) {
            this.dialog.visible = false;
            await this.$store.dispatch("user/logout");
            this.$router.push(`/login?redirect=${this.$route.fullPath}`);
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
```



#### 第108讲 按钮权限判断

###### 1、在src下新建permission文件夹，然后新建index.js

```js
//判断按钮权限
export default function hasPermission(parm) {
    let tag = false;
    let codeList = JSON.parse(sessionStorage.getItem('codeList'))
    for (let i = 0; i < codeList.length; i++) {
        if (codeList[i] === parm) {
            tag = true;
            break;
        }
    }
    return tag;
}
```

###### 2、在main.js里面引入，并挂载到vue上

```js
//按钮权限判断
import hasPermission from '@/permission/index'
Vue.prototype.hasPerm = hasPermission;
```

###### 3、使用方式

在按钮上添加 v-if="hasPerm('sys:role:add')"  的判断

```js
		 <el-button
          v-if="hasPerm('sys:role:add')"
          @click="addRole"
          type="primary"
          icon="el-icon-plus"
          >新增</el-button>
```



#### 第109讲 我的缴费模块开发

第110